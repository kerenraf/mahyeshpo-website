<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ניהול מנויי התראות WhatsApp - מה יש פה?</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700&display=swap');
        
        :root {
            --primary-color: #F69898;
            --primary-light: #ffb6c1;
            --primary-dark: #e58080;
            --whatsapp-color: #25D366;
            --dark-bg: #333333;
            --darker-bg: #222222;
            --text-light: #ffffff;
            --text-muted: #cccccc;
            --border-radius: 12px;
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Assistant', Arial, sans-serif;
        }

        body {
            background-color: #000;
            color: white;
            direction: rtl;
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            padding: 30px 0;
            background: linear-gradient(145deg, var(--dark-bg) 0%, var(--darker-bg) 100%);
            border-radius: var(--border-radius);
            margin-bottom: 30px;
        }

        .header h1 {
            color: var(--primary-color);
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            color: var(--text-muted);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            padding: 25px;
            border-radius: var(--border-radius);
            text-align: center;
            color: white;
            box-shadow: 0 4px 15px rgba(246, 152, 152, 0.3);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 5px;
            display: block;
        }

        .stat-label {
            font-size: 1rem;
            opacity: 0.9;
        }

        .admin-section, .section {
            background: linear-gradient(145deg, var(--dark-bg), var(--darker-bg));
            padding: 30px;
            border-radius: var(--border-radius);
            margin-bottom: 30px;
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
            border: 2px solid rgba(246, 152, 152, 0.2);
        }

        .section-header {
            margin-bottom: 20px;
        }

        .section-title, .section h2, .section h3 {
            color: var(--primary-color);
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .btn {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: var(--transition);
            box-shadow: 0 4px 12px rgba(246,152,152,0.3);
        }

        .btn:hover {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary-color));
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(246,152,152,0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--whatsapp-color), #128C7E);
            box-shadow: 0 4px 12px rgba(37, 211, 102, 0.3);
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #128C7E, #0f6b5c);
            box-shadow: 0 6px 15px rgba(37, 211, 102, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545, #c82333);
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #c82333, #a71e2a);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
        }

        .btn-outline:hover {
            background: var(--primary-color);
            color: white;
        }

        .btn-small {
            padding: 6px 10px;
            font-size: 0.8rem;
            min-width: auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label, .form-label {
            display: block;
            margin-bottom: 8px;
            color: var(--primary-color);
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea,
        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid rgba(246, 152, 152, 0.3);
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus,
        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(246, 152, 152, 0.1);
        }

        .search-filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(246, 152, 152, 0.05);
            border-radius: 10px;
            border: 1px solid rgba(246, 152, 152, 0.2);
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-label {
            color: var(--primary-color);
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .filter-control {
            padding: 10px;
            border: 1px solid rgba(246, 152, 152, 0.3);
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 0.9rem;
        }

        .filter-control:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        .whatsapp-message {
            background: #dcf8c6;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-family: system-ui;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            color: #333;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error {
            background: #ff4757;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }

        .success {
            background: #2ed573;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }

        .preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .preview-content {
            background: var(--darker-bg);
            padding: 30px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            border: 2px solid var(--primary-color);
        }

        .close-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            float: right;
            margin-top: 15px;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
        }

        .alert-success {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }

        .alert-error {
            background: linear-gradient(135deg, #dc3545, #e74c3c);
            color: white;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .search-filters {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- כותרת -->
        <div class="header">
            <h1><i class="fas fa-users-cog"></i> ניהול מנויי התראות WhatsApp</h1>
            <p>מערכת ניהול מתקדמת למנויי התראות משרות - מה יש פה?</p>
        </div>

        <!-- סטטיסטיקות -->
        <div class="stats-grid">
            <div class="stat-card">
                <span class="stat-number" id="totalSubscribers">0</span>
                <div class="stat-label">מנויים פעילים</div>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="totalAlerts">0</span>
                <div class="stat-label">התראות נשלחו</div>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="newThisWeek">0</span>
                <div class="stat-label">מנויים השבוע</div>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="categoriesCount">0</span>
                <div class="stat-label">קטגוריות פעילות</div>
            </div>
        </div>

        <!-- כלי ניהול -->
        <div class="admin-section">
            <div class="section-header">
                <h2 class="section-title"><i class="fas fa-tools"></i> כלי ניהול</h2>
            </div>
            
            <div class="action-buttons">
                <button class="btn" onclick="exportSubscribers()">
                    <i class="fas fa-download"></i> ייצא מנויים
                </button>
                <label for="import-file" class="btn">
                    <i class="fas fa-upload"></i> ייבא מנויים
                </label>
                <input type="file" id="import-file" style="display: none;" accept=".json" onchange="importSubscribers(event)">
                <button class="btn btn-secondary" onclick="clearAllData()">
                    <i class="fas fa-trash"></i> נקה הכל
                </button>
                <button class="btn" onclick="generateReport()">
                    <i class="fas fa-chart-bar"></i> דוח מפורט
                </button>
                <button class="btn btn-secondary" onclick="refreshSubscribersList()">
                    <i class="fas fa-sync"></i> רענן רשימה
                </button>
                <button class="btn" onclick="addTestSubscribers()">
                    <i class="fas fa-users-plus"></i> הוסף מנויים לבדיקה
                </button>
            </div>
        </div>

        <!-- כלי בדיקה והתאמות -->
        <div class="admin-section">
            <div class="section-header">
                <h2 class="section-title"><i class="fas fa-microscope"></i> כלי בדיקה והתאמות</h2>
            </div>
            
            <div class="action-buttons">
                <button class="btn" onclick="analyzeJobsStructure()">
                    <i class="fas fa-chart-pie"></i> נתח מבנה משרות
                </button>
                <button class="btn" onclick="testJobSearchDemo()">
                    <i class="fas fa-search"></i> בדוק חיפוש משרות
                </button>
                <button class="btn" onclick="testMatchingDemo()">
                    <i class="fas fa-users"></i> בדוק התאמת מנויים
                </button>
                <button class="btn" onclick="testCategoryMatching()">
                    <i class="fas fa-tags"></i> בדוק התאמת קטגוריות
                </button>
                <button class="btn" onclick="testGenderMatching()">
                    <i class="fas fa-venus-mars"></i> בדוק זכר/נקבה
                </button>
                <button class="btn" onclick="showMatchingRules()">
                    <i class="fas fa-book"></i> חוקי התאמה
                </button>
            </div>
            
            <!-- בדיקה בזמן אמת -->
            <div style="margin-top: 20px; padding: 20px; background: rgba(246, 152, 152, 0.05); border-radius: 10px; border: 1px solid rgba(246, 152, 152, 0.2);">
                <h4 style="color: var(--primary-color); margin-bottom: 15px;">⚡ בדיקה בזמן אמת</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <input type="text" id="testJobCategory" placeholder="קטגוריית משרה" style="padding: 10px; border: 1px solid rgba(246, 152, 152, 0.3); border-radius: 5px; background: rgba(255, 255, 255, 0.1); color: white;">
                    <input type="text" id="testSubscriberCategories" placeholder="קטגוריות מנוי (מופרדות בפסיק)" style="padding: 10px; border: 1px solid rgba(246, 152, 152, 0.3); border-radius: 5px; background: rgba(255, 255, 255, 0.1); color: white;">
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-small" onclick="testRealTimeMatching()">
                            <i class="fas fa-play"></i> בדוק
                        </button>
                        <button class="btn btn-small btn-outline" onclick="clearTestInputs()">
                            <i class="fas fa-eraser"></i> נקה
                        </button>
                    </div>
                </div>
                <div id="realTimeResults" style="display: none; margin-top: 15px;"></div>
            </div>
        </div>

        <!-- ניתוח התאמות חכם -->
        <div class="admin-section">
            <div class="section-header">
                <h2 class="section-title"><i class="fas fa-brain"></i> ניתוח התאמות חכם</h2>
            </div>
            
            <div class="form-group">
                <label for="detailedJobSearch">הכנס מספר משרה לניתוח מפורט:</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="detailedJobSearch" placeholder="מספר משרה (למשל: A-25821)" style="flex: 1;">
                    <button class="btn" onclick="analyzeJobMatching()">
                        <i class="fas fa-brain"></i> נתח התאמות
                    </button>
                </div>
            </div>

            <div id="detailedAnalysisResults" style="margin-top: 20px; display: none;"></div>
        </div>

        <!-- סריקת משרות ומציאת התאמות -->
        <div class="admin-section">
            <div class="section-header">
                <h2 class="section-title"><i class="fas fa-radar"></i> סריקת משרות והתאמה למנויים</h2>
            </div>
            
            <div style="margin-bottom: 20px; padding: 15px; background: rgba(40, 167, 69, 0.1); border-radius: 8px; border: 1px solid rgba(40, 167, 69, 0.3);">
                <h4 style="color: #28a745; margin-bottom: 10px;">
                    <i class="fas fa-info-circle"></i> איך זה עובד:
                </h4>
                <p style="margin: 0; color: #cccccc;">
                    המערכת סורקת את כל המשרות בקובץ jobs.json ומתאימה אותן למנויים לפי הקטגוריות והאזורים שלהם.
                    כל מנוי יקבל התראה רק על משרות שמתאימות בדיוק להעדפות שלו.
                </p>
            </div>

            <div class="action-buttons">
                <button class="btn" onclick="scanAllJobsForAllSubscribers()" style="background: linear-gradient(135deg, #28a745, #20c997);">
                    <i class="fas fa-search"></i> סרוק כל המשרות
                </button>
                <button class="btn" onclick="scanNewJobsOnly()" style="background: linear-gradient(135deg, #17a2b8, #138496);">
                    <i class="fas fa-clock"></i> רק משרות חדשות
                </button>
                <button class="btn" onclick="showJobMatchingReport()">
                    <i class="fas fa-chart-line"></i> דוח התאמות
                </button>
            </div>

            <div id="jobScanResults" style="margin-top: 20px; display: none;"></div>
        </div>

        <!-- סקציית הוספת מנוי חדש -->
        <div class="admin-section">
            <div class="section-header">
                <h2 class="section-title"><i class="fas fa-user-plus"></i> הוספת מנוי חדש</h2>
            </div>
            
            <div class="form-group">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div>
                        <label for="newSubscriberName" style="display: block; margin-bottom: 8px; font-weight: bold; color: var(--primary-color);">שם מלא *</label>
                        <input type="text" id="newSubscriberName" style="width: 100%; padding: 12px; border: 2px solid rgba(246, 152, 152, 0.3); border-radius: 8px; background: rgba(255, 255, 255, 0.1); color: white;" placeholder="הכנס שם מלא" required>
                    </div>
                    <div>
                        <label for="newSubscriberPhone" style="display: block; margin-bottom: 8px; font-weight: bold; color: var(--primary-color);">מספר טלפון *</label>
                        <input type="tel" id="newSubscriberPhone" style="width: 100%; padding: 12px; border: 2px solid rgba(246, 152, 152, 0.3); border-radius: 8px; background: rgba(255, 255, 255, 0.1); color: white;" placeholder="050-1234567" required>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label style="display: block; margin-bottom: 8px; font-weight: bold; color: var(--primary-color);">תחומי עניין *</label>
                <div style="max-height: 200px; overflow-y: auto; border: 2px solid rgba(246, 152, 152, 0.3); border-radius: 8px; padding: 10px; background: rgba(255, 255, 255, 0.05);">
                    <div id="newSubscriberCategories" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));">
                        <!-- קטגוריות יתווספו כאן דינמית -->
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label style="display: block; margin-bottom: 8px; font-weight: bold; color: var(--primary-color);">אזורי עניין *</label>
                <div style="max-height: 150px; overflow-y: auto; border: 2px solid rgba(246, 152, 152, 0.3); border-radius: 8px; padding: 10px; background: rgba(255, 255, 255, 0.05);">
                    <div id="newSubscriberAreas" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));">
                        <!-- אזורים יתווספו כאן דינמית -->
                    </div>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn" onclick="addNewSubscriber()">
                    <i class="fas fa-user-plus"></i> הוסף מנוי חדש
                </button>
                <button class="btn btn-outline" onclick="resetNewSubscriberForm()">
                    <i class="fas fa-undo"></i> נקה טופס
                </button>
            </div>
        </div>

        <!-- שליחה ממוקדת לפי מספר משרה -->
        <div class="admin-section">
            <div class="section-header">
                <h2 class="section-title"><i class="fas fa-search-plus"></i> שליחה ממוקדת לפי מספר משרה</h2>
            </div>
            
            <div class="form-group">
                <label for="jobSearchInput">מספר משרה (למשל: A-25821)</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="jobSearchInput" placeholder="הכנס מספר משרה לחיפוש..." style="flex: 1;">
                    <button class="btn" onclick="searchJobAndSend()">
                        <i class="fas fa-search"></i> חפש ושלח
                    </button>
                </div>
            </div>

            <div class="form-group">
                <label>או הכנס פרטי משרה ידנית:</label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <input type="text" id="manualJobTitle" placeholder="כותרת המשרה">
                    <select id="manualArea">
                        <option value="">בחר אזור</option>
                        <!-- אזורים יתווספו דינמית -->
                    </select>
                    <select id="manualCategory">
                        <option value="">בחר קטגוריה</option>
                        <!-- קטגוריות יתווספו דינמית -->
                    </select>
                </div>
                <button class="btn btn-secondary" onclick="sendManualJob()">
                    <i class="fas fa-paper-plane"></i> שלח משרה ידנית
                </button>
            </div>

            <div id="jobSearchResults" style="margin-top: 20px;"></div>
        </div>

        <!-- שליחה ישירה למנוי ספציפי -->
        <div class="admin-section">
            <div class="section-header">
                <h2 class="section-title"><i class="fas fa-user-plus"></i> שליחה ישירה למנוי ספציפי</h2>
            </div>
            
            <div class="form-group">
                <label for="subscriberSelect">בחר מנוי:</label>
                <select id="subscriberSelect">
                    <option value="">בחר מנוי מהרשימה...</option>
                </select>
            </div>

            <div class="form-group">
                <label for="directMessage">הודעה מותאמת אישית:</label>
                <textarea id="directMessage" rows="4" placeholder="כתוב הודעה מותאמת אישית למנוי..."></textarea>
            </div>

            <div class="action-buttons">
                <button class="btn" onclick="previewDirectMessage()">
                    <i class="fas fa-eye"></i> תצוגה מקדימה
                </button>
                <button class="btn btn-secondary" onclick="sendDirectMessage()">
                    <i class="fas fa-paper-plane"></i> שלח הודעה
                </button>
            </div>
        </div>

        <!-- חיפוש וסינון -->
        <div class="section">
            <h2><i class="fas fa-search"></i> רשימת מנויים</h2>
            
            <div class="search-filters">
                <div class="filter-group">
                    <label class="filter-label">חיפוש:</label>
                    <input type="text" class="filter-control" id="searchInput" placeholder="חפש לפי שם או טלפון...">
                </div>
                <div class="filter-group">
                    <label class="filter-label">קטגוריה:</label>
                    <select class="filter-control" id="filterCategory">
                        <option value="">כל הקטגוריות</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">אזור:</label>
                    <select class="filter-control" id="filterArea">
                        <option value="">כל האזורים</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">תאריך הרשמה:</label>
                    <select class="filter-control" id="filterDate">
                        <option value="">כל התאריכים</option>
                        <option value="today">היום</option>
                        <option value="week">השבוע</option>
                        <option value="month">החודש</option>
                    </select>
                </div>
            </div>

            <div id="subscribersCount" style="margin-bottom: 20px; padding: 10px; background: rgba(246, 152, 152, 0.1); border-radius: 5px;">
                <i class="fas fa-users"></i>
                <span>סה"כ מנויים: <strong id="totalCount">0</strong></span>
                <span>מוצגים: <strong id="visibleCount">0</strong></span>
            </div>

            <div id="subscribersList"></div>
        </div>

        <!-- סטטיסטיקות -->
        <div class="section">
            <h2><i class="fas fa-chart-bar"></i> סטטיסטיקות</h2>
            <div id="statsContainer" class="stats-grid">
                <!-- סטטיסטיקות יוצגו כאן -->
            </div>
        </div>
    </div>

    <script>
        // מחלקה לניהול משרות עם נתונים מובנים
        class JobsManager {
            constructor() {
                this.jobs = [];
                this.lastUpdate = null;
                this.loading = false;
                
                // טעינה ראשונית
                this.loadJobs();
            }

            async loadJobs() {
                if (this.loading) return;
                
                this.loading = true;
                try {
                    console.log('🔄 טוען משרות...');
                    
                    // ניסיון טעינה מקובץ המשרות
                    try {
                        const response = await fetch('data/jobs.json?t=' + Date.now());
                        
                        if (response.ok) {
                            const data = await response.json();
                            
                            if (Array.isArray(data) && data.length > 0) {
                                this.jobs = data;
                                this.lastUpdate = new Date();
                                console.log(`✅ נטענו ${this.jobs.length} משרות מקובץ המשרות בהצלחה`);
                                this.updateDynamicOptions();
                                return;
                            }
                        }
                    } catch (error) {
                        console.log('⚠️ לא ניתן לטעון מקובץ המשרות, עובר לנתונים מובנים...');
                    }
                    
                    // טעינת נתונים מובנים
                    this.loadBuiltInJobs();
                    
                } finally {
                    this.loading = false;
                }
            }

            loadBuiltInJobs() {
                console.log('📋 טוען נתונים מובנים...');
                
                this.jobs = [
                    {
                        jobNumber: "A-25821",
                        title: "נהג/ת משאית מנוף מעל 15 טון",
                        category: "לוגיסטיקה, מחסנים, שילוח ורכש",
                        region: "דרום",
                        city: "אשדוד",
                        status: "פעיל",
                        id: "A-25821"
                    },
                    {
                        jobNumber: "B-12345",
                        title: "מפתח/ת Full Stack",
                        category: "פיתוח ותוכנה",
                        region: "מרכז",
                        city: "תל אביב",
                        status: "פעיל",
                        id: "B-12345"
                    },
                    {
                        jobNumber: "C-67890",
                        title: "מורה/מחנך לחינוך מיוחד",
                        category: "חינוך והוראה",
                        region: "צפון",
                        city: "חיפה",
                        status: "פעיל",
                        id: "C-67890"
                    },
                    {
                        jobNumber: "D-11111",
                        title: "מוכר/ת בחנות בגדים",
                        category: "מכירות ושיווק",
                        region: "מרכז",
                        city: "רמת גן",
                        status: "פעיל",
                        id: "D-11111"
                    },
                    {
                        jobNumber: "E-22222",
                        title: "מטפל/ת סיעודי",
                        category: "בריאות ורפואה",
                        region: "ירושלים",
                        city: "ירושלים",
                        status: "פעיל",
                        id: "E-22222"
                    },
                    {
                        jobNumber: "F-33333",
                        title: "טבח/ית במסעדה יוקרתית",
                        category: "מזון ומשקאות",
                        region: "מרכז",
                        city: "תל אביב",
                        status: "פעיל",
                        id: "F-33333"
                    },
                    {
                        jobNumber: "G-44444",
                        title: "שומר/ת אבטחה במרכז קניות",
                        category: "שמירה ואבטחה",
                        region: "דרום",
                        city: "באר שבע",
                        status: "פעיל",
                        id: "G-44444"
                    },
                    {
                        jobNumber: "H-55555",
                        title: "מנהל/ת פרויקטים",
                        category: "ניהול ותיאום",
                        region: "מרכז",
                        city: "פתח תקווה",
                        status: "פעיל",
                        id: "H-55555"
                    },
                    {
                        jobNumber: "I-66666",
                        title: "נציג/ת שירות לקוחות",
                        category: "שירות לקוחות",
                        region: "כל הארץ",
                        city: "עבודה מהבית",
                        status: "פעיל",
                        id: "I-66666"
                    },
                    {
                        jobNumber: "J-77777",
                        title: "עובד/ת ייצור במפעל",
                        category: "ייצור ותעשייה",
                        region: "צפון",
                        city: "נהריה",
                        status: "פעיל",
                        id: "J-77777"
                    }
                ];
                
                this.lastUpdate = new Date();
                console.log(`✅ נטענו ${this.jobs.length} משרות מובנות`);
                
                // עדכון קטגוריות ואזורים
                this.updateDynamicOptions();
            }

            updateDynamicOptions() {
                if (!this.jobs || this.jobs.length === 0) return;
                
                // חילוץ קטגוריות ואזורים מהמשרות
                const categories = new Set();
                const areas = new Set();
                
                this.jobs.forEach(job => {
                    if (job.category) categories.add(job.category);
                    if (job.region) areas.add(job.region);
                    if (job.area) areas.add(job.area);
                });
                
                this.categories = Array.from(categories);
                this.areas = Array.from(areas);
                
                console.log(`📊 נמצאו ${this.categories.length} קטגוריות ו-${this.areas.length} אזורים`);
            }

            getCategories() {
                return this.categories && this.categories.length > 0 ? this.categories : [
                    "לוגיסטיקה, מחסנים, שילוח ורכש",
                    "פיתוח ותוכנה",
                    "מכירות ושיווק",
                    "חינוך והוראה",
                    "מזון ומשקאות",
                    "בריאות ורפואה",
                    "שמירה ואבטחה",
                    "ניהול ותיאום",
                    "שירות לקוחות",
                    "ייצור ותעשייה",
                    "אחר"
                ];
            }

            getAreas() {
                return this.areas && this.areas.length > 0 ? this.areas : [
                    "מרכז",
                    "צפון",
                    "דרום",
                    "ירושלים",
                    "כל הארץ",
                    "אחר"
                ];
            }

            findJobById(jobId) {
                if (!jobId || !this.jobs) return null;

                const cleanJobId = jobId.toString().trim();
                
                const job = this.jobs.find(job => {
                    if (!job) return false;
                    
                    if (job.jobNumber && job.jobNumber.toString().trim() === cleanJobId) {
                        return true;
                    }
                    
                    if (job.id && job.id.toString().trim() === cleanJobId) {
                        return true;
                    }
                    
                    if (cleanJobId.length > 3) {
                        if (job.title && job.title.includes(cleanJobId)) return true;
                    }
                    
                    return false;
                });

                if (job) {
                    console.log(`✅ נמצאה משרה: ${job.jobNumber} - ${job.title}`);
                } else {
                    console.log(`❌ לא נמצאה משרה עם המספר: ${cleanJobId}`);
                }

                return job;
            }

            normalizeJob(job) {
                if (!job) return null;

                return {
                    id: job.jobNumber || job.id || 'unknown',
                    jobNumber: job.jobNumber || job.id || 'unknown', 
                    title: job.title || 'ללא כותרת',
                    area: job.region || job.area || 'לא צוין',
                    region: job.region || job.area || 'לא צוין',
                    city: job.city || 'לא צוין',
                    category: job.category || 'אחר',
                    description: job.description || '',
                    requirements: job.requirements || '',
                    salary: job.salary || 'לפי ניסיון',
                    status: job.status || 'unknown',
                    featured: job.featured || false,
                    createdAt: job.createdAt || new Date().toISOString()
                };
            }

            findMatchingSubscribers(job, subscribers) {
                if (!job || !subscribers) return [];

                return subscribers.filter(subscriber => {
                    const categoryMatch = this.matchCategory(job.category, subscriber.categories);
                    const areaMatch = this.matchArea(job.region || job.area, subscriber.areas);
                    
                    return categoryMatch && areaMatch;
                });
            }

            matchCategory(jobCategory, subscriberCategories) {
                if (!jobCategory || !subscriberCategories) return false;
                
                const jobCat = jobCategory.toLowerCase();
                
                return subscriberCategories.some(subCat => {
                    const subCatLower = subCat.toLowerCase();
                    
                    // התאמה מדויקת
                    if (jobCat === subCatLower) return true;
                    
                    // התאמה חלקית
                    if (jobCat.includes(subCatLower) || subCatLower.includes(jobCat)) return true;
                    
                    // התאמה לפי מילות מפתח
                    if (this.matchByKeywords(jobCat, subCatLower)) return true;
                    
                    // טיפול במקרים של זכר/נקבה עם סלאש (/)
                    if (jobCat.includes('/')) {
                        const parts = jobCat.split('/');
                        return parts.some(part => {
                            const cleanPart = part.trim();
                            return subCatLower.includes(cleanPart) || 
                                   cleanPart.includes(subCatLower) ||
                                   this.matchByKeywords(cleanPart, subCatLower);
                        });
                    }
                    
                    // אם המנוי מחפש משהו עם סלאש - נבדוק גם ללא הסלאש
                    if (subCatLower.includes('/')) {
                        const parts = subCatLower.split('/');
                        return parts.some(part => {
                            const cleanPart = part.trim();
                            return jobCat.includes(cleanPart) || 
                                   cleanPart.includes(jobCat) ||
                                   this.matchByKeywords(jobCat, cleanPart);
                        });
                    }
                    
                    return false;
                });
            }

            matchByKeywords(jobCategory, subscriberCategory) {
                const keywordMap = {
                    'לוגיסטיקה': ['נהג', 'נהיגה', 'משאית', 'מנוף', 'הובלה', 'מחסן', 'שילוח', 'דרייבר'],
                    'נהיגה': ['לוגיסטיקה', 'משאית', 'מנוף', 'הובלה', 'תחבורה', 'דרייבר', 'נהג'],
                    'פיתוח': ['מפתח', 'תכנות', 'תוכנה', 'programmer', 'developer', 'קוד', 'אפליקציה'],
                    'מכירות': ['שיווק', 'marketing', 'sales', 'מוכר', 'סייל', 'ייעוץ'],
                    'חינוך': ['מורה', 'הוראה', 'מחנך', 'גננת', 'חינוכית', 'מחנכת'],
                    'בריאות': ['רפואה', 'רפואי', 'רופא', 'אחות', 'פיזיותרפיה', 'טיפול'],
                    'מזון': ['מסעדה', 'בישול', 'טבח', 'שף', 'מטבח', 'קייטרינג'],
                    'אבטחה': ['שמירה', 'ביטחון', 'שומר', 'מאבטח'],
                    'שירות': ['לקוחות', 'קריאות', 'תמיכה', 'מוקד'],
                    'ניהול': ['מנהל', 'מנהלת', 'ריכוז', 'ביצוע', 'תיאום']
                };

                // חיפוש דו-כיווני
                for (const [key, keywords] of Object.entries(keywordMap)) {
                    // אם הקטגוריה של המשרה מכילה מילה מפתח
                    if (jobCategory.includes(key)) {
                        if (keywords.some(k => subscriberCategory.includes(k))) {
                            return true;
                        }
                    }
                    
                    // אם הקטגוריה של המנוי מכילה מילה מפתח
                    if (subscriberCategory.includes(key)) {
                        if (keywords.some(k => jobCategory.includes(k))) {
                            return true;
                        }
                    }
                    
                    // חיפוש במילות המפתח עצמן
                    keywords.forEach(keyword => {
                        if (jobCategory.includes(keyword) && subscriberCategory.includes(key)) {
                            return true;
                        }
                        if (subscriberCategory.includes(keyword) && jobCategory.includes(key)) {
                            return true;
                        }
                    });
                }

                return false;
            }

            matchArea(jobArea, subscriberAreas) {
                if (!jobArea || !subscriberAreas) return false;
                
                const jobAreaLower = jobArea.toLowerCase();
                
                return subscriberAreas.some(subArea => {
                    const subAreaLower = subArea.toLowerCase();
                    
                    // התאמה מדויקת או חלקית
                    if (jobAreaLower === subAreaLower || 
                        jobAreaLower.includes(subAreaLower) || 
                        subAreaLower.includes(jobAreaLower)) {
                        return true;
                    }
                    
                    // התאמה למיוחדים
                    if (subAreaLower === 'כל הארץ' || 
                        subAreaLower === 'אחר' || 
                        jobAreaLower === 'כל הארץ') {
                        return true;
                    }
                    
                    // התאמות לאזורים גיאוגרפיים רחבים
                    if (subAreaLower === 'מרכז' && 
                        (jobAreaLower.includes('תל אביב') || 
                         jobAreaLower.includes('רמת גן') || 
                         jobAreaLower.includes('גוש דן'))) {
                        return true;
                    }
                    
                    return false;
                });
            }

            getAllJobs() {
                return this.jobs || [];
            }

            async reloadJobs() {
                console.log('🔄 מרענן משרות...');
                this.jobs = [];
                await this.loadJobs();
                return this.jobs.length;
            }
        }

        // יצירת מנהל המשרות
        const correctJobsManager = new JobsManager();

        // רענון נתוני משרות
        async function refreshJobsData() {
            try {
                const count = await correctJobsManager.reloadJobs();
                
                // עדכון טפסים
                setTimeout(() => {
                    createNewSubscriberForm();
                    adminPanel?.loadSubscriberSelect?.();
                }, 500);
                
                adminPanel?.showAlert(`✅ רענון הושלם - נטענו ${count} משרות`, 'success');
            } catch (error) {
                adminPanel?.showAlert('❌ שגיאה ברענון נתוני משרות', 'error');
                console.error('שגיאה ברענון:', error);
            }
        }

        // מערכת ניהול מנויים מעודכנת
        class AdminPanel {
            constructor() {
                this.whatsappAlerts = null;
                this.currentFilter = {
                    category: '',
                    area: '',
                    date: '',
                    search: ''
                };
                this.init();
            }

            async init() {
                // יצירת מערכת WhatsApp Alerts עם נתונים בסיסיים
                this.whatsappAlerts = {
                    subscribers: JSON.parse(localStorage.getItem('whatsapp_alerts_subscribers') || '[]'),
                    options: {
                        adminPhone: "972555504633", // מספר הטלפון המעודכן שלך
                        categories: correctJobsManager.getCategories(),
                        areas: correctJobsManager.getAreas()
                    },
                    getSubscribers: () => this.whatsappAlerts.subscribers,
                    addSubscriber: (subscriber) => {
                        this.whatsappAlerts.subscribers.push(subscriber);
                        this.saveSubscribers();
                    },
                    removeSubscriber: (phone) => {
                        this.whatsappAlerts.subscribers = this.whatsappAlerts.subscribers.filter(s => s.phone !== phone);
                        this.saveSubscribers();
                    },
                    sendDirectAlert: (subscriberData) => {
                        const phoneNumber = this.whatsappAlerts.options.adminPhone;
                        
                        const message = encodeURIComponent(
                            `מנוי חדש נרשם להתראות משרות!\n\n` +
                            `שם: ${subscriberData.name}\n` +
                            `טלפון: ${subscriberData.phone}\n` +
                            `תחומי עניין: ${subscriberData.categories.join(', ')}\n` +
                            `אזורים: ${subscriberData.areas.join(', ')}\n` +
                            `מקור: ${subscriberData.source || 'אתר'}\n` +
                            `תאריך: ${new Date().toLocaleString('he-IL')}`
                        );
                        
                        const whatsappUrl = `https://wa.me/${phoneNumber}?text=${message}`;
                        window.open(whatsappUrl, '_blank');
                        
                        return true;
                    }
                };
                
                this.loadFilters();
                this.renderSubscribers();
                this.updateStats();
                this.attachEvents();
                
                // טעינת רשימת מנויים לשליחה ישירה
                this.loadSubscriberSelect();
                
                // טעינת תבניות בחירה של משרות ידניות
                this.loadManualJobSelectors();
                
                console.log('🔧 פאנל ניהול הופעל');
            }

            saveSubscribers() {
                if (this.whatsappAlerts && this.whatsappAlerts.subscribers) {
                    localStorage.setItem('whatsapp_alerts_subscribers', JSON.stringify(this.whatsappAlerts.subscribers));
                }
            }

            loadFilters() {
                const categoryFilter = document.getElementById('filterCategory');
                const areaFilter = document.getElementById('filterArea');
                
                // טעינת קטגוריות
                categoryFilter.innerHTML = '<option value="">כל הקטגוריות</option>';
                correctJobsManager.getCategories().forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    categoryFilter.appendChild(option);
                });

                // טעינת אזורים
                areaFilter.innerHTML = '<option value="">כל האזורים</option>';
                correctJobsManager.getAreas().forEach(area => {
                    const option = document.createElement('option');
                    option.value = area;
                    option.textContent = area;
                    areaFilter.appendChild(option);
                });
            }

            loadSubscriberSelect() {
                const select = document.getElementById('subscriberSelect');
                if (!select) return;
                
                const subscribers = this.whatsappAlerts ? this.whatsappAlerts.getSubscribers() : [];
                
                select.innerHTML = '<option value="">בחר מנוי מהרשימה...</option>';
                
                if (subscribers.length === 0) {
                    select.innerHTML += '<option value="" disabled>אין מנויים עדיין</option>';
                    return;
                }
                
                subscribers.forEach((subscriber, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = `${subscriber.phone} - ${subscriber.name || 'ללא שם'}`;
                    select.appendChild(option);
                });
            }

            loadManualJobSelectors() {
                const categorySelect = document.getElementById('manualCategory');
                const areaSelect = document.getElementById('manualArea');
                
                if (categorySelect) {
                    categorySelect.innerHTML = '<option value="">בחר קטגוריה</option>';
                    correctJobsManager.getCategories().forEach(category => {
                        const option = document.createElement('option');
                        option.value = category;
                        option.textContent = category;
                        categorySelect.appendChild(option);
                    });
                }
                
                if (areaSelect) {
                    areaSelect.innerHTML = '<option value="">בחר אזור</option>';
                    correctJobsManager.getAreas().forEach(area => {
                        const option = document.createElement('option');
                        option.value = area;
                        option.textContent = area;
                        areaSelect.appendChild(option);
                    });
                }
            }

            attachEvents() {
                // חיפוש וסינון
                const searchInput = document.getElementById('searchInput');
                const filterCategory = document.getElementById('filterCategory');
                const filterArea = document.getElementById('filterArea');
                const filterDate = document.getElementById('filterDate');

                if (searchInput) searchInput.addEventListener('input', () => this.filterSubscribers());
                if (filterCategory) filterCategory.addEventListener('change', () => this.filterSubscribers());
                if (filterArea) filterArea.addEventListener('change', () => this.filterSubscribers());
                if (filterDate) filterDate.addEventListener('change', () => this.filterSubscribers());

                // מקלדת
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        this.closeAllModals();
                    }
                });
            }

            renderSubscribers() {
                const subscribers = this.getFilteredSubscribers();
                const container = document.getElementById('subscribersList');
                
                if (!subscribers || subscribers.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <i class="fas fa-users" style="font-size: 3em; margin-bottom: 20px; opacity: 0.3; color: var(--primary-color);"></i>
                            <h3>אין מנויים להצגה</h3>
                            <p>עדיין לא נרשמו מנויים במערכת או שהסינון מסתיר את כולם</p>
                            <button class="btn" onclick="addTestSubscribers()" style="margin-top: 15px;">
                                <i class="fas fa-users-plus"></i> הוסף מנויים לבדיקה
                            </button>
                        </div>
                    `;
                    this.updateCounts(0, 0);
                    return;
                }

                const html = subscribers.map(subscriber => `
                    <div style="background: rgba(246, 152, 152, 0.1); border: 1px solid rgba(246, 152, 152, 0.3); border-radius: 8px; padding: 15px; margin-bottom: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div>
                                <div style="font-weight: bold; color: var(--primary-color);">${subscriber.name || 'ללא שם'}</div>
                                <div style="font-family: monospace; background: rgba(246, 152, 152, 0.2); padding: 5px 10px; border-radius: 4px; display: inline-flex; align-items: center; margin-top: 5px;">
                                    <button onclick="copyToClipboard('${subscriber.phone}')" 
                                            style="background: #25D366; color: white; border: none; padding: 4px 8px; border-radius: 4px; margin-left: 5px; cursor: pointer; font-size: 12px;" 
                                            title="העתק מספר לווטסאפ">📋 העתק</button>
                                    <span>${subscriber.phone}</span>
                                </div>
                            </div>
                            <div style="display: flex; gap: 5px;">
                                <button class="btn btn-small btn-secondary" onclick="contactSubscriber('${subscriber.phone}')" title="שלח הודעה">
                                    <i class="fab fa-whatsapp"></i>
                                </button>
                                <button class="btn btn-small btn-danger" onclick="removeSubscriber('${subscriber.phone}')" title="הסר מנוי">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                            <div>
                                <strong style="color: var(--primary-color);">קטגוריות:</strong><br>
                                <div style="display: flex; flex-wrap: wrap; gap: 3px; margin-top: 3px;">
                                    ${subscriber.categories ? subscriber.categories.map(cat => `<span style="background: rgba(37, 211, 102, 0.2); color: #25D366; padding: 2px 6px; border-radius: 10px; font-size: 0.8em;">${cat}</span>`).join('') : 'לא צוין'}
                                </div>
                            </div>
                            <div>
                                <strong style="color: var(--primary-color);">אזורים:</strong><br>
                                <div style="display: flex; flex-wrap: wrap; gap: 3px; margin-top: 3px;">
                                    ${subscriber.areas ? subscriber.areas.map(area => `<span style="background: rgba(246, 152, 152, 0.2); color: var(--primary-color); padding: 2px 6px; border-radius: 10px; font-size: 0.8em;">${area}</span>`).join('') : 'לא צוין'}
                                </div>
                            </div>
                        </div>
                        
                        <div style="font-size: 0.9em; color: #999;">
                            תאריך הרשמה: ${subscriber.registrationDate ? new Date(subscriber.registrationDate).toLocaleDateString('he-IL') : 'לא ידוע'}
                        </div>
                    </div>
                `).join('');

                container.innerHTML = html;
                
                // עדכון מונים
                const totalSubscribers = this.whatsappAlerts ? this.whatsappAlerts.getSubscribers().length : 0;
                this.updateCounts(totalSubscribers, subscribers.length);
            }

            updateCounts(total, visible) {
                const totalCount = document.getElementById('totalCount');
                const visibleCount = document.getElementById('visibleCount');
                
                if (totalCount) totalCount.textContent = total;
                if (visibleCount) visibleCount.textContent = visible;
            }

            getFilteredSubscribers() {
                let subscribers = this.whatsappAlerts ? this.whatsappAlerts.getSubscribers() : [];
                
                // סינון לפי קטגוריה
                const categoryFilter = document.getElementById('filterCategory');
                if (categoryFilter && categoryFilter.value) {
                    subscribers = subscribers.filter(sub => 
                        sub.categories && sub.categories.includes(categoryFilter.value)
                    );
                }

                // סינון לפי אזור
                const areaFilter = document.getElementById('filterArea');
                if (areaFilter && areaFilter.value) {
                    subscribers = subscribers.filter(sub => 
                        sub.areas && sub.areas.includes(areaFilter.value)
                    );
                }

                // סינון לפי תאריך
                const dateFilter = document.getElementById('filterDate');
                if (dateFilter && dateFilter.value) {
                    const now = new Date();
                    let filterDate;
                    
                    switch (dateFilter.value) {
                        case 'today':
                            filterDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                            break;
                        case 'week':
                            filterDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                            break;
                        case 'month':filterDate = new Date(now.getFullYear(), now.getMonth(), 1);
                            break;
                    }
                    
                    if (filterDate) {
                        subscribers = subscribers.filter(sub => 
                            sub.registrationDate && new Date(sub.registrationDate) >= filterDate);
                    }
                }

                // סינון לפי חיפוש טקסט
                const searchInput = document.getElementById('searchInput');
                if (searchInput && searchInput.value) {
                    const searchTerm = searchInput.value.toLowerCase();
                    subscribers = subscribers.filter(sub => 
                        (sub.name && sub.name.toLowerCase().includes(searchTerm)) ||
                        (sub.phone && sub.phone.includes(searchTerm)) ||
                        (sub.categories && sub.categories.some(cat => cat.toLowerCase().includes(searchTerm))) ||
                        (sub.areas && sub.areas.some(area => area.toLowerCase().includes(searchTerm)))
                    );
                }

                return subscribers;
            }

            filterSubscribers() {
                this.renderSubscribers();
            }

            updateStats() {
                const subscribers = this.whatsappAlerts ? this.whatsappAlerts.getSubscribers() : [];
                const container = document.getElementById('statsContainer');
                
                if (subscribers.length === 0) {
                    container.innerHTML = `
                        <div class="stat-card">
                            <span class="stat-number">0</span>
                            <div class="stat-label">סה"כ מנויים</div>
                        </div>
                    `;
                    
                    // עדכון הסטטיסטיקות העליונות
                    const totalSubscribersEl = document.getElementById('totalSubscribers');
                    const totalAlertsEl = document.getElementById('totalAlerts');
                    const newThisWeekEl = document.getElementById('newThisWeek');
                    const categoriesCountEl = document.getElementById('categoriesCount');
                    
                    if (totalSubscribersEl) totalSubscribersEl.textContent = '0';
                    if (totalAlertsEl) totalAlertsEl.textContent = '0';
                    if (newThisWeekEl) newThisWeekEl.textContent = '0';
                    if (categoriesCountEl) categoriesCountEl.textContent = '0';
                    
                    return;
                }

                // חישוב סטטיסטיקות
                const stats = {
                    total: subscribers.length,
                    active: subscribers.filter(s => s.active !== false).length,
                    categories: {},
                    areas: {},
                    recent: 0
                };

                const oneWeekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);

                subscribers.forEach(subscriber => {
                    // קטגוריות פופולריות
                    if (subscriber.categories) {
                        subscriber.categories.forEach(cat => {
                            stats.categories[cat] = (stats.categories[cat] || 0) + 1;
                        });
                    }
                    
                    // אזורים
                    if (subscriber.areas) {
                        subscriber.areas.forEach(area => {
                            stats.areas[area] = (stats.areas[area] || 0) + 1;
                        });
                    }
                    
                    // מנויים חדשים השבוע
                    if (subscriber.registrationDate) {
                        const regDate = new Date(subscriber.registrationDate);
                        if (regDate >= oneWeekAgo) {
                            stats.recent++;
                        }
                    }
                });

                // מציאת הקטגוריות והאזורים הפופולריים ביותר
                const topCategories = Object.entries(stats.categories)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 3);

                const html = `
                    <div class="stat-card">
                        <span class="stat-number">${stats.total}</span>
                        <div class="stat-label">מנויים פעילים</div>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number">${stats.active}</span>
                        <div class="stat-label">מנויים רשומים</div>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number">${stats.recent}</span>
                        <div class="stat-label">מנויים השבוע</div>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number">${Object.keys(stats.categories).length}</span>
                        <div class="stat-label">קטגוריות פעילות</div>
                    </div>
                    
                    ${topCategories.length > 0 ? `
                        <div style="grid-column: 1 / -1; margin-top: 20px;">
                            <h4 style="color: var(--primary-color); margin-bottom: 15px;">
                                <i class="fas fa-chart-bar"></i> קטגוריות פופולריות
                            </h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                ${topCategories.map(([category, count]) => `
                                    <div style="background: rgba(246, 152, 152, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(246, 152, 152, 0.3);">
                                        <div style="font-weight: bold; color: var(--primary-color);">${category}</div>
                                        <div style="font-size: 1.5em; font-weight: bold; margin-top: 5px;">${count}</div>
                                        <div style="font-size: 0.9em; color: #666;">מנויים</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                `;

                container.innerHTML = html;
                
                // עדכון הסטטיסטיקות העליונות
                const totalSubscribersEl = document.getElementById('totalSubscribers');
                const totalAlertsEl = document.getElementById('totalAlerts');
                const newThisWeekEl = document.getElementById('newThisWeek');
                const categoriesCountEl = document.getElementById('categoriesCount');
                
                if (totalSubscribersEl) totalSubscribersEl.textContent = stats.total;
                if (totalAlertsEl) totalAlertsEl.textContent = localStorage.getItem('whatsapp_total_alerts') || '0';
                if (newThisWeekEl) newThisWeekEl.textContent = stats.recent;
                if (categoriesCountEl) categoriesCountEl.textContent = Object.keys(stats.categories).length;
            }

            // פונקציות עזר
            showAlert(message, type = 'info') {
                console.log(`${type.toUpperCase()}: ${message}`);
                
                // יצירת התראה ויזואלית
                const alert = document.createElement('div');
                alert.className = `alert alert-${type}`;
                alert.textContent = message;
                alert.style.display = 'block';
                alert.style.position = 'fixed';
                alert.style.top = '20px';
                alert.style.right = '20px';
                alert.style.zIndex = '9999';
                alert.style.maxWidth = '400px';
                
                document.body.appendChild(alert);
                
                setTimeout(() => {
                    alert.remove();
                }, 5000);
            }

            closeAllModals() {
                document.querySelectorAll('.modal, .preview-modal').forEach(modal => {
                    modal.remove();
                });
            }
        }

        // פונקציות גלובליות לטיפול במנויים
        function addTestSubscribers() {
            if (!adminPanel || !adminPanel.whatsappAlerts) {
                alert('המערכת לא מוכנה עדיין');
                return;
            }

            const categories = correctJobsManager.getCategories();
            const areas = correctJobsManager.getAreas();

            const testSubscribers = [
                {
                    id: Date.now() + 1,
                    name: 'יוסי כהן',
                    phone: '+972501234567',
                    categories: [categories[0], categories[1]],
                    areas: [areas[0], areas[1]],
                    registrationDate: new Date().toISOString(),
                    active: true
                },
                {
                    id: Date.now() + 2,
                    name: 'שרה לוי',
                    phone: '+972527654321',
                    categories: [categories[2], categories[3]],
                    areas: [areas[2], areas[3]],
                    registrationDate: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString(),
                    active: true
                },
                {
                    id: Date.now() + 3,
                    name: 'דוד אברהם',
                    phone: '+972549876543',
                    categories: [categories[0], categories[4]],
                    areas: [areas[4], areas[5]],
                    registrationDate: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString(),
                    active: true
                }
            ];

            testSubscribers.forEach(subscriber => {
                adminPanel.whatsappAlerts.addSubscriber(subscriber);
            });

            adminPanel.renderSubscribers();
            adminPanel.updateStats();
            adminPanel.loadSubscriberSelect();
            
            adminPanel.showAlert('נוספו 3 מנויים לבדיקה!', 'success');
        }

        function contactSubscriber(phone) {
            const message = 'שלום! אני יוצר/ת איתך קשר ממערכת התראות המשרות של "מה יש פה?". איך אני יכול/ה לעזור?';
            const phoneNumber = phone.replace(/^0/, '972').replace(/\D/g, '');
            const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }

        function removeSubscriber(phone) {
            if (confirm(`האם אתה בטוח שברצונך להסיר את המנוי ${phone}?`)) {
                adminPanel.whatsappAlerts.removeSubscriber(phone);
                adminPanel.renderSubscribers();
                adminPanel.updateStats();
                adminPanel.loadSubscriberSelect();
                adminPanel.showAlert('המנוי הוסר בהצלחה', 'success');
            }
        }

        // פונקציות למשרות
        function searchJobAndSend() {
            const jobNumber = document.getElementById('jobSearchInput').value.trim();
            const resultsDiv = document.getElementById('jobSearchResults');
            
            if (!jobNumber) {
                resultsDiv.innerHTML = '<div class="error">אנא הכנס מספר משרה</div>';
                return;
            }

            resultsDiv.innerHTML = '<div class="loading">מחפש משרה...</div>';

            // חיפוש המשרה
            const job = correctJobsManager.findJobById(jobNumber);
            
            if (!job) {
                resultsDiv.innerHTML = `
                    <div class="error">
                        <i class="fas fa-exclamation-triangle"></i>
                        לא נמצאה משרה עם המספר: ${jobNumber}
                        <br><small>בדוק שהמספר נכון או נסה חיפוש חלקי</small>
                    </div>
                `;
                return;
            }

            // נרמול המשרה
            const normalizedJob = correctJobsManager.normalizeJob(job);

            // חיפוש מנויים מתאימים
            const subscribers = adminPanel?.whatsappAlerts?.getSubscribers() || [];
            const matchingSubscribers = correctJobsManager.findMatchingSubscribers(normalizedJob, subscribers);

            // הצגת תוצאות
            resultsDiv.innerHTML = `
                <div class="success">
                    <h4><i class="fas fa-briefcase"></i> נמצאה משרה!</h4>
                    <div style="background: rgba(246, 152, 152, 0.1); padding: 15px; border-radius: 8px; margin: 10px 0; border: 1px solid rgba(246, 152, 152, 0.3);">
                        <strong>${normalizedJob.title}</strong><br>
                        <small>אזור: ${normalizedJob.region}</small><br>
                        <small>קטגוריה: ${normalizedJob.category}</small>
                    </div>
                    <p><i class="fas fa-users"></i> נמצאו ${matchingSubscribers.length} מנויים מתאימים</p>
                    ${matchingSubscribers.length > 0 ? 
                        `<button class="btn" onclick="sendToMatchingSubscribers('${normalizedJob.id}')">
                            <i class="fas fa-paper-plane"></i> שלח ל-${matchingSubscribers.length} מנויים
                        </button>` : 
                        '<p style="color: var(--primary-color);">אין מנויים מתאימים לפי הקטגוריה והאזור</p>'
                    }
                </div>
            `;
        }

        function sendToMatchingSubscribers(jobId) {
            const job = correctJobsManager.findJobById(jobId);
            if (!job) return;

            const normalizedJob = correctJobsManager.normalizeJob(job);
            const subscribers = adminPanel?.whatsappAlerts?.getSubscribers() || [];
            const matchingSubscribers = correctJobsManager.findMatchingSubscribers(normalizedJob, subscribers);

            if (matchingSubscribers.length === 0) {
                alert('אין מנויים מתאימים');
                return;
            }

            // יצירת קישור ישיר למשרה
            const jobUrl = `https://www.mayeshpo.co.il/`;

            const message = `🔥 משרה חדשה מתאימה עבורך!

📋 ${normalizedJob.title}
📍 ${normalizedJob.region}
🎯 ${normalizedJob.category}
🆔 מספר משרה: ${normalizedJob.jobNumber}

🌐 לפרטים מלאים ולהגשת מועמדות:
${jobUrl}

🔍 באתר - חפש לפי מספר המשרה: ${normalizedJob.jobNumber}

בהצלחה! 💪`;
            
            // הצגת תצוגה מקדימה
            showPreviewWithLinkTest(message, matchingSubscribers, normalizedJob);
        }

        function showPreview(message, subscribers, job) {
            const modal = document.createElement('div');
            modal.className = 'preview-modal';
            modal.innerHTML = `
                <div class="preview-content">
                    <h3><i class="fas fa-eye"></i> תצוגה מקדימה</h3>
                    
                    <div style="margin: 15px 0;">
                        <strong>משרה:</strong> ${job.title}<br>
                        <strong>נמענים:</strong> ${subscribers.length} מנויים
                    </div>
                    
                    <h4>הודעה שתישלח:</h4>
                    <div class="whatsapp-message">
                        ${message.replace(/\n/g, '<br>')}
                    </div>
                    
                    <h4>רשימת נמענים:</h4>
                    <div style="max-height: 200px; overflow-y: auto; background: rgba(246, 152, 152, 0.1); padding: 10px; border-radius: 5px;">
                        ${subscribers.map(sub => 
                            `<div>📱 ${sub.phone} - ${sub.name || 'ללא שם'}</div>`
                        ).join('')}
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <button class="btn" onclick="confirmSendToAll('${job.id}')">
                            <i class="fas fa-paper-plane"></i> שלח לכל המנויים (${subscribers.length})
                        </button>
                        <button class="close-btn" onclick="this.parentElement.parentElement.parentElement.remove()">
                            <i class="fas fa-times"></i> סגור
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function showPreviewWithLinkTest(message, subscribers, job) {
            const modal = document.createElement('div');
            modal.className = 'preview-modal';
            modal.innerHTML = `
                <div class="preview-content">
                    <h3><i class="fas fa-eye"></i> תצוגה מקדימה</h3>
                    
                    <div style="margin: 15px 0;">
                        <strong>משרה:</strong> ${job.title}<br>
                        <strong>נמענים:</strong> ${subscribers.length} מנויים<br>
                        <strong>קישור לאתר:</strong> 
                        <a href="https://www.mayeshpo.co.il/" target="_blank" 
                           style="color: #25D366; text-decoration: underline;">
                           https://www.mayeshpo.co.il/
                        </a>
                    </div>
                    
                    <h4>הודעה שתישלח:</h4>
                    <div class="whatsapp-message">
                        ${message.replace(/\n/g, '<br>')}
                    </div>
                    
                    <div style="margin: 15px 0; padding: 10px; background: rgba(255, 193, 7, 0.1); border-radius: 5px;">
                        <strong>⚠️ שים לב:</strong> הקישור יהיה קליק רק בהודעת הוואטסאפ בפועל, לא בתצוגה המקדימה
                    </div>
                    
                    <h4>רשימת נמענים:</h4>
                    <div style="max-height: 200px; overflow-y: auto; background: rgba(246, 152, 152, 0.1); padding: 10px; border-radius: 5px;">
                        ${subscribers.map(sub => 
                            `<div>📱 ${sub.phone} - ${sub.name || 'ללא שם'}</div>`
                        ).join('')}
                    </div>
                    
                    <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn" onclick="testJobLink('${job.jobNumber}')">
                            <i class="fas fa-external-link-alt"></i> בדוק קישור
                        </button>
                        <button class="btn" onclick="confirmSendToAll('${job.id}')">
                            <i class="fas fa-paper-plane"></i> שלח לכל המנויים (${subscribers.length})
                        </button>
                        <button class="close-btn" onclick="this.parentElement.parentElement.parentElement.remove()">
                            <i class="fas fa-times"></i> סגור
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function testJobLink(jobNumber) {
            const testUrl = `https://www.mayeshpo.co.il/`;
            
            // פתיחת הקישור בטאב חדש
            const newWindow = window.open(testUrl, '_blank');
            
            // בדיקה אם הטאב נפתח
            if (newWindow) {
                console.log('✅ קישור נפתח:', testUrl);
                
                // הודעה למשתמש
                const confirmation = document.createElement('div');
                confirmation.innerHTML = `
                    <div style="
                        position: fixed;
                        top: 20px;
                        left: 50%;
                        transform: translateX(-50%);
                        background: #17a2b8;
                        color: white;
                        padding: 15px 25px;
                        border-radius: 5px;
                        z-index: 10003;
                        font-size: 14px;
                        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                    ">
                        🔗 האתר נפתח בטאב חדש - בדוק שהוא מוביל לדף הנכון ושאפשר לחפש לפי מספר משרה: ${jobNumber}
                    </div>
                `;
                
                document.body.appendChild(confirmation);
                
                setTimeout(() => {
                    confirmation.remove();
                }, 8000);
            } else {
                alert('לא ניתן לפתוח את הקישור. בדוק את חוסם הפופאפים');
            }
        }

        function confirmSendToAll(jobId) {
            // סימולציה של שליחה
            console.log(`📱 שולח הודעה לכל המנויים המתאימים למשרה ${jobId}`);
            
            // סגירת המודל
            document.querySelector('.preview-modal')?.remove();
            
            // הודעת הצלחה
            const resultsDiv = document.getElementById('jobSearchResults');
            resultsDiv.innerHTML = `
                <div class="success">
                    <i class="fas fa-check-circle"></i>
                    ההודעות נשלחו בהצלחה לכל המנויים המתאימים!
                </div>
            `;

            // עדכון סטטיסטיקות
            const currentAlerts = parseInt(localStorage.getItem('whatsapp_total_alerts') || '0');
            localStorage.setItem('whatsapp_total_alerts', (currentAlerts + 1).toString());
            adminPanel.updateStats();
        }

        function sendManualJob() {
            const title = document.getElementById('manualJobTitle').value.trim();
            const area = document.getElementById('manualArea').value;
            const category = document.getElementById('manualCategory').value;
            
            if (!title || !area || !category) {
                alert('אנא מלא את כל השדות');
                return;
            }

            // יצירת משרה ידנית
            const manualJob = {
                id: 'manual-' + Date.now(),
                jobNumber: 'MANUAL-' + Date.now(),
                title: title,
                area: area,
                region: area,
                category: category,
                description: 'משרה שהוכנסה ידנית',
                status: 'פעיל'
            };

            const normalizedJob = correctJobsManager.normalizeJob(manualJob);
            const subscribers = adminPanel?.whatsappAlerts?.getSubscribers() || [];
            const matchingSubscribers = correctJobsManager.findMatchingSubscribers(normalizedJob, subscribers);

            // הצגת תוצאות
            const resultsDiv = document.getElementById('jobSearchResults');
            resultsDiv.innerHTML = `
                <div class="success">
                    <h4><i class="fas fa-plus-circle"></i> משרה ידנית נוצרה!</h4>
                    <div style="background: rgba(246, 152, 152, 0.1); padding: 15px; border-radius: 8px; margin: 10px 0; border: 1px solid rgba(246, 152, 152, 0.3);">
                        <strong>${normalizedJob.title}</strong><br>
                        <small>אזור: ${normalizedJob.region}</small><br>
                        <small>קטגוריה: ${normalizedJob.category}</small>
                    </div>
                    <p><i class="fas fa-users"></i> נמצאו ${matchingSubscribers.length} מנויים מתאימים</p>
                    ${matchingSubscribers.length > 0 ? 
                        `<button class="btn" onclick="sendManualJobToSubscribers('${encodeURIComponent(JSON.stringify(normalizedJob))}')">
                            <i class="fas fa-paper-plane"></i> שלח ל-${matchingSubscribers.length} מנויים
                        </button>` : 
                        '<p style="color: var(--primary-color);">אין מנויים מתאימים לפי הקטגוריה והאזור</p>'
                    }
                </div>
            `;

            // ניקוי הטופס
            document.getElementById('manualJobTitle').value = '';
            document.getElementById('manualArea').value = '';
            document.getElementById('manualCategory').value = '';
        }

        function sendManualJobToSubscribers(jobJson) {
            const job = JSON.parse(decodeURIComponent(jobJson));
            const subscribers = adminPanel?.whatsappAlerts?.getSubscribers() || [];
            const matchingSubscribers = correctJobsManager.findMatchingSubscribers(job, subscribers);

            const message = `🔥 משרה חדשה!
📋 ${job.title}
📍 ${job.region}
🎯 ${job.category}

לפרטים נוספים: https://www.mayeshpo.co.il

בהצלחה! 💪`;

            showPreview(message, matchingSubscribers, job);
        }

        // פונקציות לשליחה ישירה
        function previewDirectMessage() {
            const subscriberIndex = document.getElementById('subscriberSelect').value;
            const message = document.getElementById('directMessage').value;
            
            if (!subscriberIndex || !message) {
                alert('אנא בחר מנוי והכנס הודעה');
                return;
            }

            const subscribers = adminPanel?.whatsappAlerts?.getSubscribers() || [];
            const subscriber = subscribers[subscriberIndex];
            
            if (!subscriber) {
                alert('מנוי לא נמצא');
                return;
            }

            const modal = document.createElement('div');
            modal.className = 'preview-modal';
            modal.innerHTML = `
                <div class="preview-content">
                    <h3><i class="fas fa-eye"></i> תצוגה מקדימה - הודעה ישירה</h3>
                    
                    <div style="margin: 15px 0;">
                        <strong>נמען:</strong> ${subscriber.phone} - ${subscriber.name || 'ללא שם'}
                    </div>
                    
                    <div class="whatsapp-message">
                        ${message.replace(/\n/g, '<br>')}
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <button class="btn" onclick="confirmDirectSend(${subscriberIndex}, '${message.replace(/'/g, "\\'")}')">
                            <i class="fas fa-paper-plane"></i> שלח הודעה
                        </button>
                        <button class="close-btn" onclick="this.parentElement.parentElement.parentElement.remove()">
                            <i class="fas fa-times"></i> סגור
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function confirmDirectSend(subscriberIndex, message) {
            const subscribers = adminPanel?.whatsappAlerts?.getSubscribers() || [];
            const subscriber = subscribers[subscriberIndex];
            
            if (!subscriber) {
                alert('שגיאה: מנוי לא נמצא');
                return;
            }

            // שליחה לוואטסאפ
            const phoneNumber = subscriber.phone.replace(/^0/, '972').replace(/\D/g, '');
            const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
            
            // סגירת המודל
            document.querySelector('.preview-modal')?.remove();
            
            // הודעת הצלחה
            adminPanel?.showAlert(`הודעה נשלחה בהצלחה ל-${subscriber.phone}`, 'success');
            
            // ניקוי הטופס
            document.getElementById('subscriberSelect').value = '';
            document.getElementById('directMessage').value = '';

            // עדכון סטטיסטיקות
            const currentAlerts = parseInt(localStorage.getItem('whatsapp_total_alerts') || '0');
            localStorage.setItem('whatsapp_total_alerts', (currentAlerts + 1).toString());
            adminPanel.updateStats();
        }

        function sendDirectMessage() {
            const subscriberIndex = document.getElementById('subscriberSelect').value;
            const message = document.getElementById('directMessage').value;
            
            if (!subscriberIndex || !message) {
                alert('אנא בחר מנוי והכנס הודעה');
                return;
            }

            confirmDirectSend(subscriberIndex, message);
        }

        // פונקציות כלליות
        function exportSubscribers() {
            const subscribers = adminPanel?.whatsappAlerts?.getSubscribers() || [];
            
            if (subscribers.length === 0) {
                alert('אין מנויים לייצוא');
                return;
            }

            // יצירת נתוני JSON
            const dataStr = JSON.stringify(subscribers, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `whatsapp_subscribers_${new Date().toISOString().split('T')[0]}.json`;
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            adminPanel?.showAlert(`ייצוא ${subscribers.length} מנויים הושלם!`, 'success');
        }

        function importSubscribers(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (!Array.isArray(importedData)) {
                        throw new Error('קובץ JSON חייב להכיל מערך של מנויים');
                    }

                    let imported = 0;
                    let skipped = 0;
                    
                    const existingSubscribers = adminPanel?.whatsappAlerts?.getSubscribers() || [];
                    
                    importedData.forEach(subscriber => {
                        // בדיקה שהמנוי תקין
                        if (subscriber.phone && subscriber.name) {
                            // בדיקה שהמספר לא קיים
                            if (!existingSubscribers.find(sub => sub.phone === subscriber.phone)) {
                                // הוספת שדות חסרים
                                subscriber.id = subscriber.id || Date.now() + Math.random();
                                subscriber.registrationDate = subscriber.registrationDate || new Date().toISOString();
                                subscriber.categories = subscriber.categories || ['אחר'];
                                subscriber.areas = subscriber.areas || ['כל הארץ'];
                                subscriber.active = subscriber.active !== false;
                                
                                adminPanel.whatsappAlerts.addSubscriber(subscriber);
                                imported++;
                            } else {
                                skipped++;
                            }
                        }
                    });

                    adminPanel.renderSubscribers();
                    adminPanel.updateStats();
                    adminPanel.loadSubscriberSelect();

                    adminPanel?.showAlert(`יובאו ${imported} מנויים חדשים. ${skipped} מנויים קיימים דולגו.`, 'success');
                } catch (error) {
                    adminPanel?.showAlert('שגיאה בקריאת הקובץ: ' + error.message, 'error');
                }
            };
            
            reader.readAsText(file);
            event.target.value = ''; // ניקוי השדה
        }

        function clearAllData() {
            const message = 'האם אתה בטוח שברצונך למחוק את כל הנתונים?\n\n• כל המנויים יימחקו\n• כל הסטטיסטיקות יאופסו\n\nפעולה זו לא ניתנת לביטול!';
            
            if (confirm(message)) {
                if (confirm('זוהי אזהרה אחרונה! האם אתה בטוח לגמרי?')) {
                    // מחיקת נתונים
                    localStorage.removeItem('whatsapp_alerts_subscribers');
                    localStorage.removeItem('whatsapp_total_alerts');
                    localStorage.removeItem('subscribers_backup');
                    
                    // איפוס המערכת
                    if (adminPanel?.whatsappAlerts) {
                        adminPanel.whatsappAlerts.subscribers = [];
                    }
                    
                    // עדכון תצוגה
                    adminPanel?.renderSubscribers();
                    adminPanel?.updateStats();
                    adminPanel?.loadSubscriberSelect();
                    
                    adminPanel?.showAlert('כל הנתונים נמחקו בהצלחה', 'success');
                }
            }
        }

        function generateReport() {
            const subscribers = adminPanel?.whatsappAlerts?.getSubscribers() || [];
            
            if (subscribers.length === 0) {
                alert('אין נתונים ליצירת דוח');
                return;
            }

            // חישוב סטטיסטיקות
            const categoryStats = {};
            const areaStats = {};
            const monthlyStats = {};

            subscribers.forEach(subscriber => {
                // סטטיסטיקות קטגוריות
                if (subscriber.categories) {
                    subscriber.categories.forEach(cat => {
                        categoryStats[cat] = (categoryStats[cat] || 0) + 1;
                    });
                }
                
                // סטטיסטיקות אזורים
                if (subscriber.areas) {
                    subscriber.areas.forEach(area => {
                        areaStats[area] = (areaStats[area] || 0) + 1;
                    });
                }
                
                // סטטיסטיקות חודשיות
                if (subscriber.registrationDate) {
                    const month = new Date(subscriber.registrationDate).toISOString().slice(0, 7);
                    monthlyStats[month] = (monthlyStats[month] || 0) + 1;
                }
            });

            // יצירת הדוח
            const now = new Date();
            const totalAlerts = localStorage.getItem('whatsapp_total_alerts') || '0';
            
            let report = `דוח מפורט - מערכת התראות WhatsApp "מה יש פה?"\n`;
            report += `תאריך יצירת הדוח: ${now.toLocaleDateString('he-IL')} ${now.toLocaleTimeString('he-IL')}\n`;
            report += `${'='.repeat(60)}\n\n`;
            
            // סטטיסטיקות כלליות
            report += `📊 סטטיסטיקות כלליות:\n`;
            report += `• סה"כ מנויים פעילים: ${subscribers.length}\n`;
            report += `• סה"כ התראות נשלחו: ${totalAlerts}\n`;
            report += `• ממוצע התראות למנוי: ${(parseInt(totalAlerts) / Math.max(subscribers.length, 1)).toFixed(1)}\n\n`;
            
            // התפלגות לפי קטגוריות
            report += `📈 התפלגות לפי קטגוריות:\n`;
            Object.entries(categoryStats)
                .sort((a, b) => b[1] - a[1])
                .forEach(([cat, count]) => {
                    const percentage = ((count / subscribers.length) * 100).toFixed(1);
                    report += `• ${cat}: ${count} מנויים (${percentage}%)\n`;
                });
            
            // התפלגות לפי אזורים
            report += `\n🗺️ התפלגות לפי אזורים:\n`;
            Object.entries(areaStats)
                .sort((a, b) => b[1] - a[1])
                .forEach(([area, count]) => {
                    const percentage = ((count / subscribers.length) * 100).toFixed(1);
                    report += `• ${area}: ${count} מנויים (${percentage}%)\n`;
                });
            
            // התפלגות חודשית
            report += `\n📅 התפלגות הרשמות לפי חודשים:\n`;
            Object.entries(monthlyStats)
                .sort((a, b) => b[0].localeCompare(a[0]))
                .slice(0, 6) // 6 חודשים אחרונים
                .forEach(([month, count]) => {
                    const monthName = new Date(month + '-01').toLocaleDateString('he-IL', { year: 'numeric', month: 'long' });
                    report += `• ${monthName}: ${count} הרשמות\n`;
                });

            // הצגת הדוח
            const modal = document.createElement('div');
            modal.className = 'preview-modal';
            modal.innerHTML = `
                <div class="preview-content" style="max-width: 700px;">
                    <h3><i class="fas fa-chart-bar"></i> דוח סטטיסטיקות מפורט</h3>
                    
                    <div style="margin: 20px 0;">
                        <pre style="color: white; white-space: pre-wrap; line-height: 1.6; background: rgba(246, 152, 152, 0.1); padding: 20px; border-radius: 8px; max-height: 400px; overflow-y: auto; border: 1px solid rgba(246, 152, 152, 0.3);">${report}</pre>
                    </div>
                    
                    <div style="display: flex; gap: 15px; justify-content: center; margin-top: 20px;">
                        <button onclick="navigator.clipboard.writeText(\`${report.replace(/`/g, '\\`')}\`).then(() => alert('דוח הועתק ללוח!'))" class="btn">
                            <i class="fas fa-copy"></i> העתק דוח
                        </button>
                        <button onclick="this.closest('.preview-modal').remove()" class="close-btn">
                            <i class="fas fa-times"></i> סגור
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function refreshSubscribersList() {
            console.log('🔄 מרענן רשימת מנויים...');
            
            // עדכון הטבלה
            if (adminPanel) {
                adminPanel.renderSubscribers();
                adminPanel.updateStats();
                adminPanel.loadSubscriberSelect();
            }
            
            adminPanel?.showAlert('✅ רשימת המנויים רועננה!', 'success');
        }

        // פונקציות כפתור העתקה
        function copyToClipboard(text) {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(() => {
                    showCopyConfirmation();
                }).catch(err => {
                    console.error('שגיאה בהעתקה:', err);
                    fallbackCopy(text);
                });
            } else {
                fallbackCopy(text);
            }
        }

        // פתרון גיבוי להעתקה
        function fallbackCopy(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                showCopyConfirmation();
            } catch (err) {
                console.error('שגיאה בהעתקה:', err);
            }
            document.body.removeChild(textArea);
        }

        // הצגת הודעת אישור העתקה
        function showCopyConfirmation() {
            const confirmation = document.createElement('div');
            confirmation.innerHTML = `
                <div style="
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #25D366;
                    color: white;
                    padding: 10px 15px;
                    border-radius: 5px;
                    z-index: 10002;
                    font-size: 14px;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
                    animation: slideIn 0.3s ease;
                ">
                    ✅ המספר הועתק ללוח!
                </div>
                <style>
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                </style>
            `;
            
            document.body.appendChild(confirmation);
            
            setTimeout(() => {
                confirmation.remove();
            }, 3000);
        }
// פונקציות לכלי בדיקה והתאמות
        function analyzeJobsStructure() {
            const jobs = correctJobsManager.getAllJobs();
            
            if (!jobs || jobs.length === 0) {
                alert('❌ אין משרות לניתוח. וודא שקובץ המשרות נטען.');
                return;
            }

            console.log(`🔍 ניתוח מבנה של ${jobs.length} משרות:`);
            
            // ניתוח השדות הקיימים
            const fieldAnalysis = {};
            const sampleJob = jobs[0];
            
            Object.keys(sampleJob).forEach(field => {
                const valuesSet = new Set();
                jobs.slice(0, 10).forEach(job => {
                    if (job[field]) valuesSet.add(job[field]);
                });
                
                fieldAnalysis[field] = {
                    type: typeof sampleJob[field],
                    sampleValues: Array.from(valuesSet).slice(0, 3),
                    totalFound: jobs.filter(job => job[field]).length
                };
            });

            console.table(fieldAnalysis);
            
            // דוגמת משרה מלאה
            console.log('📝 דוגמת משרה מלאה:');
            console.log(JSON.stringify(sampleJob, null, 2));
            
            // בדיקת איכות נתונים
            const qualityReport = {
                totalJobs: jobs.length,
                withJobNumber: jobs.filter(j => j.jobNumber).length,
                withTitle: jobs.filter(j => j.title).length,
                withCategory: jobs.filter(j => j.category).length,
                withRegion: jobs.filter(j => j.region || j.area).length,
                activeJobs: jobs.filter(j => j.status === 'פעיל').length,
                titlesWithSlash: jobs.filter(j => j.title && j.title.includes('/')).length
            };
            
            console.log('📊 דוח איכות נתונים:');
            console.table(qualityReport);

            // בדיקת טיפול בזכר/נקבה
            console.log('🔍 בדיקת טיפול בזכר/נקבה:');
            const slashExamples = jobs.filter(j => j.title && j.title.includes('/')).slice(0, 5);
            slashExamples.forEach(job => {
                console.log(`- ${job.title}`);
            });
            
            // הצגת התוצאות במודל
            showAnalysisModal(fieldAnalysis, qualityReport, slashExamples);
            
            return qualityReport;
        }

        function showAnalysisModal(fieldAnalysis, qualityReport, slashExamples) {
            const modal = document.createElement('div');
            modal.className = 'preview-modal';
            modal.innerHTML = `
                <div class="preview-content" style="max-width: 800px;">
                    <h3><i class="fas fa-microscope"></i> ניתוח מבנה משרות</h3>
                    
                    <div style="margin: 20px 0;">
                        <h4 style="color: var(--primary-color);">📊 דוח איכות נתונים:</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 15px 0;">
                            <div style="background: rgba(246, 152, 152, 0.1); padding: 15px; border-radius: 8px;">
                                <strong>סה"כ משרות:</strong> ${qualityReport.totalJobs}
                            </div>
                            <div style="background: rgba(246, 152, 152, 0.1); padding: 15px; border-radius: 8px;">
                                <strong>עם מספר משרה:</strong> ${qualityReport.withJobNumber}
                            </div>
                            <div style="background: rgba(246, 152, 152, 0.1); padding: 15px; border-radius: 8px;">
                                <strong>עם קטגוריה:</strong> ${qualityReport.withCategory}
                            </div>
                            <div style="background: rgba(246, 152, 152, 0.1); padding: 15px; border-radius: 8px;">
                                <strong>עם אזור:</strong> ${qualityReport.withRegion}
                            </div>
                            <div style="background: rgba(37, 211, 102, 0.1); padding: 15px; border-radius: 8px;">
                                <strong>משרות פעילות:</strong> ${qualityReport.activeJobs}
                            </div>
                            <div style="background: rgba(255, 193, 7, 0.1); padding: 15px; border-radius: 8px;">
                                <strong>כותרות עם "/":</strong> ${qualityReport.titlesWithSlash}
                            </div>
                        </div>
                        
                        <h4 style="color: var(--primary-color);">🔍 דוגמאות זכר/נקבה:</h4>
                        <div style="background: rgba(255, 193, 7, 0.1); padding: 15px; border-radius: 8px; margin: 15px 0;">
                            ${slashExamples.length > 0 ? 
                                slashExamples.map(job => `<div>• ${job.title}</div>`).join('') :
                                '<div>לא נמצאו כותרות עם סלאש</div>'
                            }
                        </div>
                        
                        <h4 style="color: var(--primary-color);">🏗️ שדות במבנה:</h4>
                        <div style="background: rgba(246, 152, 152, 0.1); padding: 15px; border-radius: 8px; max-height: 200px; overflow-y: auto;">
                            ${Object.entries(fieldAnalysis).map(([field, info]) => 
                                `<div style="margin-bottom: 10px;">
                                    <strong>${field}:</strong> ${info.type} 
                                    (${info.totalFound}/${qualityReport.totalJobs} משרות)
                                    <br><small>דוגמאות: ${info.sampleValues.join(', ')}</small>
                                </div>`
                            ).join('')}
                        </div>
                    </div>
                    
                    <button class="close-btn" onclick="this.parentElement.parentElement.remove()">
                        <i class="fas fa-times"></i> סגור
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function testJobSearchDemo() {
            console.log('🧪 התחלת בדיקת מערכת החיפוש...');
            
            const testCases = ['A-25821', '12345', 'משאית', 'Full Stack', 'נהג'];
            const results = [];
            
            testCases.forEach(testCase => {
                console.log(`\n--- בדיקה: ${testCase} ---`);
                const job = correctJobsManager.findJobById(testCase);
                
                if (job) {
                    console.log('✅ משרה נמצאה:');
                    console.log(`   מספר: ${job.jobNumber}`);
                    console.log(`   כותרת: ${job.title}`);
                    console.log(`   קטגוריה: ${job.category}`);
                    console.log(`   אזור: ${job.region || job.area}`);
                    console.log(`   סטטוס: ${job.status}`);
                    
                    results.push({
                        search: testCase,
                        found: true,
                        job: job
                    });
                } else {
                    console.log('❌ משרה לא נמצאה');
                    results.push({
                        search: testCase,
                        found: false
                    });
                }
            });
            
            // הצגת תוצאות במודל
            showSearchResultsModal(results);
            
            console.log('\n✅ בדיקת החיפוש הושלמה - ראה תוצאות בקונסול');
        }

        function showSearchResultsModal(results) {
            const modal = document.createElement('div');
            modal.className = 'preview-modal';
            modal.innerHTML = `
                <div class="preview-content">
                    <h3><i class="fas fa-search"></i> תוצאות בדיקת חיפוש</h3>
                    
                    <div style="margin: 20px 0;">
                        ${results.map(result => `
                            <div style="background: ${result.found ? 'rgba(37, 211, 102, 0.1)' : 'rgba(255, 71, 87, 0.1)'}; 
                                        padding: 15px; margin: 10px 0; border-radius: 8px; 
                                        border: 1px solid ${result.found ? 'rgba(37, 211, 102, 0.3)' : 'rgba(255, 71, 87, 0.3)'};">
                                <div><strong>חיפוש:</strong> "${result.search}" 
                                    ${result.found ? '✅' : '❌'}
                                </div>
                                ${result.found ? `
                                    <div style="margin-top: 8px; font-size: 0.9em;">
                                        <div><strong>מספר:</strong> ${result.job.jobNumber}</div>
                                        <div><strong>כותרת:</strong> ${result.job.title}</div>
                                        <div><strong>קטגוריה:</strong> ${result.job.category}</div>
                                        <div><strong>אזור:</strong> ${result.job.region || result.job.area}</div>
                                    </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                    
                    <button class="close-btn" onclick="this.parentElement.parentElement.remove()">
                        <i class="fas fa-times"></i> סגור
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function testMatchingDemo() {
            const jobs = correctJobsManager.getAllJobs();
            const subscribers = adminPanel?.whatsappAlerts?.getSubscribers() || [];
            
            if (jobs.length === 0 || subscribers.length === 0) {
                alert('צריך משרות ומנויים כדי לבדוק התאמה. הוסף מנויים לבדיקה ווודא שהמשרות נטענות.');
                return;
            }

            // בחירת משרה לבדיקה
            const testJob = jobs[0];
            const normalizedJob = correctJobsManager.normalizeJob(testJob);
            const matches = correctJobsManager.findMatchingSubscribers(normalizedJob, subscribers);

            // ניתוח מפורט של ההתאמות
            const matchDetails = subscribers.map(subscriber => {
                const categoryMatch = correctJobsManager.matchCategory(normalizedJob.category, subscriber.categories);
                const areaMatch = correctJobsManager.matchArea(normalizedJob.region, subscriber.areas);
                const overallMatch = categoryMatch && areaMatch;
                
                return {
                    subscriber,
                    categoryMatch,
                    areaMatch,
                    overallMatch
                };
            });

            showMatchingAnalysisModal(normalizedJob, matchDetails);
        }

        function showMatchingAnalysisModal(job, matchDetails) {
            const modal = document.createElement('div');
            modal.className = 'preview-modal';
            modal.innerHTML = `
                <div class="preview-content" style="max-width: 900px;">
                    <h3><i class="fas fa-users"></i> ניתוח התאמת מנויים</h3>
                    
                    <div style="margin: 20px 0;">
                        <h4 style="color: var(--primary-color);">📋 משרה לבדיקה:</h4>
                        <div style="background: rgba(246, 152, 152, 0.1); padding: 15px; border-radius: 8px; margin: 10px 0;">
                            <strong>${job.title}</strong><br>
                            <small>קטגוריה: ${job.category}</small><br>
                            <small>אזור: ${job.region}</small><br>
                            <small>מספר: ${job.jobNumber}</small>
                        </div>

                        <h4 style="color: var(--primary-color);">👥 ניתוח התאמות (${matchDetails.filter(m => m.overallMatch).length}/${matchDetails.length} מתאימים):</h4>
                        <div style="max-height: 400px; overflow-y: auto;">
                            ${matchDetails.map(detail => `
                                <div style="background: ${detail.overallMatch ? 'rgba(37, 211, 102, 0.1)' : 'rgba(255, 71, 87, 0.1)'}; 
                                            padding: 15px; margin: 5px 0; border-radius: 8px; 
                                            border: 1px solid ${detail.overallMatch ? 'rgba(37, 211, 102, 0.3)' : 'rgba(255, 71, 87, 0.3)'};">
                                    <div style="font-weight: bold;">
                                        📱 ${detail.subscriber.phone} - ${detail.subscriber.name || 'ללא שם'}
                                        ${detail.overallMatch ? '✅' : '❌'}
                                    </div>
                                    <div style="margin-top: 8px; font-size: 0.9em;">
                                        <div>🎯 קטגוריות מנוי: ${detail.subscriber.categories.join(', ')} 
                                            ${detail.categoryMatch ? '✅' : '❌'}
                                        </div>
                                        <div>📍 אזורי מנוי: ${detail.subscriber.areas.join(', ')} 
                                            ${detail.areaMatch ? '✅' : '❌'}
                                        </div>
                                        ${!detail.overallMatch ? `
                                            <div style="color: #ff6b6b; margin-top: 5px; font-size: 0.8em;">
                                                ${!detail.categoryMatch ? '• לא התאמה בקטגוריה' : ''}
                                                ${!detail.areaMatch ? '• לא התאמה באזור' : ''}
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>

                        <h4 style="color: var(--primary-color);">📊 סיכום:</h4>
                        <div style="background: rgba(246, 152, 152, 0.1); padding: 15px; border-radius: 8px;">
                            <div>מתוך ${matchDetails.length} מנויים במערכת:</div>
                            <div>• ${matchDetails.filter(m => m.overallMatch).length} מתאימים למשרה זו</div>
                            <div>• ${matchDetails.filter(m => m.categoryMatch).length} מתאימים בקטגוריה</div>
                            <div>• ${matchDetails.filter(m => m.areaMatch).length} מתאימים באזור</div>
                        </div>
                    </div>
                    
                    <button class="close-btn" onclick="this.parentElement.parentElement.remove()">
                        <i class="fas fa-times"></i> סגור
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function testCategoryMatching() {
            const testCases = [
                {
                    jobCategory: 'לוגיסטיקה, מחסנים, שילוח ורכש',
                    subscriberCategories: ['לוגיסטיקה'],
                    expected: true,
                    note: 'התאמה חלקית - קטגוריה מוכלת'
                },
                {
                    jobCategory: 'לוגיסטיקה, מחסנים, שילוח ורכש',
                    subscriberCategories: ['נהיגה'],
                    expected: true,
                    note: 'התאמה לפי מילות מפתח'
                },
                {
                    jobCategory: 'פיתוח ותוכנה',
                    subscriberCategories: ['מפתח'],
                    expected: true,
                    note: 'התאמה לפי מילות מפתח'
                },
                {
                    jobCategory: 'נהג/ת משאית',
                    subscriberCategories: ['לוגיסטיקה'],
                    expected: true,
                    note: 'טיפול בסלאש לזכר/נקבה'
                },
                {
                    jobCategory: 'מורה/מחנך לחינוך מיוחד',
                    subscriberCategories: ['חינוך והוראה'],
                    expected: true,
                    note: 'טיפול בסלאש עם תחומים שונים'
                },
                {
{
    jobCategory: 'מפתח/ת Full Stack',
    subscriberCategories: ['פיתוח ותוכנה'],
    expected: true,
note: 'זכר/נקבה עם טכנולוגיה'
},
{
                {
                    jobCategory: 'מכירות ושיווק',
                    subscriberCategories: ['חינוך והוראה'],
                    expected: false,
                    note: 'אין התאמה - תחומים שונים'
                }
            ];
            
            console.log('🧪 בדיקת מערכת התאמת קטגוריות:');
            const results = [];
            
            testCases.forEach((test, index) => {
                const result = correctJobsManager.matchCategory(test.jobCategory, test.subscriberCategories);
                const status = result === test.expected ? '✅' : '❌';
                
                console.log(`${status} בדיקה ${index + 1}:`);
                console.log(`  משרה: ${test.jobCategory}`);
                console.log(`  מנוי: ${test.subscriberCategories.join(', ')}`);
                console.log(`  תוצאה: ${result} (צפוי: ${test.expected})`);
                if (test.note) {
                    console.log(`  הערה: ${test.note}`);
                }
                
                results.push({
                    ...test,
                    result,
                    success: result === test.expected,
                    index: index + 1
                });
            });

            // הצגת תוצאות במודל
            showCategoryTestModal(results);
        }

        function showCategoryTestModal(results) {
            const successCount = results.filter(r => r.success).length;
            
            const modal = document.createElement('div');
            modal.className = 'preview-modal';
            modal.innerHTML = `
                <div class="preview-content" style="max-width: 800px;">
                    <h3><i class="fas fa-vial"></i> תוצאות בדיקת התאמת קטגוריות</h3>
                    
                    <div style="margin: 20px 0;">
                        <div style="background: ${successCount === results.length ? 'rgba(37, 211, 102, 0.1)' : 'rgba(255, 193, 7, 0.1)'}; 
                                    padding: 15px; border-radius: 8px; margin-bottom: 20px; 
                                    border: 1px solid ${successCount === results.length ? 'rgba(37, 211, 102, 0.3)' : 'rgba(255, 193, 7, 0.3)'};">
                            <strong>תוצאה כללית: ${successCount}/${results.length} בדיקות עברו בהצלחה</strong>
                        </div>
                        
                        <div style="max-height: 400px; overflow-y: auto;">
                            ${results.map(test => `
                                <div style="background: ${test.success ? 'rgba(37, 211, 102, 0.1)' : 'rgba(255, 71, 87, 0.1)'}; 
                                            padding: 15px; margin: 10px 0; border-radius: 8px; 
                                            border: 1px solid ${test.success ? 'rgba(37, 211, 102, 0.3)' : 'rgba(255, 71, 87, 0.3)'};">
                                    <div><strong>בדיקה ${test.index}:</strong> ${test.success ? '✅ הצליח' : '❌ נכשל'}</div>
                                    <div style="margin-top: 8px; font-size: 0.9em;">
                                        <div><strong>קטגוריית משרה:</strong> ${test.jobCategory}</div>
                                        <div><strong>קטגוריות מנוי:</strong> ${test.subscriberCategories.join(', ')}</div>
                                        <div><strong>תוצאה:</strong> ${test.result ? 'התאמה' : 'אין התאמה'} 
                                            (צפוי: ${test.expected ? 'התאמה' : 'אין התאמה'})</div>
                                        <div style="margin-top: 5px; font-style: italic; color: #999;">${test.note}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <button class="close-btn" onclick="this.parentElement.parentElement.remove()">
                        <i class="fas fa-times"></i> סגור
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function testGenderMatching() {
            const genderTestCases = [
                {
                    jobTitle: 'נהג/ת משאית מנוף',
                    subscriberCategories: ['לוגיסטיקה, מחסנים, שילוח ורכש'],
                    note: 'זכר/נקבה עם התאמה לקטגוריה'
                },
                {
                    jobTitle: 'מפתח/ת Full Stack',
                    subscriberCategories: ['פיתוח ותוכנה'],
                    note: 'זכר/נקבה בתחום הטכנולוגיה'
                },
                {
                    jobTitle: 'מורה/מחנך לחינוך מיוחד',
                    subscriberCategories: ['חינוך והוראה'],
                    note: 'שני תפקידים שונים עם סלאש'
                },
                {
                    jobTitle: 'מוכר/ת בחנות בגדים',
                    subscriberCategories: ['מכירות ושיווק'],
                    note: 'מכירות עם זכר/נקבה'
                },
                {
                    jobTitle: 'מטפל/ת סיעודי',
                    subscriberCategories: ['בריאות ורפואה'],
                    note: 'תפקיד טיפולי עם זכר/נקבה'
                }
            ];
            
            console.log('🧪 בדיקת התאמה לזכר/נקבה:');
            const results = [];
            
            genderTestCases.forEach((test, index) => {
                const result = correctJobsManager.matchCategory(test.jobTitle, test.subscriberCategories);
                
                console.log(`🔍 בדיקה ${index + 1}:`);
                console.log(`  כותרת משרה: ${test.jobTitle}`);
                console.log(`  קטגוריות מנוי: ${test.subscriberCategories.join(', ')}`);
                console.log(`  תוצאה: ${result ? '✅ התאמה' : '❌ אין התאמה'}`);
                console.log(`  הערה: ${test.note}`);
                
                results.push({
                    ...test,
                    result,
                    index: index + 1
                });
            });

            showGenderTestModal(results);
        }

        function showGenderTestModal(results) {
            const modal = document.createElement('div');
            modal.className = 'preview-modal';
            modal.innerHTML = `
                <div class="preview-content" style="max-width: 800px;">
                    <h3><i class="fas fa-venus-mars"></i> בדיקת התאמה לזכר/נקבה</h3>
                    
                    <div style="margin: 20px 0;">
                        <div style="background: rgba(255, 193, 7, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid rgba(255, 193, 7, 0.3);">
                            <strong>המערכת מזהה ומתאימה משרות עם סלאש (/) המציינות זכר/נקבה</strong>
                        </div>
                        
                        <div style="max-height: 400px; overflow-y: auto;">
                            ${results.map(test => `
                                <div style="background: ${test.result ? 'rgba(37, 211, 102, 0.1)' : 'rgba(255, 71, 87, 0.1)'}; 
                                            padding: 15px; margin: 10px 0; border-radius: 8px; 
                                            border: 1px solid ${test.result ? 'rgba(37, 211, 102, 0.3)' : 'rgba(255, 71, 87, 0.3)'};">
                                    <div><strong>בדיקה ${test.index}:</strong> ${test.result ? '✅ התאמה' : '❌ אין התאמה'}</div>
                                    <div style="margin-top: 8px; font-size: 0.9em;">
                                        <div><strong>כותרת משרה:</strong> ${test.jobTitle}</div>
                                        <div><strong>קטגוריות מנוי:</strong> ${test.subscriberCategories.join(', ')}</div>
                                        <div style="margin-top: 5px; font-style: italic; color: #999;">${test.note}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <button class="close-btn" onclick="this.parentElement.parentElement.remove()">
                        <i class="fas fa-times"></i> סגור
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function showMatchingRules() {
            const modal = document.createElement('div');
            modal.className = 'preview-modal';
            modal.innerHTML = `
                <div class="preview-content" style="max-width: 800px;">
                    <h3><i class="fas fa-book"></i> חוקי התאמה של המערכת</h3>
                    
                    <div style="margin: 20px 0; max-height: 500px; overflow-y: auto;">
                        <h4 style="color: var(--primary-color);">🎯 התאמת קטגוריות:</h4>
                        <div style="background: rgba(246, 152, 152, 0.1); padding: 15px; border-radius: 8px; margin: 10px 0;">
                            <div><strong>1. התאמה מדויקת:</strong> השוואה זהה בין קטגוריית המשרה למנוי</div>
                            <div><strong>2. התאמה חלקית:</strong> קטגוריה אחת מוכלת בשנייה</div>
                            <div><strong>3. מילות מפתח:</strong> התאמה לפי מילות מפתח רלוונטיות</div>
                            <div><strong>4. זכר/נקבה:</strong> טיפול בסלאש (/) לזיהוי תפקידים</div>
                        </div>
                        
                        <h4 style="color: var(--primary-color);">🗺️ התאמת אזורים:</h4>
                        <div style="background: rgba(37, 211, 102, 0.1); padding: 15px; border-radius: 8px; margin: 10px 0;">
                            <div><strong>1. התאמה מדויקת:</strong> אזור זהה</div>
                            <div><strong>2. התאמה חלקית:</strong> אזור מוכל באזור אחר</div>
                            <div><strong>3. "כל הארץ":</strong> תמיד מתאים</div>
                            <div><strong>4. אזורים גיאוגרפיים:</strong> התאמות גמישות (מרכז ← תל אביב)</div>
                        </div>

                        <h4 style="color: var(--primary-color);">🔧 מילות מפתח:</h4>
                        <div style="background: rgba(255, 193, 7, 0.1); padding: 15px; border-radius: 8px; margin: 10px 0;">
                            <div><strong>לוגיסטיקה ←→</strong> נהג, נהיגה, משאית, מנוף, הובלה</div>
                            <div><strong>פיתוח ←→</strong> מפתח, תכנות, תוכנה, programmer</div>
                            <div><strong>מכירות ←→</strong> שיווק, marketing, sales, מוכר</div>
                            <div><strong>חינוך ←→</strong> מורה, הוראה, מחנך, גננת</div>
                            <div><strong>בריאות ←→</strong> רפואה, רופא, אחות, טיפול</div>
                        </div>

                        <h4 style="color: var(--primary-color);">⚖️ טיפול בזכר/נקבה:</h4>
                        <div style="background: rgba(156, 39, 176, 0.1); padding: 15px; border-radius: 8px; margin: 10px 0;">
                            <div><strong>זיהוי סלאש:</strong> "נהג/ת", "מפתח/ת", "מורה/מחנך"</div>
                            <div><strong>פיצול וחיפוש:</strong> בדיקת כל חלק בנפרד</div>
                            <div><strong>סיומות נקבה:</strong> התאמה של "ית", "ת", "ה"</div>
                            <div><strong>דו-כיווני:</strong> עובד גם כשהמנוי כתב עם סלאש</div>
                        </div>

                        <h4 style="color: var(--primary-color);">📝 דוגמאות התאמה:</h4>
                        <div style="background: rgba(3, 169, 244, 0.1); padding: 15px; border-radius: 8px; margin: 10px 0;">
                            <div>✅ "נהג/ת משאית" ← מנוי: "לוגיסטיקה"</div>
                            <div>✅ "מפתח/ת Full Stack" ← מנוי: "פיתוח ותוכנה"</div>
                            <div>✅ "מורה/מחנך" ← מנוי: "חינוך והוראה"</div>
                            <div>✅ "עבודה מהבית" ← מנוי: "כל הארץ"</div>
                            <div>❌ "מכירות" ← מנוי: "בריאות ורפואה"</div>
                        </div>
                    </div>
                    
                    <button class="close-btn" onclick="this.parentElement.parentElement.remove()">
                        <i class="fas fa-times"></i> סגור
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function testRealTimeMatching() {
            const jobCategory = document.getElementById('testJobCategory').value.trim();
            const subscriberCategoriesText = document.getElementById('testSubscriberCategories').value.trim();
            
            if (!jobCategory || !subscriberCategoriesText) {
                alert('אנא הכנס קטגוריית משרה וקטגוריות מנוי');
                return;
            }
            
            // פיצול קטגוריות המנוי
            const subscriberCategories = subscriberCategoriesText.split(',').map(cat => cat.trim());
            
            // בדיקת התאמה
            const result = correctJobsManager.matchCategory(jobCategory, subscriberCategories);
            
            // הצגת תוצאות
            const resultsDiv = document.getElementById('realTimeResults');
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = `
                <div style="background: ${result ? 'rgba(37, 211, 102, 0.1)' : 'rgba(255, 71, 87, 0.1)'}; 
                            padding: 15px; border-radius: 8px; 
                            border: 1px solid ${result ? 'rgba(37, 211, 102, 0.3)' : 'rgba(255, 71, 87, 0.3)'};">
                    <h4 style="color: ${result ? '#25D366' : '#ff4757'};">
                        ${result ? '✅ יש התאמה!' : '❌ אין התאמה'}
                    </h4>
                    <div style="margin-top: 10px; font-size: 0.9em;">
                        <div><strong>קטגוריית משרה:</strong> "${jobCategory}"</div>
                        <div><strong>קטגוריות מנוי:</strong> ${subscriberCategories.map(cat => `"${cat}"`).join(', ')}</div>
                        <div style="margin-top: 10px;">
                            <strong>הסבר:</strong> 
                            ${result ? 
                                'המערכת מצאה התאמה בין קטגוריית המשרה לקטגוריות המנוי על פי חוקי ההתאמה' : 
                                'לא נמצאה התאמה בין קטגוריית המשרה לקטגוריות המנוי'
                            }
                        </div>
                    </div>
                </div>
            `;
        }

        function clearTestInputs() {
            document.getElementById('testJobCategory').value = '';
            document.getElementById('testSubscriberCategories').value = '';
            document.getElementById('realTimeResults').style.display = 'none';
        }

        // ניתוח מפורט של התאמת משרה למנויים
        function analyzeJobMatching() {
            const jobNumber = document.getElementById('detailedJobSearch').value.trim();
            const resultsDiv = document.getElementById('detailedAnalysisResults');
            
            if (!jobNumber) {
                resultsDiv.innerHTML = '<div class="error">אנא הכנס מספר משרה</div>';
                resultsDiv.style.display = 'block';
                return;
            }

            resultsDiv.innerHTML = '<div class="loading">מנתח התאמות...</div>';
            resultsDiv.style.display = 'block';

            // חיפוש המשרה
            const job = correctJobsManager.findJobById(jobNumber);
            
            if (!job) {
                resultsDiv.innerHTML = `
                    <div class="error">
                        <i class="fas fa-exclamation-triangle"></i>
                        לא נמצאה משרה עם המספר: ${jobNumber}
                    </div>
                `;
                return;
            }

            // נרמול המשרה
            const normalizedJob = correctJobsManager.normalizeJob(job);
            const subscribers = adminPanel?.whatsappAlerts?.getSubscribers() || [];

            if (subscribers.length === 0) {
                resultsDiv.innerHTML = `
                    <div class="error">
                        <i class="fas fa-users-slash"></i>
                        אין מנויים במערכת. הוסף מנויים לבדיקה כדי לראות את ההתאמות.
                    </div>
                `;
                return;
            }

            // ניתוח מפורט לכל מנוי
            const detailedAnalysis = subscribers.map(subscriber => {
                const categoryMatch = correctJobsManager.matchCategory(normalizedJob.category, subscriber.categories);
                const areaMatch = correctJobsManager.matchArea(normalizedJob.region, subscriber.areas);
                const overallMatch = categoryMatch && areaMatch;

                return {
                    subscriber,
                    categoryMatch,
                    areaMatch,
                    overallMatch
                };
            });

            // הצגת התוצאות
            showDetailedAnalysis(normalizedJob, detailedAnalysis);
        }

        function showDetailedAnalysis(job, analysisResults) {
            const resultsDiv = document.getElementById('detailedAnalysisResults');
            
            const matchingSubscribers = analysisResults.filter(result => result.overallMatch);
            const nonMatchingSubscribers = analysisResults.filter(result => !result.overallMatch);

            resultsDiv.innerHTML = `
                <div style="background: rgba(246, 152, 152, 0.1); border: 1px solid rgba(246, 152, 152, 0.3); border-radius: 10px; padding: 20px;">
                    <h3 style="color: var(--primary-color); margin-bottom: 15px;">
                        <i class="fas fa-brain"></i> ניתוח מפורט - משרה ${job.jobNumber}
                    </h3>
                    
                    <!-- פרטי המשרה -->
                    <div style="background: rgba(246, 152, 152, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="color: var(--primary-color); margin-bottom: 10px;">📋 פרטי המשרה:</h4>
                        <div><strong>כותרת:</strong> ${job.title}</div>
                        <div><strong>קטגוריה:</strong> ${job.category}</div>
                        <div><strong>אזור:</strong> ${job.region}</div>
                        <div><strong>מספר:</strong> ${job.jobNumber}</div>
                    </div>

                    <!-- סיכום התאמות -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                        <div style="background: rgba(37, 211, 102, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(37, 211, 102, 0.3);">
                            <div style="font-size: 2em; font-weight: bold; color: #25D366; text-align: center;">${matchingSubscribers.length}</div>
                            <div style="text-align: center; color: #25D366;">מנויים מתאימים</div>
                        </div>
                        <div style="background: rgba(255, 71, 87, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(255, 71, 87, 0.3);">
                            <div style="font-size: 2em; font-weight: bold; color: #ff4757; text-align: center;">${nonMatchingSubscribers.length}</div>
                            <div style="text-align: center; color: #ff4757;">מנויים לא מתאימים</div>
                        </div>
                    </div>

                    ${matchingSubscribers.length > 0 ? `
                        <div style="margin-bottom: 20px;">
                            <h4 style="color: #25D366; margin-bottom: 15px;">
                                ✅ מנויים שיקבלו התראה (${matchingSubscribers.length})
                            </h4>
                            <div style="max-height: 300px; overflow-y: auto;">
                                ${matchingSubscribers.map(result => `
                                    <div style="background: rgba(37, 211, 102, 0.1); padding: 15px; margin: 10px 0; border-radius: 8px; border: 1px solid rgba(37, 211, 102, 0.3);">
                                        <div style="font-weight: bold; color: #25D366; margin-bottom: 8px;">
                                            📱 ${result.subscriber.phone} - ${result.subscriber.name || 'ללא שם'}
                                        </div>
                                        <div style="font-size: 0.9em; color: #666;">
                                            קטגוריות: ${result.subscriber.categories.join(', ')} | אזורים: ${result.subscriber.areas.join(', ')}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    ${nonMatchingSubscribers.length > 0 ? `
                        <div style="margin-bottom: 20px;">
                            <h4 style="color: #ff4757; margin-bottom: 15px;">
                                ❌ מנויים שלא יקבלו התראה (${nonMatchingSubscribers.length})
                            </h4>
                            <div style="max-height: 300px; overflow-y: auto;">
                                ${nonMatchingSubscribers.map(result => `
                                    <div style="background: rgba(255, 71, 87, 0.1); padding: 15px; margin: 10px 0; border-radius: 8px; border: 1px solid rgba(255, 71, 87, 0.3);">
                                        <div style="font-weight: bold; color: #ff4757; margin-bottom: 8px;">
                                            📱 ${result.subscriber.phone} - ${result.subscriber.name || 'ללא שם'}
                                        </div>
                                        <div style="font-size: 0.9em; color: #666;">
                                            קטגוריות: ${result.subscriber.categories.join(', ')} | אזורים: ${result.subscriber.areas.join(', ')}
                                            <br>סיבה: ${!result.categoryMatch ? 'לא התאמה בקטגוריה' : ''} ${!result.areaMatch ? 'לא התאמה באזור' : ''}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <!-- כפתורי פעולה -->
                    <div style="margin-top: 20px; text-align: center;">
                        ${matchingSubscribers.length > 0 ? `
                            <button class="btn" onclick="sendToAnalyzedSubscribers('${job.id}')">
                                <i class="fas fa-paper-plane"></i> שלח ל-${matchingSubscribers.length} מנויים מתאימים
                            </button>
                        ` : `
                            <div style="color: #999; font-style: italic;">
                                אין מנויים מתאימים לשליחה
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        function sendToAnalyzedSubscribers(jobId) {
            const job = correctJobsManager.findJobById(jobId);
            if (!job) return;

            const normalizedJob = correctJobsManager.normalizeJob(job);
            const subscribers = adminPanel?.whatsappAlerts?.getSubscribers() || [];
            const matchingSubscribers = correctJobsManager.findMatchingSubscribers(normalizedJob, subscribers);

            if (matchingSubscribers.length === 0) {
                alert('אין מנויים מתאימים');
                return;
            }

            // יצירת הודעה
            const jobUrl = `https://www.mayeshpo.co.il/`;

            const message = `🔥 משרה חדשה!
📋 ${normalizedJob.title}
📍 ${normalizedJob.region}
🎯 ${normalizedJob.category}

🌐 לפרטים נוספים:
${jobUrl}

🔍 באתר - חפש לפי מספר המשרה: ${normalizedJob.jobNumber}

בהצלחה! 💪`;

            // הצגת תצוגה מקדימה
            showPreview(message, matchingSubscribers, normalizedJob);
        }

        // יצירת טופס הוספת מנוי חדש
        function createNewSubscriberForm() {
            // טעינת קטגוריות
            const categoriesContainer = document.getElementById('newSubscriberCategories');
            if (categoriesContainer) {
                const categories = correctJobsManager.getCategories();
                categoriesContainer.innerHTML = '';
                
                categories.forEach(category => {
                    const label = document.createElement('label');
                    label.style.display = 'block';
                    label.style.margin = '5px';
                    label.style.cursor = 'pointer';
                    label.style.padding = '5px';
                    label.style.borderRadius = '5px';
                    label.style.transition = 'background-color 0.2s';
                    label.style.color = 'white';
                    
                    label.onmouseover = function() { this.style.backgroundColor = 'rgba(246, 152, 152, 0.1)'; };
                    label.onmouseout = function() { this.style.backgroundColor = 'transparent'; };
                    
                    label.innerHTML = `
                        <input type="checkbox" name="newCategories" value="${category}" style="margin-left: 8px;">
                        ${category}
                    `;
                    
                    categoriesContainer.appendChild(label);
                });
            }
            
            // טעינת אזורים
            const areasContainer = document.getElementById('newSubscriberAreas');
            if (areasContainer) {
                const areas = correctJobsManager.getAreas();
                areasContainer.innerHTML = '';
                
                areas.forEach(area => {
                    const label = document.createElement('label');
                    label.style.display = 'block';
                    label.style.margin = '5px';
                    label.style.cursor = 'pointer';
                    label.style.padding = '5px';
                    label.style.borderRadius = '5px';
                    label.style.transition = 'background-color 0.2s';
                    label.style.color = 'white';
                    
                    label.onmouseover = function() { this.style.backgroundColor = 'rgba(246, 152, 152, 0.1)'; };
                    label.onmouseout = function() { this.style.backgroundColor = 'transparent'; };
                    
                    label.innerHTML = `
                        <input type="checkbox" name="newAreas" value="${area}" style="margin-left: 8px;">
                        ${area}
                    `;
                    
                    areasContainer.appendChild(label);
                });
            }
            
            // הגבלת בחירת קטגוריות ואזורים
            limitCheckboxesSelection('newCategories', 3);
            limitCheckboxesSelection('newAreas', 3);
        }

        // הגבלת בחירת צ'קבוקסים
        function limitCheckboxesSelection(name, max) {
            const checkboxes = document.querySelectorAll(`input[name="${name}"]`);
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    const checked = document.querySelectorAll(`input[name="${name}"]:checked`);
                    if (checked.length >= max) {
                        checkboxes.forEach(cb => {
                            if (!cb.checked) cb.disabled = true;
                        });
                    } else {
                        checkboxes.forEach(cb => cb.disabled = false);
                    }
                });
            });
        }

        // הוספת מנוי חדש
        function addNewSubscriber() {
            const name = document.getElementById('newSubscriberName').value.trim();
            const phone = document.getElementById('newSubscriberPhone').value.trim();
            const categories = Array.from(document.querySelectorAll('input[name="newCategories"]:checked')).map(cb => cb.value);
            const areas = Array.from(document.querySelectorAll('input[name="newAreas"]:checked')).map(cb => cb.value);
            
            // ולידציה
            if (!name) {
                adminPanel?.showAlert('אנא הכנס שם מלא', 'error');
                return;
            }
            
            if (!phone) {
                adminPanel?.showAlert('אנא הכנס מספר טלפון', 'error');
                return;
            }
            
            if (categories.length === 0) {
                adminPanel?.showAlert('אנא בחר לפחות תחום עניין אחד', 'error');
                return;
            }
            
            if (areas.length === 0) {
                adminPanel?.showAlert('אנא בחר לפחות אזור אחד', 'error');
                return;
            }
            
            // ניקוי מספר טלפון
            let cleanPhone = phone.replace(/[^\d+]/g, '');
            if (cleanPhone.startsWith('0')) {
                cleanPhone = '+972' + cleanPhone.substring(1);
            }
            if (!cleanPhone.startsWith('+')) {
                cleanPhone = '+972' + cleanPhone;
            }
            
            // יצירת אובייקט מנוי חדש
            const newSubscriber = {
                id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                name: name,
                phone: cleanPhone,
                categories: categories,
                areas: areas,
                registrationDate: new Date().toISOString(),
                active: true,
                source: 'admin_panel'
            };
            
            // בדיקה אם המנוי כבר קיים
            const subscribers = adminPanel?.whatsappAlerts?.getSubscribers() || [];
            const exists = subscribers.some(sub => sub.phone === cleanPhone);
            
            if (exists) {
                if (!confirm(`מנוי עם מספר ${cleanPhone} כבר קיים במערכת. האם לעדכן את הפרטים?`)) {
                    return;
                }
                
                // עדכון מנוי קיים
                const index = subscribers.findIndex(sub => sub.phone === cleanPhone);
                if (index !== -1) {
                    subscribers[index] = {
                        ...subscribers[index],
                        name: name,
                        categories: categories,
                        areas: areas,
                        updatedAt: new Date().toISOString()
                    };
                    
                    // שמירת העדכון
                    adminPanel.whatsappAlerts.subscribers = subscribers;
                    adminPanel.saveSubscribers();
                    
                    adminPanel?.showAlert(`המנוי ${name} עודכן בהצלחה!`, 'success');
                }
            } else {
                // הוספת מנוי חדש
                adminPanel.whatsappAlerts.addSubscriber(newSubscriber);
                
                // שליחת התראה ישירה לבעל האתר
                adminPanel.whatsappAlerts.sendDirectAlert(newSubscriber);
                
                adminPanel?.showAlert(`המנוי ${name} נוסף בהצלחה!`, 'success');
            }
            
            // רענון התצוגה
            adminPanel.renderSubscribers();
            adminPanel.updateStats();
            adminPanel.loadSubscriberSelect();
            
            // ניקוי הטופס
            resetNewSubscriberForm();
        }

        // ניקוי טופס הוספת מנוי
        function resetNewSubscriberForm() {
            document.getElementById('newSubscriberName').value = '';
            document.getElementById('newSubscriberPhone').value = '';
            
            // איפוס תיבות הסימון
            document.querySelectorAll('input[name="newCategories"]').forEach(cb => {
                cb.checked = false;
                cb.disabled = false;
            });
            
            document.querySelectorAll('input[name="newAreas"]').forEach(cb => {
                cb.checked = false;
                cb.disabled = false;
            });
        }

        // אתחול הפאנל
        let adminPanel;
        document.addEventListener('DOMContentLoaded', function() {
            // המתן קצת לטעינה מלאה
            setTimeout(() => {
                adminPanel = new AdminPanel();
                
                console.log('🚀 פאנל ניהול מנויים הופעל בהצלחה!');
                console.log('📱 מספר הטלפון המעודכן: 0555504633');
                console.log('🎯 התאמה משופרת לזכר/נקבה עם סלאש (/)');
                console.log('📊 קטגוריות ואזורים נטענים דינמית');
            }, 1000);
            
            // יצירת טופס הוספת מנוי
            setTimeout(() => {
                createNewSubscriberForm();
            }, 1500);
            
            // עדכון אוטומטי כל 30 שניות
            setInterval(() => {
                if (adminPanel) {
                    adminPanel.updateStats();
                }
            }, 30000);
        });

        // סגירת מודלים בלחיצה על הרקע
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('preview-modal')) {
                e.target.remove();
            }
        });
// פונקציות סריקת משרות
function scanAllJobsForAllSubscribers() {
    const jobs = correctJobsManager.getAllJobs();
    const subscribers = adminPanel?.whatsappAlerts?.getSubscribers() || [];
    
    if (jobs.length === 0) {
        alert('❌ אין משרות לסריקה');
        return;
    }
    
    if (subscribers.length === 0) {
        alert('❌ אין מנויים במערכת');
        return;
    }

    console.log(`🔍 סורק ${jobs.length} משרות עבור ${subscribers.length} מנויים...`);
    
    let totalMatches = 0;
    const matchResults = [];

    jobs.forEach(job => {
        const normalizedJob = correctJobsManager.normalizeJob(job);
        const matchingSubscribers = correctJobsManager.findMatchingSubscribers(normalizedJob, subscribers);
        
        if (matchingSubscribers.length > 0) {
            totalMatches += matchingSubscribers.length;
            matchResults.push({
                job: normalizedJob,
                matches: matchingSubscribers.length,
                subscribers: matchingSubscribers
            });
        }
    });

    // הצגת תוצאות
    const resultsDiv = document.getElementById('jobScanResults');
    resultsDiv.style.display = 'block';
    resultsDiv.innerHTML = `
        <div style="background: rgba(37, 211, 102, 0.1); padding: 20px; border-radius: 10px; border: 1px solid rgba(37, 211, 102, 0.3);">
            <h3 style="color: #25D366; margin-bottom: 15px;">
                <i class="fas fa-check-circle"></i> תוצאות סריקה
            </h3>
            
            <div style="margin-bottom: 20px;">
                <div><strong>סה"כ משרות:</strong> ${jobs.length}</div>
                <div><strong>משרות עם התאמות:</strong> ${matchResults.length}</div>
                <div><strong>סה"כ התאמות:</strong> ${totalMatches}</div>
                <div><strong>מנויים במערכת:</strong> ${subscribers.length}</div>
            </div>

            ${matchResults.length > 0 ? `
                <h4 style="color: #25D366; margin-bottom: 10px;">💼 המשרות המתאימות ביותר:</h4>
                <div style="max-height: 300px; overflow-y: auto;">
                    ${matchResults
                        .sort((a, b) => b.matches - a.matches)
                        .slice(0, 10)
                        .map(result => `
                            <div style="background: rgba(246, 152, 152, 0.1); padding: 15px; margin: 10px 0; border-radius: 8px;">
                                <div style="font-weight: bold; color: var(--primary-color);">
                                    ${result.job.title} (${result.job.jobNumber})
                                </div>
                                <div style="font-size: 0.9em; margin-top: 5px;">
                                    📍 ${result.job.region} | 🎯 ${result.job.category}
                                </div>
<div style="color: #25D366; margin-top: 5px;">
    ✅ ${result.matches} מנויים מתאימים
</div>
<div style="margin-top: 10px;">
    <button class="btn btn-small" onclick="sendJobFromScanResults('${result.job.id}')">
        <i class="fas fa-paper-plane"></i> שלח ל-${result.matches} מנויים
    </button>
    <button class="btn btn-small btn-outline" onclick="previewJobFromScan('${result.job.id}')">
        <i class="fas fa-eye"></i> תצוגה מקדימה
    </button>
</div>
</div>
                        `).join('')}
                </div>
            ` : '<div style="color: #999;">לא נמצאו התאמות</div>'}
        </div>
    `;

    adminPanel?.showAlert(`✅ סריקה הושלמה! נמצאו ${totalMatches} התאמות`, 'success');
}

function scanNewJobsOnly() {
    // סימולציה של משרות חדשות (במציאות זה יהיה חיפוש לפי תאריך)
    const jobs = correctJobsManager.getAllJobs();
    const newJobs = jobs.slice(0, 3); // נניח ש-3 הראשונות הן חדשות
    
    const subscribers = adminPanel?.whatsappAlerts?.getSubscribers() || [];
    
    if (newJobs.length === 0) {
        alert('❌ אין משרות חדשות');
        return;
    }
    
    if (subscribers.length === 0) {
        alert('❌ אין מנויים במערכת');
        return;
    }

    console.log(`🔍 סורק ${newJobs.length} משרות חדשות עבור ${subscribers.length} מנויים...`);
    
    let totalMatches = 0;
    const matchResults = [];

    newJobs.forEach(job => {
        const normalizedJob = correctJobsManager.normalizeJob(job);
        const matchingSubscribers = correctJobsManager.findMatchingSubscribers(normalizedJob, subscribers);
        
        if (matchingSubscribers.length > 0) {
            totalMatches += matchingSubscribers.length;
            matchResults.push({
                job: normalizedJob,
                matches: matchingSubscribers.length,
                subscribers: matchingSubscribers
            });
        }
    });

    // הצגת תוצאות
    const resultsDiv = document.getElementById('jobScanResults');
    resultsDiv.style.display = 'block';
    resultsDiv.innerHTML = `
        <div style="background: rgba(23, 162, 184, 0.1); padding: 20px; border-radius: 10px; border: 1px solid rgba(23, 162, 184, 0.3);">
            <h3 style="color: #17a2b8; margin-bottom: 15px;">
                <i class="fas fa-clock"></i> תוצאות סריקת משרות חדשות
            </h3>
            
            <div style="margin-bottom: 20px;">
                <div><strong>משרות חדשות נסרקו:</strong> ${newJobs.length}</div>
                <div><strong>משרות עם התאמות:</strong> ${matchResults.length}</div>
                <div><strong>סה"כ התאמות:</strong> ${totalMatches}</div>
            </div>

            ${matchResults.length > 0 ? `
                <h4 style="color: #17a2b8; margin-bottom: 10px;">💼 משרות חדשות מתאימות:</h4>
                <div style="max-height: 300px; overflow-y: auto;">
                    ${matchResults.map(result => `
                        <div style="background: rgba(246, 152, 152, 0.1); padding: 15px; margin: 10px 0; border-radius: 8px;">
                            <div style="font-weight: bold; color: var(--primary-color);">
                                🆕 ${result.job.title} (${result.job.jobNumber})
                            </div>
                            <div style="font-size: 0.9em; margin-top: 5px;">
                                📍 ${result.job.region} | 🎯 ${result.job.category}
                            </div>
                            <div style="color: #25D366; margin-top: 5px;">
                                ✅ ${result.matches} מנויים מתאימים
                            </div>
                        </div>
                    `).join('')}
                </div>
            ` : '<div style="color: #999;">אין התאמות למשרות החדשות</div>'}
        </div>
    `;

    adminPanel?.showAlert(`✅ סריקת משרות חדשות הושלמה! ${totalMatches} התאמות`, 'success');
}

function showJobMatchingReport() {
    const jobs = correctJobsManager.getAllJobs();
    const subscribers = adminPanel?.whatsappAlerts?.getSubscribers() || [];
    
    if (jobs.length === 0 || subscribers.length === 0) {
        alert('צריך משרות ומנויים כדי ליצור דוח');
        return;
    }

    // יצירת דוח מפורט
    const categoryStats = {};
    const areaStats = {};
    let totalPossibleMatches = 0;
    let actualMatches = 0;

    jobs.forEach(job => {
        const normalizedJob = correctJobsManager.normalizeJob(job);
        const matchingSubscribers = correctJobsManager.findMatchingSubscribers(normalizedJob, subscribers);
        
        totalPossibleMatches += subscribers.length;
        actualMatches += matchingSubscribers.length;
        
        // סטטיסטיקות קטגוריות
        if (matchingSubscribers.length > 0) {
            categoryStats[normalizedJob.category] = (categoryStats[normalizedJob.category] || 0) + matchingSubscribers.length;
        }
        
        // סטטיסטיקות אזורים
        if (matchingSubscribers.length > 0) {
            areaStats[normalizedJob.region] = (areaStats[normalizedJob.region] || 0) + matchingSubscribers.length;
        }
    });

    const matchRate = ((actualMatches / totalPossibleMatches) * 100).toFixed(1);

    // הצגת הדוח
    const modal = document.createElement('div');
    modal.className = 'preview-modal';
    modal.innerHTML = `
        <div class="preview-content" style="max-width: 800px;">
            <h3><i class="fas fa-chart-line"></i> דוח התאמות מפורט</h3>
            
            <div style="margin: 20px 0;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div style="background: rgba(246, 152, 152, 0.1); padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 2em; font-weight: bold; color: var(--primary-color);">${jobs.length}</div>
                        <div>סה"כ משרות</div>
                    </div>
                    <div style="background: rgba(37, 211, 102, 0.1); padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 2em; font-weight: bold; color: #25D366;">${actualMatches}</div>
                        <div>התאמות</div>
                    </div>
                    <div style="background: rgba(255, 193, 7, 0.1); padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 2em; font-weight: bold; color: #ffc107;">${matchRate}%</div>
                        <div>אחוז התאמה</div>
                    </div>
                </div>

                <h4 style="color: var(--primary-color);">📊 התאמות לפי קטגוריות:</h4>
                <div style="max-height: 200px; overflow-y: auto; margin-bottom: 20px;">
                    ${Object.entries(categoryStats)
                        .sort((a, b) => b[1] - a[1])
                        .map(([category, count]) => `
                            <div style="background: rgba(246, 152, 152, 0.1); padding: 10px; margin: 5px 0; border-radius: 5px;">
                                <strong>${category}:</strong> ${count} התאמות
                            </div>
                        `).join('')}
                </div>

                <h4 style="color: var(--primary-color);">🗺️ התאמות לפי אזורים:</h4>
                <div style="max-height: 200px; overflow-y: auto;">
                    ${Object.entries(areaStats)
                        .sort((a, b) => b[1] - a[1])
                        .map(([area, count]) => `
                            <div style="background: rgba(37, 211, 102, 0.1); padding: 10px; margin: 5px 0; border-radius: 5px;">
                                <strong>${area}:</strong> ${count} התאמות
                            </div>
                        `).join('')}
                </div>
            </div>
            
            <button class="close-btn" onclick="this.parentElement.parentElement.remove()">
                <i class="fas fa-times"></i> סגור
            </button>
        </div>
    `;
    
    document.body.appendChild(modal);
}
        // פונקציות לשליחה מתוצאות הסריקה
function sendJobFromScanResults(jobId) {
    const job = correctJobsManager.findJobById(jobId);
    if (!job) {
        alert('❌ משרה לא נמצאה');
        return;
    }

    const normalizedJob = correctJobsManager.normalizeJob(job);
    const subscribers = adminPanel?.whatsappAlerts?.getSubscribers() || [];
    const matchingSubscribers = correctJobsManager.findMatchingSubscribers(normalizedJob, subscribers);

    if (matchingSubscribers.length === 0) {
        alert('❌ אין מנויים מתאימים');
        return;
    }

    // יצירת הודעה
    const jobUrl = `https://www.mayeshpo.co.il/`;
    const message = `🔥 משרה חדשה מתאימה עבורך!

📋 ${normalizedJob.title}
📍 ${normalizedJob.region}
🎯 ${normalizedJob.category}
🆔 מספר משרה: ${normalizedJob.jobNumber}

🌐 לפרטים מלאים ולהגשת מועמדות:
${jobUrl}

🔍 באתר - חפש לפי מספר המשרה: ${normalizedJob.jobNumber}

בהצלחה! 💪`;

    // שליחה ישירה לכל המנויים המתאימים
    let successCount = 0;
    
    matchingSubscribers.forEach(subscriber => {
        const phoneNumber = subscriber.phone.replace(/^0/, '972').replace(/\D/g, '');
        const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
        
        // פתיחת כל הקישורים (מגבלת דפדפן: בדרך כלל עד 5-10 טאבים)
        if (successCount < 5) {
            setTimeout(() => {
                window.open(whatsappUrl, '_blank');
            }, successCount * 1000); // השהייה של שנייה בין כל פתיחה
            successCount++;
        }
    });

    // הודעת הצלחה
    if (matchingSubscribers.length <= 5) {
        adminPanel?.showAlert(`✅ נפתחו ${successCount} חלונות WhatsApp לשליחה!`, 'success');
    } else {
        adminPanel?.showAlert(`✅ נפתחו ${successCount} חלונות WhatsApp מתוך ${matchingSubscribers.length} מנויים. השאר יש לשלוח ידנית.`, 'success');
        
        // הצגת רשימת המנויים הנוספים
        const remainingSubscribers = matchingSubscribers.slice(5);
        console.log('📱 מנויים נוספים לשליחה ידנית:');
        remainingSubscribers.forEach(sub => {
            console.log(`- ${sub.phone} (${sub.name || 'ללא שם'})`);
        });
    }

    // עדכון סטטיסטיקות
    const currentAlerts = parseInt(localStorage.getItem('whatsapp_total_alerts') || '0');
    localStorage.setItem('whatsapp_total_alerts', (currentAlerts + matchingSubscribers.length).toString());
    adminPanel?.updateStats();
}

function previewJobFromScan(jobId) {
    const job = correctJobsManager.findJobById(jobId);
    if (!job) {
        alert('❌ משרה לא נמצאה');
        return;
    }

    const normalizedJob = correctJobsManager.normalizeJob(job);
    const subscribers = adminPanel?.whatsappAlerts?.getSubscribers() || [];
    const matchingSubscribers = correctJobsManager.findMatchingSubscribers(normalizedJob, subscribers);

    if (matchingSubscribers.length === 0) {
        alert('❌ אין מנויים מתאימים');
        return;
    }

    // יצירת הודעה
    const jobUrl = `https://www.mayeshpo.co.il/`;
    const message = `🔥 משרה חדשה מתאימה עבורך!

📋 ${normalizedJob.title}
📍 ${normalizedJob.region}
🎯 ${normalizedJob.category}
🆔 מספר משרה: ${normalizedJob.jobNumber}

🌐 לפרטים מלאים ולהגשת מועמדות:
${jobUrl}

🔍 באתר - חפש לפי מספר המשרה: ${normalizedJob.jobNumber}

בהצלחה! 💪`;

    // הצגת תצוגה מקדימה
    const modal = document.createElement('div');
    modal.className = 'preview-modal';
    modal.innerHTML = `
        <div class="preview-content">
            <h3><i class="fas fa-eye"></i> תצוגה מקדימה - ${normalizedJob.title}</h3>
            
            <div style="margin: 15px 0;">
                <strong>משרה:</strong> ${normalizedJob.title} (${normalizedJob.jobNumber})<br>
                <strong>נמענים:</strong> ${matchingSubscribers.length} מנויים מתאימים
            </div>
            
            <h4>הודעה שתישלח:</h4>
            <div class="whatsapp-message">
                ${message.replace(/\n/g, '<br>')}
            </div>
            
            <h4>רשימת נמענים (${matchingSubscribers.length > 5 ? 'ראשונים 5' : 'כולם'}):</h4>
            <div style="max-height: 200px; overflow-y: auto; background: rgba(246, 152, 152, 0.1); padding: 10px; border-radius: 5px;">
                ${matchingSubscribers.slice(0, 5).map(sub => 
                    `<div>📱 ${sub.phone} - ${sub.name || 'ללא שם'}</div>`
                ).join('')}
                ${matchingSubscribers.length > 5 ? `<div style="color: #999; margin-top: 10px;">... ועוד ${matchingSubscribers.length - 5} מנויים</div>` : ''}
            </div>
            
            <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn" onclick="sendJobFromScanResults('${normalizedJob.id}'); this.closest('.preview-modal').remove();">
                    <i class="fas fa-paper-plane"></i> שלח לכל המנויים (${matchingSubscribers.length})
                </button>
                <button class="btn btn-outline" onclick="testJobLink('${normalizedJob.jobNumber}')">
                    <i class="fas fa-external-link-alt"></i> בדוק קישור
                </button>
                <button class="close-btn" onclick="this.parentElement.parentElement.parentElement.remove()">
                    <i class="fas fa-times"></i> סגור
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}
    </script>
</body>
</html>
