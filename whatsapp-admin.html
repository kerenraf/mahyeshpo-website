<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ניהול מנויי התראות WhatsApp - מה יש פה?</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700&display=swap');
        
        :root {
            --primary-color: #F69898;
            --primary-light: #ffb6c1;
            --primary-dark: #e58080;
            --whatsapp-color: #25D366;
            --dark-bg: #333333;
            --darker-bg: #222222;
            --text-light: #ffffff;
            --text-muted: #cccccc;
            --border-radius: 12px;
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Assistant', Arial, sans-serif;
        }

        body {
            background-color: #000;
            color: white;
            direction: rtl;
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            padding: 30px 0;
            background: linear-gradient(145deg, var(--dark-bg) 0%, var(--darker-bg) 100%);
            border-radius: var(--border-radius);
            margin-bottom: 30px;
        }

        .header h1 {
            color: var(--primary-color);
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            color: var(--text-muted);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            padding: 25px;
            border-radius: var(--border-radius);
            text-align: center;
            color: white;
            box-shadow: 0 4px 15px rgba(246, 152, 152, 0.3);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 5px;
            display: block;
        }

        .stat-label {
            font-size: 1rem;
            opacity: 0.9;
        }

        .admin-section, .section {
            background: linear-gradient(145deg, var(--dark-bg), var(--darker-bg));
            padding: 30px;
            border-radius: var(--border-radius);
            margin-bottom: 30px;
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
            border: 2px solid rgba(246, 152, 152, 0.2);
        }

        .section-header {
            margin-bottom: 20px;
        }

        .section-title, .section h2 {
            color: var(--primary-color);
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .btn {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: var(--transition);
            box-shadow: 0 4px 12px rgba(246,152,152,0.3);
        }

        .btn:hover {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary-color));
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(246,152,152,0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--whatsapp-color), #128C7E);
            box-shadow: 0 4px 12px rgba(37, 211, 102, 0.3);
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #128C7E, #0f6b5c);
            box-shadow: 0 6px 15px rgba(37, 211, 102, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545, #c82333);
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #c82333, #a71e2a);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label, .form-label {
            display: block;
            margin-bottom: 8px;
            color: var(--primary-color);
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea,
        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid rgba(246, 152, 152, 0.3);
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus,
        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(246, 152, 152, 0.1);
        }

        .search-filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(246, 152, 152, 0.05);
            border-radius: 10px;
            border: 1px solid rgba(246, 152, 152, 0.2);
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-label {
            color: var(--primary-color);
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .filter-control {
            padding: 10px;
            border: 1px solid rgba(246, 152, 152, 0.3);
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 0.9rem;
        }

        .filter-control:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        .subscribers-table {
            width: 100%;
            background: var(--darker-bg);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(246, 152, 152, 0.2);
        }

        .table-header {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            color: white;
            font-weight: bold;
        }

        .table-header, .table-row {
            display: grid;
            grid-template-columns: 1fr 1fr 2fr 2fr 1fr 1fr;
            padding: 15px;
            align-items: center;
            gap: 10px;
        }

        .table-row {
            border-bottom: 1px solid rgba(246, 152, 152, 0.1);
            transition: var(--transition);
        }

        .table-row:hover {
            background: rgba(246, 152, 152, 0.1);
        }

        .table-row:last-child {
            border-bottom: none;
        }

        .subscriber-name {
            font-weight: bold;
            color: var(--primary-color);
        }

        .subscriber-phone {
            font-family: monospace;
            background: rgba(246, 152, 152, 0.1);
            padding: 5px 8px;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .tag {
            background: rgba(37, 211, 102, 0.2);
            color: var(--whatsapp-color);
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            border: 1px solid rgba(37, 211, 102, 0.3);
        }

        .tag.area {
            background: rgba(246, 152, 152, 0.2);
            color: var(--primary-color);
            border-color: rgba(246, 152, 152, 0.3);
        }

        .date-text {
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .action-buttons-row {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            padding: 6px 10px;
            font-size: 0.8rem;
            min-width: auto;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--darker-bg);
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            border: 2px solid var(--primary-color);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 15px;
        }

        .modal-title {
            color: var(--primary-color);
            font-size: 1.5rem;
            font-weight: bold;
        }

        .close {
            color: var(--text-muted);
            font-size: 2rem;
            cursor: pointer;
            transition: var(--transition);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .close:hover {
            color: white;
            background: rgba(246, 152, 152, 0.1);
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
        }

        .alert-success {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }

        .alert-error {
            background: linear-gradient(135deg, #dc3545, #e74c3c);
            color: white;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
            color: var(--primary-color);
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            background: rgba(246, 152, 152, 0.1);
            border-radius: 25px;
            margin-bottom: 15px;
            border: 1px solid rgba(246, 152, 152, 0.3);
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-left: 10px;
        }

        .status-online {
            background: #2ed573;
        }

        .status-offline {
            background: #ff4757;
        }

        .status-loading {
            background: #ffa502;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .whatsapp-message {
            background: #dcf8c6;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-family: system-ui;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            color: #333;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error {
            background: #ff4757;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }

        .success {
            background: #2ed573;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }

        .preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .preview-content {
            background: var(--darker-bg);
            padding: 30px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            border: 2px solid var(--primary-color);
        }

        .close-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            float: right;
            margin-top: 15px;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .search-filters {
                grid-template-columns: 1fr;
            }
            
            .table-header, .table-row {
                grid-template-columns: 1fr;
                gap: 5px;
                padding: 10px;
            }
            
            .table-header {
                display: none;
            }
            
            .table-row {
                background: var(--dark-bg);
                margin-bottom: 10px;
                border-radius: 8px;
                border: none;
            }
            
            .table-row > div {
                padding: 5px 0;
            }
            
            .table-row > div:before {
                content: attr(data-label) ': ';
                font-weight: bold;
                color: var(--primary-color);
                margin-left: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- כותרת -->
        <div class="header">
            <h1><i class="fas fa-users-cog"></i> ניהול מנויי התראות WhatsApp</h1>
            <p>מערכת ניהול מתקדמת למנויי התראות משרות - מה יש פה?</p>
        </div>

        <!-- סטטיסטיקות -->
        <div class="stats-grid">
            <div class="stat-card">
                <span class="stat-number" id="totalSubscribers">0</span>
                <div class="stat-label">מנויים פעילים</div>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="totalAlerts">0</span>
                <div class="stat-label">התראות נשלחו</div>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="newThisWeek">0</span>
                <div class="stat-label">מנויים השבוע</div>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="categoriesCount">0</span>
                <div class="stat-label">קטגוריות פעילות</div>
            </div>
        </div>

        <!-- כלי ניהול -->
        <div class="admin-section">
            <div class="section-header">
                <h2 class="section-title"><i class="fas fa-tools"></i> כלי ניהול</h2>
                <div class="connection-status">
                    <span>סטטוס מערכת:</span>
                    <div id="system-status" class="status-indicator status-loading"></div>
                    <span id="status-text">מתחבר...</span>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="btn" onclick="exportSubscribers()">
                    <i class="fas fa-download"></i> ייצא מנויים
                </button>
                <label for="import-file" class="btn">
                    <i class="fas fa-upload"></i> ייבא מנויים
                </label>
                <input type="file" id="import-file" style="display: none;" accept=".json" onchange="importSubscribers(event)">
                <button class="btn btn-secondary" onclick="clearAllData()">
                    <i class="fas fa-trash"></i> נקה הכל
                </button>
                <button class="btn" onclick="generateReport()">
                    <i class="fas fa-chart-bar"></i> דוח מפורט
                </button>
                <button class="btn btn-secondary" onclick="refreshSubscribersList()">
                    <i class="fas fa-sync"></i> רענן רשימה
                </button>
                <button class="btn" onclick="addTestSubscribers()">
                    <i class="fas fa-users-plus"></i> הוסף מנויים לבדיקה
                </button>
            </div>
        </div>

        <!-- שליחה ממוקדת לפי מספר משרה -->
        <div class="admin-section">
            <div class="section-header">
                <h2 class="section-title"><i class="fas fa-search-plus"></i> שליחה ממוקדת לפי מספר משרה</h2>
            </div>
            
            <div class="form-group">
                <label for="jobSearchInput">מספר משרה (למשל: A-25821)</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="jobSearchInput" placeholder="הכנס מספר משרה לחיפוש..." style="flex: 1;">
                    <button class="btn" onclick="searchJobAndSend()">
                        <i class="fas fa-search"></i> חפש ושלח
                    </button>
                </div>
            </div>

            <div class="form-group">
                <label>או הכנס פרטי משרה ידנית:</label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <input type="text" id="manualJobTitle" placeholder="כותרת המשרה">
                    <input type="text" id="manualCompany" placeholder="שם החברה">
                    <select id="manualArea">
                        <option value="">בחר אזור</option>
                        <option value="מרכז">מרכז</option>
                        <option value="צפון">צפון</option>
                        <option value="דרום">דרום</option>
                        <option value="ירושלים והסביבה">ירושלים והסביבה</option>
                        <option value="כל הארץ">כל הארץ</option>
                    </select>
                    <select id="manualCategory">
                        <option value="">בחר קטגוריה</option>
                        <option value="לוגיסטיקה, מחסנים, שילוח ורכש">לוגיסטיקה, מחסנים, שילוח ורכש</option>
                        <option value="פיתוח ותוכנה">פיתוח ותוכנה</option>
                        <option value="מכירות ושיווק">מכירות ושיווק</option>
                        <option value="חינוך והוראה">חינוך והוראה</option>
                        <option value="מזון ומסעדנות">מזון ומסעדנות</option>
                    </select>
                </div>
                <button class="btn btn-secondary" onclick="sendManualJob()">
                    <i class="fas fa-paper-plane"></i> שלח משרה ידנית
                </button>
            </div>

            <div id="jobSearchResults" style="margin-top: 20px;"></div>
        </div>

        <!-- שליחה ישירה למנוי ספציפי -->
        <div class="admin-section">
            <div class="section-header">
                <h2 class="section-title"><i class="fas fa-user-plus"></i> שליחה ישירה למנוי ספציפי</h2>
            </div>
            
            <div class="form-group">
                <label for="subscriberSelect">בחר מנוי:</label>
                <select id="subscriberSelect">
                    <option value="">בחר מנוי מהרשימה...</option>
                </select>
            </div>

            <div class="form-group">
                <label for="directMessage">הודעה מותאמת אישית:</label>
                <textarea id="directMessage" rows="4" placeholder="כתוב הודעה מותאמת אישית למנוי..."></textarea>
            </div>

            <div class="action-buttons">
                <button class="btn" onclick="previewDirectMessage()">
                    <i class="fas fa-eye"></i> תצוגה מקדימה
                </button>
                <button class="btn btn-secondary" onclick="sendDirectMessage()">
                    <i class="fas fa-paper-plane"></i> שלח הודעה
                </button>
            </div>
        </div>
<!-- הוספת יכולת הוספת מנוי חדש למערכת הניהול -->
<!-- הוסף את הקוד הבא אחרי כלי הניהול, לפני החלק של "שליחה ממוקדת לפי מספר משרה" -->

<!-- סקציית הוספת מנוי חדש -->
<div class="admin-section">
    <div class="section-header">
        <h2 class="section-title"><i class="fas fa-user-plus"></i> הוספת מנוי חדש</h2>
    </div>
    
    <div class="form-group">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div>
                <label for="newSubscriberName" style="display: block; margin-bottom: 8px; font-weight: bold; color: var(--primary-color);">שם מלא *</label>
                <input type="text" id="newSubscriberName" style="width: 100%; padding: 12px; border: 2px solid rgba(246, 152, 152, 0.3); border-radius: 8px; background: rgba(255, 255, 255, 0.1); color: white;" placeholder="הכנס שם מלא" required>
            </div>
            <div>
                <label for="newSubscriberPhone" style="display: block; margin-bottom: 8px; font-weight: bold; color: var(--primary-color);">מספר טלפון *</label>
                <input type="tel" id="newSubscriberPhone" style="width: 100%; padding: 12px; border: 2px solid rgba(246, 152, 152, 0.3); border-radius: 8px; background: rgba(255, 255, 255, 0.1); color: white;" placeholder="050-1234567" required>
            </div>
        </div>
    </div>

    <div class="form-group">
        <label style="display: block; margin-bottom: 8px; font-weight: bold; color: var(--primary-color);">תחומי עניין *</label>
        <div style="max-height: 200px; overflow-y: auto; border: 2px solid rgba(246, 152, 152, 0.3); border-radius: 8px; padding: 10px; background: rgba(255, 255, 255, 0.05);">
            <div id="newSubscriberCategories" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));">
                <!-- קטגוריות יתווספו כאן דינמית -->
            </div>
        </div>
    </div>

    <div class="form-group">
        <label style="display: block; margin-bottom: 8px; font-weight: bold; color: var(--primary-color);">אזורי עניין *</label>
        <div style="max-height: 150px; overflow-y: auto; border: 2px solid rgba(246, 152, 152, 0.3); border-radius: 8px; padding: 10px; background: rgba(255, 255, 255, 0.05);">
            <div id="newSubscriberAreas" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));">
                <!-- אזורים יתווספו כאן דינמית -->
            </div>
        </div>
    </div>

    <div class="action-buttons">
        <button class="btn" onclick="addNewSubscriber()">
            <i class="fas fa-user-plus"></i> הוסף מנוי חדש
        </button>
        <button class="btn btn-outline" onclick="resetNewSubscriberForm()">
            <i class="fas fa-undo"></i> נקה טופס
        </button>
    </div>
</div>

        
        <!-- ניהול משרות מגיט -->
        <div class="admin-section">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fab fa-git-alt"></i> ניהול משרות מגיט
                </h2>
                <div style="font-size: 0.9em; color: #999; margin-top: 5px;">
                    <i class="fas fa-database"></i> מקור: data/jobs.json
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-secondary" onclick="refreshJobsFromGit()">
                    <i class="fas fa-sync-alt"></i> רענן מגיט
                </button>
                <button class="btn" onclick="checkGitConnection()">
                    <i class="fas fa-wifi"></i> בדוק חיבור
                </button>
                <button class="btn btn-secondary" onclick="showJobsStats()">
                    <i class="fas fa-chart-pie"></i> סטטיסטיקות משרות
                </button>
                <button class="btn" onclick="showRecentJobs()">
                    <i class="fas fa-clock"></i> משרות חדשות השבוע
                </button>
            </div>

            <!-- מחוון סטטוס חיבור -->
            <div id="git-connection-status" class="connection-status" style="margin-top: 15px;">
                <i class="fab fa-git-alt"></i>
                <span>חיבור לגיט:</span>
                <div id="git-status-indicator" class="status-indicator status-loading"></div>
                <span id="git-status-text">בודק חיבור...</span>
                <button class="btn" onclick="testGitConnection()" style="margin-right: auto; padding: 5px 10px; font-size: 0.8em;">
                    <i class="fas fa-vial"></i> בדיקה מהירה
                </button>
            </div>

            <!-- סטטיסטיקות משרות -->
            <div id="jobs-stats" style="margin-top: 15px; padding: 15px; background: rgba(246,152,152,0.05); border-radius: 8px; display: none;">
                <h4 style="color: var(--primary-color); margin-bottom: 10px;">
                    <i class="fas fa-chart-bar"></i> סטטיסטיקות משרות
                </h4>
                <div id="jobs-stats-content">טוען...</div>
            </div>

            <!-- כלי בדיקה ופיתוח -->
            <div style="margin-top: 20px; padding: 15px; background: rgba(37, 211, 102, 0.1); border-radius: 8px;">
                <h5 style="color: #25D366; margin-bottom: 15px;">
                    <i class="fas fa-flask"></i> כלי בדיקה ופיתוח
                </h5>
                
                <div class="action-buttons">
                    <button class="btn" onclick="analyzeCorrectJobsStructure()">
                        <i class="fas fa-microscope"></i> נתח מבנה משרות
                    </button>
                    <button class="btn btn-secondary" onclick="testJobSearchDemo()">
                        <i class="fas fa-search"></i> בדוק חיפוש
                    </button>
                    <button class="btn" onclick="showJobFormats()">
                        <i class="fas fa-list"></i> הצג פורמטים
                    </button>
                    <button class="btn btn-secondary" onclick="testMatchingDemo()">
                        <i class="fas fa-users"></i> בדוק התאמת מנויים
                    </button>
                    <button class="btn" onclick="testCategoryMatching()">
                        <i class="fas fa-vial"></i> בדוק קטגוריות
                    </button>
                </div>
            </div>
        </div>

        <!-- סקציית משרות חדשות -->
        <div id="recent-jobs-section" class="admin-section" style="display: none;">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-clock"></i> משרות חדשות השבוע
                </h2>
            </div>
            <div id="recent-jobs-content"></div>
        </div>

        <!-- חיפוש וסינון -->
        <div class="section">
            <h2><i class="fas fa-search"></i> רשימת מנויים</h2>
            
            <div class="search-filters">
                <div class="filter-group">
                    <label class="filter-label">חיפוש:</label>
                    <input type="text" class="filter-control" id="searchInput" placeholder="חפש לפי שם או טלפון...">
                </div>
                <div class="filter-group">
                    <label class="filter-label">קטגוריה:</label>
                    <select class="filter-control" id="filterCategory">
                        <option value="">כל הקטגוריות</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">אזור:</label>
                    <select class="filter-control" id="filterArea">
                        <option value="">כל האזורים</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">תאריך הרשמה:</label>
                    <select class="filter-control" id="filterDate">
                        <option value="">כל התאריכים</option>
                        <option value="today">היום</option>
                        <option value="week">השבוע</option>
                        <option value="month">החודש</option>
                    </select>
                </div>
            </div>

            <div id="subscribersCount" class="connection-status" style="margin-bottom: 20px;">
                <i class="fas fa-users"></i>
                <span>סה"כ מנויים: <strong id="totalCount">0</strong></span>
                <span>מוצגים: <strong id="visibleCount">0</strong></span>
            </div>

            <div id="subscribersList"></div>
        </div>

        <!-- סטטיסטיקות -->
        <div class="section">
            <h2><i class="fas fa-chart-bar"></i> סטטיסטיקות</h2>
            <div id="statsContainer" class="stats-grid">
                <!-- סטטיסטיקות יוצגו כאן -->
            </div>
        </div>
    </div>

    <script>
        // מערכת שמירה בקבצי JSON
        class JSONDataManager {
            constructor() {
                this.subscribersFile = 'data/subscribers.json';
                this.jobsFile = 'data/jobs.json';
                this.useLocalBackup = true;
            }

            // שמירת מנויים
            async saveSubscribers(subscribers) {
                try {
                    // ניסיון שמירה בשרת (אם יש API)
                    const response = await fetch('/api/save-subscribers', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ subscribers })
                    });

                    if (response.ok) {
                        console.log('✅ מנויים נשמרו בשרת בהצלחה');
                        
                        // גיבוי מקומי
                        if (this.useLocalBackup) {
                            localStorage.setItem('subscribers_backup', JSON.stringify(subscribers));
                        }
                        return true;
                    } else {
                        throw new Error('שגיאה בשמירה בשרת');
                    }
                } catch (error) {
                    console.warn('⚠️ שגיאה בשמירה בשרת, שומר מקומית:', error);
                    
                    // שמירה מקומית במקרה של שגיאה
                    localStorage.setItem('whatsapp_alerts_subscribers', JSON.stringify(subscribers));
                    return false;
                }
            }

            // טעינת מנויים
            async loadSubscribers() {
                try {
                    // נסיון טעינה מהשרת
                    const response = await fetch('/api/get-subscribers');
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log('✅ מנויים נטענו מהשרת');
                        return data.subscribers || [];
                    } else {
                        throw new Error('שגיאה בטעינה מהשרת');
                    }
                } catch (error) {
                    console.warn('⚠️ שגיאה בטעינה מהשרת, טוען מקומית:', error);
                    
                    // טעינה מקומית
                    const localData = localStorage.getItem('whatsapp_alerts_subscribers');
                    const backupData = localStorage.getItem('subscribers_backup');
                    
                    if (localData) {
                        return JSON.parse(localData);
                    } else if (backupData) {
                        return JSON.parse(backupData);
                    } else {
                        return [];
                    }
                }
            }

            // טעינת משרות מגיט
            async loadJobs() {
                try {
                    const response = await fetch(this.jobsFile);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const jobs = await response.json();
                    console.log(`✅ נטענו ${jobs.length} משרות מ-${this.jobsFile}`);
                    
                    // שמירה בגיבוי מקומי
                    localStorage.setItem('jobs_backup', JSON.stringify(jobs));
                    
                    return jobs;
                } catch (error) {
                    console.warn('⚠️ שגיאה בטעינת משרות מגיט:', error);
                    
                    // טעינה מגיבוי מקומי
                    const backupJobs = localStorage.getItem('jobs_backup');
                    if (backupJobs) {
                        console.log('🔄 טוען משרות מגיבוי מקומי');
                        return JSON.parse(backupJobs);
                    }
                    
                    return [];
                }
            }

            // בדיקת חיבור לשרת
            async testConnection() {
                try {
                    const response = await fetch('/api/health');
                    return response.ok;
                } catch (error) {
                    return false;
                }
            }
        }

        // מנהל משרות מותאם לפורמט הנכון
        class CorrectJobsManager {
            constructor() {
                this.dataManager = new JSONDataManager();
                this.jobs = [];
                this.lastUpdate = null;
                this.loadJobs();
            }

            async loadJobs() {
                try {
                    this.jobs = await this.dataManager.loadJobs();
                    this.lastUpdate = new Date();
                    console.log(`✅ נטענו ${this.jobs.length} משרות בפורמט הנכון`);
                } catch (error) {
                    console.error('❌ שגיאה בטעינת משרות:', error);
                }
            }

            // חיפוש משרה לפי מספר (תואם לפורמט החדש)
            findJobById(jobId) {
                if (!jobId || !this.jobs) return null;

                // ניקוי מספר המשרה
                const cleanJobId = jobId.toString().trim();
                
                // חיפוש במספר השדות הרלוונטיים
                const job = this.jobs.find(job => {
                    if (!job) return false;
                    
                    // חיפוש לפי jobNumber (השדה הנכון!)
                    if (job.jobNumber && job.jobNumber.toString().trim() === cleanJobId) {
                        return true;
                    }
                    
                    // חיפוש לפי id כגיבוי
                    if (job.id && job.id.toString().trim() === cleanJobId) {
                        return true;
                    }
                    
                    // חיפוש חלקי בכותרת או חברה
                    if (cleanJobId.length > 3) {
                        if (job.title && job.title.includes(cleanJobId)) return true;
                        if (job.company && job.company.includes(cleanJobId)) return true;
                    }
                    
                    return false;
                });

                if (job) {
                    console.log(`✅ נמצאה משרה: ${job.jobNumber} - ${job.title}`);
                } else {
                    console.log(`❌ לא נמצאה משרה עם המספר: ${cleanJobId}`);
                }

                return job;
            }

            // המרת משרה לפורמט תקני
            normalizeJob(job) {
                if (!job) return null;

                return {
                    id: job.jobNumber || job.id || 'unknown',
                    jobNumber: job.jobNumber || job.id || 'unknown', 
                    title: job.title || 'ללא כותרת',
                    company: job.company || 'לא צוין',
                    area: job.region || job.area || 'לא צוין',        // שימוש ב-region!
                    region: job.region || job.area || 'לא צוין',      // גם שדה נפרד
                    city: job.city || 'לא צוין',
                    category: job.category || 'אחר',
                    description: job.description || '',
                    requirements: job.requirements || '',
                    salary: job.salary || 'לפי ניסיון',
                    status: job.status || 'unknown',
                    featured: job.featured || false,
                    createdAt: job.createdAt || new Date().toISOString()
                };
            }

            // מציאת מנויים מתאימים
            findMatchingSubscribers(job, subscribers) {
                if (!job || !subscribers) return [];

                return subscribers.filter(subscriber => {
                    // התאמת קטגוריה משופרת
                    const categoryMatch = this.matchCategory(job.category, subscriber.categories);
                    
                    // התאמת אזור (שימוש ב-region!)
                    const areaMatch = this.matchArea(job.region || job.area, subscriber.areas);
                    
                    return categoryMatch && areaMatch;
                });
            }

            // התאמת קטגוריה משופרת
            matchCategory(jobCategory, subscriberCategories) {
                if (!jobCategory || !subscriberCategories) return false;
                
                const jobCat = jobCategory.toLowerCase();
                
                return subscriberCategories.some(subCat => {
                    const subCatLower = subCat.toLowerCase();
                    
                    // התאמה מדויקת
                    if (jobCat === subCatLower) return true;
                    
                    // התאמה חלקית
                    if (jobCat.includes(subCatLower) || subCatLower.includes(jobCat)) return true;
                    
                    // התאמה לפי מילות מפתח
                    return this.matchByKeywords(jobCat, subCatLower);
                });
            }

            // התאמת מילות מפתח
            matchByKeywords(jobCategory, subscriberCategory) {
                const keywordMap = {
                    'לוגיסטיקה': ['נהג', 'נהיגה', 'משאית', 'מנוף', 'הובלה', 'מחסן', 'שילוח'],
                    'נהיגה': ['לוגיסטיקה', 'משאית', 'מנוף', 'הובלה', 'תחבורה'],
                    'פיתוח': ['מפתח', 'תכנות', 'תוכנה', 'programmer', 'developer'],
                    'מכירות': ['שיווק', 'marketing', 'sales', 'מוכר'],
                    'חינוך': ['מורה', 'הוראה', 'מחנך', 'גננת']
                };

                for (const [key, keywords] of Object.entries(keywordMap)) {
                    if (jobCategory.includes(key) && keywords.some(k => subscriberCategory.includes(k))) {
                        return true;
                    }
                    if (subscriberCategory.includes(key) && keywords.some(k => jobCategory.includes(k))) {
                        return true;
                    }
                }

                return false;
            }

            // התאמת אזור
            matchArea(jobArea, subscriberAreas) {
                if (!jobArea || !subscriberAreas) return false;
                
                const jobAreaLower = jobArea.toLowerCase();
                
                return subscriberAreas.some(subArea => {
                    const subAreaLower = subArea.toLowerCase();
                    
                    return (
                        jobAreaLower === subAreaLower ||
                        jobAreaLower.includes(subAreaLower) ||
                        subAreaLower.includes(jobAreaLower) ||
                        subAreaLower === 'כל הארץ' ||
                        subAreaLower === 'אחר'
                    );
                });
            }

            // קבלת כל המשרות
            getAllJobs() {
                return this.jobs || [];
            }

            // סטטיסטיקות משרות
            getJobsStats() {
                if (!this.jobs || this.jobs.length === 0) {
                    return { total: 0, categories: {}, regions: {}, status: {} };
                }

                const stats = {
                    total: this.jobs.length,
                    categories: {},
                    regions: {},
                    status: {},
                    lastUpdate: this.lastUpdate
                };

                this.jobs.forEach(job => {
                    // סטטיסטיקות קטגוריות
                    const category = job.category || 'לא צוין';
                    stats.categories[category] = (stats.categories[category] || 0) + 1;

                    // סטטיסטיקות אזורים
                    const region = job.region || job.area || 'לא צוין';
                    stats.regions[region] = (stats.regions[region] || 0) + 1;

                    // סטטיסטיקות סטטוס
                    const status = job.status || 'לא צוין';
                    stats.status[status] = (stats.status[status] || 0) + 1;
                });

                return stats;
            }
        }

        // יצירת מנהל המשרות החדש
        const correctJobsManager = new CorrectJobsManager();
        const dataManager = new JSONDataManager();

        // פונקציות עזר גלובליות
        function searchJobById(jobId) {
            const job = correctJobsManager.findJobById(jobId);
            return job ? correctJobsManager.normalizeJob(job) : null;
        }

        // עדכון קטגוריות להתאים למערכת המשרות שלך
        const updatedJobCategories = [
            'לוגיסטיקה, מחסנים, שילוח ורכש',
            'פיתוח ותוכנה',
            'מכירות ושיווק', 
            'חינוך והוראה',
            'מזון ומסעדנות',
            'בריאות ורפואה',
            'בנייה והנדסה',
            'עיצוב ויצירה',
            'אבטחה ושמירה',
            'ניהול וכספים',
            'שירות לקוחות',
            'משאבי אנוש',
            'מדע הנדסה מחקר ופיתוח',
            'פיננסים וכלכלה',
            'סחר וקמעונאות',
            'תיירות ופנאי',
            'תקשורת ומדיא',
            'חקלאות וסביבה',
            'תחבורה ונהיגה',
            'אחר'
        ];

        const updatedJobAreas = [
            'מרכז',
            'צפון', 
            'דרום',
            'ירושלים והסביבה',
            'חיפה קריות והצפון',
            'שרון',
            'שפלה',
            'גליל',
            'נגב',
            'כל הארץ',
            'עבודה מהבית',
            'אחר'
        ];

        // מערכת ניהול מנויים מעודכנת
        class AdminPanel {
            constructor() {
                this.whatsappAlerts = null;
                this.dataManager = new JSONDataManager();
                this.currentFilter = {
                    category: '',
                    area: '',
                    date: '',
                    search: ''
                };
                this.init();
            }

            async init() {
                // טעינת מנויים מהשרת/קובץ
                await this.loadSubscribersFromServer();
                
                this.loadFilters();
                this.renderSubscribers();
                this.updateStats();
                this.attachEvents();
                this.updateSystemStatus();
                
                // טעינת רשימת מנויים לשליחה ישירה
                this.loadSubscriberSelect();
                
                // בדיקת חיבור גיט
                this.checkGitConnection();
                
                console.log('🔧 פאנל ניהול הופעל');
            }

            async loadSubscribersFromServer() {
                try {
                    const subscribers = await this.dataManager.loadSubscribers();
                    
                    // יצירת מערכת WhatsApp Alerts עם המנויים הקיימים
                    this.whatsappAlerts = {
                        subscribers: subscribers,
                        options: {
                            categories: updatedJobCategories,
                            areas: updatedJobAreas
                        },
                        getSubscribers: () => this.whatsappAlerts.subscribers,
                        addSubscriber: (subscriber) => {
                            this.whatsappAlerts.subscribers.push(subscriber);
                            this.saveSubscribers();
                        },
                        removeSubscriber: (phone) => {
                            this.whatsappAlerts.subscribers = this.whatsappAlerts.subscribers.filter(s => s.phone !== phone);
                            this.saveSubscribers();
                        },
                        createJobMessage: (jobData) => {
                            return `🔥 משרה חדשה!

📋 ${jobData.title}
🏢 ${jobData.company || 'לא צוין'}
📍 ${jobData.region || jobData.area}
🎯 ${jobData.category}

${jobData.description ? `💬 ${jobData.description}\n\n` : ''}לפרטים נוספים: https://www.mayeshpo.co.il

בהצלחה! 💪`;
                        },
                        sendJobAlert: (jobData) => {
                            const matchingSubscribers = correctJobsManager.findMatchingSubscribers(jobData, this.whatsappAlerts.subscribers);
                            
                            if (matchingSubscribers.length === 0) {
                                console.log('❌ אין מנויים מתאימים');
                                return false;
                            }

                            const message = this.whatsappAlerts.createJobMessage(jobData);
                            
                            matchingSubscribers.forEach(subscriber => {
                                const phoneNumber = subscriber.phone.replace(/^0/, '972').replace(/\D/g, '');
                                const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
                                console.log(`📱 שולח ל-${subscriber.phone}:`, whatsappUrl);
                            });
                            
                            return true;
                        }
                    };
                    
                    console.log(`✅ נטענו ${subscribers.length} מנויים מהשרת`);
                } catch (error) {
                    console.error('❌ שגיאה בטעינת מנויים:', error);
                    this.whatsappAlerts = {
                        subscribers: [],
                        options: {
                            categories: updatedJobCategories,
                            areas: updatedJobAreas
                        },
                        getSubscribers: () => [],
                        addSubscriber: () => {},
                        removeSubscriber: () => {},
                        createJobMessage: () => {},
                        sendJobAlert: () => false
                    };
                }
            }

            async saveSubscribers() {
                if (this.whatsappAlerts && this.whatsappAlerts.subscribers) {
                    await this.dataManager.saveSubscribers(this.whatsappAlerts.subscribers);
                }
            }

            async updateSystemStatus() {
                const statusIndicator = document.getElementById('system-status');
                const statusText = document.getElementById('status-text');
                
                try {
                    const isConnected = await this.dataManager.testConnection();
                    
                    if (isConnected) {
                        statusIndicator.className = 'status-indicator status-online';
                        statusText.textContent = 'מחובר לשרת';
                    } else {
                        statusIndicator.className = 'status-indicator status-offline';
                        statusText.textContent = 'עובד מקומית';
                    }
                } catch (error) {
                    statusIndicator.className = 'status-indicator status-offline';
                    statusText.textContent = 'בעיית חיבור';
                }
            }

            loadFilters() {
                const categoryFilter = document.getElementById('filterCategory');
                const areaFilter = document.getElementById('filterArea');
                
                // טעינת קטגוריות
                categoryFilter.innerHTML = '<option value="">כל הקטגוריות</option>';
                updatedJobCategories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    categoryFilter.appendChild(option);
                });

                // טעינת אזורים
                areaFilter.innerHTML = '<option value="">כל האזורים</option>';
                updatedJobAreas.forEach(area => {
                    const option = document.createElement('option');
                    option.value = area;
                    option.textContent = area;
                    areaFilter.appendChild(option);
                });
            }

            loadSubscriberSelect() {
                const select = document.getElementById('subscriberSelect');
                if (!select) return;
                
                const subscribers = this.whatsappAlerts ? this.whatsappAlerts.getSubscribers() : [];
                
                select.innerHTML = '<option value="">בחר מנוי מהרשימה...</option>';
                
                if (subscribers.length === 0) {
                    select.innerHTML += '<option value="" disabled>אין מנויים עדיין</option>';
                    return;
                }
                
                subscribers.forEach((subscriber, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = `${subscriber.phone} - ${subscriber.name || 'ללא שם'}`;
                    select.appendChild(option);
                });
            }

            attachEvents() {
                // חיפוש וסינון
                const searchInput = document.getElementById('searchInput');
                const filterCategory = document.getElementById('filterCategory');
                const filterArea = document.getElementById('filterArea');
                const filterDate = document.getElementById('filterDate');

                if (searchInput) searchInput.addEventListener('input', () => this.filterSubscribers());
                if (filterCategory) filterCategory.addEventListener('change', () => this.filterSubscribers());
                if (filterArea) filterArea.addEventListener('change', () => this.filterSubscribers());
                if (filterDate) filterDate.addEventListener('change', () => this.filterSubscribers());

                // מקלדת
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        this.closeAllModals();
                    }
                });
            }

            renderSubscribers() {
                const subscribers = this.getFilteredSubscribers();
                const container = document.getElementById('subscribersList');
                
                if (!subscribers || subscribers.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <i class="fas fa-users" style="font-size: 3em; margin-bottom: 20px; opacity: 0.3; color: var(--primary-color);"></i>
                            <h3>אין מנויים להצגה</h3>
                            <p>עדיין לא נרשמו מנויים במערכת או שהסינון מסתיר את כולם</p>
                            <button class="btn" onclick="addTestSubscribers()" style="margin-top: 15px;">
                                <i class="fas fa-users-plus"></i> הוסף מנויים לבדיקה
                            </button>
                        </div>
                    `;
                    
                    this.updateCounts(0, 0);
                    return;
                }

                const html = subscribers.map(subscriber => `
                    <div style="background: rgba(246, 152, 152, 0.1); border: 1px solid rgba(246, 152, 152, 0.3); border-radius: 8px; padding: 15px; margin-bottom: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div>
                                <div style="font-weight: bold; color: var(--primary-color);">${subscriber.name || 'ללא שם'}</div>
                                <div style="font-family: monospace; background: rgba(246, 152, 152, 0.2); padding: 2px 6px; border-radius: 4px; display: inline-block; margin-top: 5px;">${subscriber.phone}</div>
                            </div>
                            <div style="display: flex; gap: 5px;">
                                <button class="btn btn-small btn-secondary" onclick="contactSubscriber('${subscriber.phone}')" title="שלח הודעה">
                                    <i class="fab fa-whatsapp"></i>
                                </button>
                                <button class="btn btn-small btn-danger" onclick="removeSubscriber('${subscriber.phone}')" title="הסר מנוי">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                            <div>
                                <strong style="color: var(--primary-color);">קטגוריות:</strong><br>
                                <div style="display: flex; flex-wrap: wrap; gap: 3px; margin-top: 3px;">
                                    ${subscriber.categories ? subscriber.categories.map(cat => `<span style="background: rgba(37, 211, 102, 0.2); color: #25D366; padding: 2px 6px; border-radius: 10px; font-size: 0.8em;">${cat}</span>`).join('') : 'לא צוין'}
                                </div>
                            </div>
                            <div>
                                <strong style="color: var(--primary-color);">אזורים:</strong><br>
                                <div style="display: flex; flex-wrap: wrap; gap: 3px; margin-top: 3px;">
                                    ${subscriber.areas ? subscriber.areas.map(area => `<span style="background: rgba(246, 152, 152, 0.2); color: var(--primary-color); padding: 2px 6px; border-radius: 10px; font-size: 0.8em;">${area}</span>`).join('') : 'לא צוין'}
                                </div>
                            </div>
                        </div>
                        
                        <div style="font-size: 0.9em; color: #999;">
                            תאריך הרשמה: ${subscriber.registrationDate ? new Date(subscriber.registrationDate).toLocaleDateString('he-IL') : 'לא ידוע'}
                        </div>
                    </div>
                `).join('');

                container.innerHTML = html;
                
                // עדכון מונים
                const totalSubscribers = this.whatsappAlerts ? this.whatsappAlerts.getSubscribers().length : 0;
                this.updateCounts(totalSubscribers, subscribers.length);
            }

            updateCounts(total, visible) {
                const totalCount = document.getElementById('totalCount');
                const visibleCount = document.getElementById('visibleCount');
                
                if (totalCount) totalCount.textContent = total;
                if (visibleCount) visibleCount.textContent = visible;
            }

            getFilteredSubscribers() {
                let subscribers = this.whatsappAlerts ? this.whatsappAlerts.getSubscribers() : [];
                
                // סינון לפי קטגוריה
                const categoryFilter = document.getElementById('filterCategory');
                if (categoryFilter && categoryFilter.value) {
                    subscribers = subscribers.filter(sub => 
                        sub.categories && sub.categories.includes(categoryFilter.value)
                    );
                }

                // סינון לפי אזור
                const areaFilter = document.getElementById('filterArea');
                if (areaFilter && areaFilter.value) {
                    subscribers = subscribers.filter(sub => 
                        sub.areas && sub.areas.includes(areaFilter.value)
                    );
                }

                // סינון לפי תאריך
                const dateFilter = document.getElementById('filterDate');
                if (dateFilter && dateFilter.value) {
                    const now = new Date();
                    let filterDate;
                    
                    switch (dateFilter.value) {
                        case 'today':
                            filterDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                            break;
                        case 'week':
                            filterDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                            break;
                        case 'month':
                            filterDate = new Date(now.getFullYear(), now.getMonth(), 1);
                            break;
                    }
                    
                    if (filterDate) {
                        subscribers = subscribers.filter(sub => 
                            sub.registrationDate && new Date(sub.registrationDate) >= filterDate
                        );
                    }
                }

                // סינון לפי חיפוש טקסט
                const searchInput = document.getElementById('searchInput');
                if (searchInput && searchInput.value) {
                    const searchTerm = searchInput.value.toLowerCase();
                    subscribers = subscribers.filter(sub => 
                        (sub.name && sub.name.toLowerCase().includes(searchTerm)) ||
                        (sub.phone && sub.phone.includes(searchTerm)) ||
                        (sub.categories && sub.categories.some(cat => cat.toLowerCase().includes(searchTerm))) ||
                        (sub.areas && sub.areas.some(area => area.toLowerCase().includes(searchTerm)))
                    );
                }

                return subscribers;
            }

            filterSubscribers() {
                this.renderSubscribers();
            }

            updateStats() {
                const subscribers = this.whatsappAlerts ? this.whatsappAlerts.getSubscribers() : [];
                const container = document.getElementById('statsContainer');
                
                if (subscribers.length === 0) {
                    container.innerHTML = `
                        <div class="stat-card">
                            <span class="stat-number">0</span>
                            <div class="stat-label">סה"כ מנויים</div>
                        </div>
                    `;
                    
                    // עדכון הסטטיסטיקות העליונות
                    const totalSubscribersEl = document.getElementById('totalSubscribers');
                    const totalAlertsEl = document.getElementById('totalAlerts');
                    const newThisWeekEl = document.getElementById('newThisWeek');
                    const categoriesCountEl = document.getElementById('categoriesCount');
                    
                    if (totalSubscribersEl) totalSubscribersEl.textContent = '0';
                    if (totalAlertsEl) totalAlertsEl.textContent = '0';
                    if (newThisWeekEl) newThisWeekEl.textContent = '0';
                    if (categoriesCountEl) categoriesCountEl.textContent = '0';
                    
                    return;
                }

                // חישוב סטטיסטיקות
                const stats = {
                    total: subscribers.length,
                    active: subscribers.filter(s => s.active !== false).length,
                    categories: {},
                    areas: {},
                    recent: 0
                };

                const oneWeekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);

                subscribers.forEach(subscriber => {
                    // קטגוריות פופולריות
                    if (subscriber.categories) {
                        subscriber.categories.forEach(cat => {
                            stats.categories[cat] = (stats.categories[cat] || 0) + 1;
                        });
                    }
                    
                    // אזורים
                    if (subscriber.areas) {
                        subscriber.areas.forEach(area => {
                            stats.areas[area] = (stats.areas[area] || 0) + 1;
                        });
                    }
                    
                    // מנויים חדשים השבוע
                    if (subscriber.registrationDate) {
                        const regDate = new Date(subscriber.registrationDate);
                        if (regDate >= oneWeekAgo) {
                            stats.recent++;
                        }
                    }
                });

                // מציאת הקטגוריות והאזורים הפופולריים ביותר
                const topCategories = Object.entries(stats.categories)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 3);
                    
                const topAreas = Object.entries(stats.areas)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 3);

                const html = `
                    <div class="stat-card">
                        <span class="stat-number">${stats.total}</span>
                        <div class="stat-label">מנויים פעילים</div>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number">${stats.active}</span>
                        <div class="stat-label">מנויים רשומים</div>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number">${stats.recent}</span>
                        <div class="stat-label">מנויים השבוע</div>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number">${Object.keys(stats.categories).length}</span>
                        <div class="stat-label">קטגוריות פעילות</div>
                    </div>
                    
                    ${topCategories.length > 0 ? `
                        <div style="grid-column: 1 / -1; margin-top: 20px;">
                            <h4 style="color: var(--primary-color); margin-bottom: 15px;">
                                <i class="fas fa-chart-bar"></i> קטגוריות פופולריות
                            </h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                ${topCategories.map(([category, count]) => `
                                    <div style="background: rgba(246, 152, 152, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(246, 152, 152, 0.3);">
                                        <div style="font-weight: bold; color: var(--primary-color);">${category}</div>
                                        <div style="font-size: 1.5em; font-weight: bold; margin-top: 5px;">${count}</div>
                                        <div style="font-size: 0.9em; color: #666;">מנויים</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                `;

                container.innerHTML = html;
                
                // עדכון הסטטיסטיקות העליונות
                const totalSubscribersEl = document.getElementById('totalSubscribers');
                const totalAlertsEl = document.getElementById('totalAlerts');
                const newThisWeekEl = document.getElementById('newThisWeek');
                const categoriesCountEl = document.getElementById('categoriesCount');
                
                if (totalSubscribersEl) totalSubscribersEl.textContent = stats.total;
                if (totalAlertsEl) totalAlertsEl.textContent = localStorage.getItem('whatsapp_total_alerts') || '0';
                if (newThisWeekEl) newThisWeekEl.textContent = stats.recent;
                if (categoriesCountEl) categoriesCountEl.textContent = Object.keys(stats.categories).length;
            }

            async checkGitConnection() {
                const statusIndicator = document.getElementById('git-status-indicator');
                const statusText = document.getElementById('git-status-text');
                
                if (!statusIndicator || !statusText) return;
                
                statusIndicator.className = 'status-indicator status-loading';
                statusText.textContent = 'בודק חיבור...';
                
                try {
                    const response = await fetch('data/jobs.json', { method: 'HEAD' });
                    
                    if (response.ok) {
                        statusIndicator.className = 'status-indicator status-online';
                        statusText.textContent = 'מחובר לגיט';
                    } else {
                        throw new Error('קובץ לא נמצא');
                    }
                } catch (error) {
                    statusIndicator.className = 'status-indicator status-offline';
                    statusText.textContent = 'אין חיבור לגיט';
                }
            }

            // פונקציות עזר
            showAlert(message, type = 'info') {
                console.log(`${type.toUpperCase()}: ${message}`);
                
                // יצירת התראה ויזואלית
                const alert = document.createElement('div');
                alert.className = `alert alert-${type}`;
                alert.textContent = message;
                alert.style.display = 'block';
                alert.style.position = 'fixed';
                alert.style.top = '20px';
                alert.style.right = '20px';
                alert.style.zIndex = '9999';
                alert.style.maxWidth = '400px';
                
                document.body.appendChild(alert);
                
                setTimeout(() => {
                    alert.remove();
                }, 5000);
            }

            closeAllModals() {
                document.querySelectorAll('.modal, .preview-modal').forEach(modal => {
                    modal.remove();
                });
            }
        }

        // פונקציות גלובליות לטיפול במנויים
        function addTestSubscribers() {
            if (!adminPanel || !adminPanel.whatsappAlerts) {
                alert('המערכת לא מוכנה עדיין');
                return;
            }

            const testSubscribers = [
                {
                    id: Date.now() + 1,
                    name: 'יוסי כהן',
                    phone: '050-1234567',
                    categories: ['פיתוח ותוכנה', 'טכנולוגיה'],
                    areas: ['מרכז', 'תל אביב'],
                    registrationDate: new Date().toISOString(),
                    active: true
                },
                {
                    id: Date.now() + 2,
                    name: 'שרה לוי',
                    phone: '052-7654321',
                    categories: ['מכירות ושיווק', 'שירות לקוחות'],
                    areas: ['צפון', 'חיפה'],
                    registrationDate: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString(),
                    active: true
                },
                {
                    id: Date.now() + 3,
                    name: 'דוד אברהם',
                    phone: '054-9876543',
                    categories: ['לוגיסטיקה, מחסנים, שילוח ורכש', 'נהיגה'],
                    areas: ['דרום', 'כל הארץ'],
                    registrationDate: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString(),
                    active: true
                }
            ];

            testSubscribers.forEach(subscriber => {
                adminPanel.whatsappAlerts.addSubscriber(subscriber);
            });

            adminPanel.renderSubscribers();
            adminPanel.updateStats();
            adminPanel.loadSubscriberSelect();
            
            adminPanel.showAlert('נוספו 3 מנויים לבדיקה!', 'success');
        }

        function contactSubscriber(phone) {
            const message = 'שלום! אני יוצר/ת איתך קשר ממערכת התראות המשרות של "מה יש פה?". איך אני יכול/ה לעזור?';
            const phoneNumber = phone.replace(/^0/, '972').replace(/\D/g, '');
            const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }

        function removeSubscriber(phone) {
            if (confirm(`האם אתה בטוח שברצונך להסיר את המנוי ${phone}?`)) {
                adminPanel.whatsappAlerts.removeSubscriber(phone);
                adminPanel.renderSubscribers();
                adminPanel.updateStats();
                adminPanel.loadSubscriberSelect();
                adminPanel.showAlert('המנוי הוסר בהצלחה', 'success');
            }
        }

        // פונקציות למשרות
        function searchJobAndSend() {
            const jobNumber = document.getElementById('jobSearchInput').value.trim();
            const resultsDiv = document.getElementById('jobSearchResults');
            
            if (!jobNumber) {
                resultsDiv.innerHTML = '<div class="error">אנא הכנס מספר משרה</div>';
                return;
            }

            resultsDiv.innerHTML = '<div class="loading">מחפש משרה...</div>';

            // חיפוש המשרה
            const job = correctJobsManager.findJobById(jobNumber);
            
            if (!job) {
                resultsDiv.innerHTML = `
                    <div class="error">
                        <i class="fas fa-exclamation-triangle"></i>
                        לא נמצאה משרה עם המספר: ${jobNumber}
                        <br><small>בדוק שהמספר נכון או נסה חיפוש חלקי</small>
                    </div>
                `;
                return;
            }

            // נרמול המשרה
            const normalizedJob = correctJobsManager.normalizeJob(job);

            // חיפוש מנויים מתאימים
            const subscribers = adminPanel?.whatsappAlerts?.getSubscribers() || [];
            const matchingSubscribers = correctJobsManager.findMatchingSubscribers(normalizedJob, subscribers);

            // הצגת תוצאות
            resultsDiv.innerHTML = `
                <div class="success">
                    <h4><i class="fas fa-briefcase"></i> נמצאה משרה!</h4>
                    <div style="background: rgba(246, 152, 152, 0.1); padding: 15px; border-radius: 8px; margin: 10px 0; border: 1px solid rgba(246, 152, 152, 0.3);">
                        <strong>${normalizedJob.title}</strong><br>
                        <small>חברה: ${normalizedJob.company}</small><br>
                        <small>אזור: ${normalizedJob.region}</small><br>
                        <small>קטגוריה: ${normalizedJob.category}</small>
                    </div>
                    <p><i class="fas fa-users"></i> נמצאו ${matchingSubscribers.length} מנויים מתאימים</p>
                    ${matchingSubscribers.length > 0 ? 
                        `<button class="btn" onclick="sendToMatchingSubscribers('${normalizedJob.id}')">
                            <i class="fas fa-paper-plane"></i> שלח ל-${matchingSubscribers.length} מנויים
                        </button>` : 
                        '<p style="color: var(--primary-color);">אין מנויים מתאימים לפי הקטגוריה והאזור</p>'
                    }
                </div>
            `;
        }

        function sendToMatchingSubscribers(jobId) {
            const job = correctJobsManager.findJobById(jobId);
            if (!job) return;

            const normalizedJob = correctJobsManager.normalizeJob(job);
            const subscribers = adminPanel?.whatsappAlerts?.getSubscribers() || [];
            const matchingSubscribers = correctJobsManager.findMatchingSubscribers(normalizedJob, subscribers);

            if (matchingSubscribers.length === 0) {
                alert('אין מנויים מתאימים');
                return;
            }

            // יצירת הודעה
            const message = `🔥 משרה חדשה!

📋 ${normalizedJob.title}
🏢 ${normalizedJob.company}
📍 ${normalizedJob.region}
🎯 ${normalizedJob.category}

לפרטים נוספים: https://www.mayeshpo.co.il

בהצלחה! 💪`;

            // הצגת תצוגה מקדימה
            showPreview(message, matchingSubscribers, normalizedJob);
        }

        function showPreview(message, subscribers, job) {
            const modal = document.createElement('div');
            modal.className = 'preview-modal';
            modal.innerHTML = `
                <div class="preview-content">
                    <h3><i class="fas fa-eye"></i> תצוגה מקדימה</h3>
                    
                    <div style="margin: 15px 0;">
                        <strong>משרה:</strong> ${job.title}<br>
                        <strong>נמענים:</strong> ${subscribers.length} מנויים
                    </div>
                    
                    <h4>הודעה שתישלח:</h4>
                    <div class="whatsapp-message">
                        ${message.replace(/\n/g, '<br>')}
                    </div>
                    
                    <h4>רשימת נמענים:</h4>
                    <div style="max-height: 200px; overflow-y: auto; background: rgba(246, 152, 152, 0.1); padding: 10px; border-radius: 5px;">
                        ${subscribers.map(sub => 
                            `<div>📱 ${sub.phone} - ${sub.name || 'ללא שם'}</div>`
                        ).join('')}
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <button class="btn" onclick="confirmSendToAll('${job.id}')">
                            <i class="fas fa-paper-plane"></i> שלח לכל המנויים (${subscribers.length})
                        </button>
                        <button class="close-btn" onclick="this.parentElement.parentElement.parentElement.remove()">
                            <i class="fas fa-times"></i> סגור
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function confirmSendToAll(jobId) {
            // סימולציה של שליחה
            console.log(`📱 שולח הודעה לכל המנויים המתאימים למשרה ${jobId}`);
            
            // סגירת המודל
            document.querySelector('.preview-modal')?.remove();
            
            // הודעת הצלחה
            const resultsDiv = document.getElementById('jobSearchResults');
            resultsDiv.innerHTML = `
                <div class="success">
                    <i class="fas fa-check-circle"></i>
                    ההודעות נשלחו בהצלחה לכל המנויים המתאימים!
                </div>
            `;

            // עדכון סטטיסטיקות
            const currentAlerts = parseInt(localStorage.getItem('whatsapp_total_alerts') || '0');
            localStorage.setItem('whatsapp_total_alerts', (currentAlerts + 1).toString());
            adminPanel.updateStats();
        }

        function sendManualJob() {
            const title = document.getElementById('manualJobTitle').value.trim();
            const company = document.getElementById('manualCompany').value.trim();
            const area = document.getElementById('manualArea').value;
            const category = document.getElementById('manualCategory').value;
            
            if (!title || !company || !area || !category) {
                alert('אנא מלא את כל השדות');
                return;
            }

            // יצירת משרה ידנית
            const manualJob = {
                id: 'manual-' + Date.now(),
                jobNumber: 'MANUAL-' + Date.now(),
                title: title,
                company: company,
                area: area,
                region: area,
                category: category,
                description: 'משרה שהוכנסה ידנית',
                status: 'פעיל'
            };

            const normalizedJob = correctJobsManager.normalizeJob(manualJob);
            const subscribers = adminPanel?.whatsappAlerts?.getSubscribers() || [];
            const matchingSubscribers = correctJobsManager.findMatchingSubscribers(normalizedJob, subscribers);

            // הצגת תוצאות
            const resultsDiv = document.getElementById('jobSearchResults');
            resultsDiv.innerHTML = `
                <div class="success">
                    <h4><i class="fas fa-plus-circle"></i> משרה ידנית נוצרה!</h4>
                    <div style="background: rgba(246, 152, 152, 0.1); padding: 15px; border-radius: 8px; margin: 10px 0; border: 1px solid rgba(246, 152, 152, 0.3);">
                        <strong>${normalizedJob.title}</strong><br>
                        <small>חברה: ${normalizedJob.company}</small><br>
                        <small>אזור: ${normalizedJob.region}</small><br>
                        <small>קטגוריה: ${normalizedJob.category}</small>
                    </div>
                    <p><i class="fas fa-users"></i> נמצאו ${matchingSubscribers.length} מנויים מתאימים</p>
                    ${matchingSubscribers.length > 0 ? 
                        `<button class="btn" onclick="sendManualJobToSubscribers('${encodeURIComponent(JSON.stringify(normalizedJob))}')">
                            <i class="fas fa-paper-plane"></i> שלח ל-${matchingSubscribers.length} מנויים
                        </button>` : 
                        '<p style="color: var(--primary-color);">אין מנויים מתאימים לפי הקטגוריה והאזור</p>'
                    }
                </div>
            `;

            // ניקוי הטופס
            document.getElementById('manualJobTitle').value = '';
            document.getElementById('manualCompany').value = '';
            document.getElementById('manualArea').value = '';
            document.getElementById('manualCategory').value = '';
        }

        function sendManualJobToSubscribers(jobJson) {
            const job = JSON.parse(decodeURIComponent(jobJson));
            const subscribers = adminPanel?.whatsappAlerts?.getSubscribers() || [];
            const matchingSubscribers = correctJobsManager.findMatchingSubscribers(job, subscribers);

            const message = `🔥 משרה חדשה!

📋 ${job.title}
🏢 ${job.company}
📍 ${job.region}
🎯 ${job.category}

לפרטים נוספים: https://www.mayeshpo.co.il

בהצלחה! 💪`;

            showPreview(message, matchingSubscribers, job);
        }

        // פונקציות לשליחה ישירה
        function previewDirectMessage() {
            const subscriberIndex = document.getElementById('subscriberSelect').value;
            const message = document.getElementById('directMessage').value;
            
            if (!subscriberIndex || !message) {
                alert('אנא בחר מנוי והכנס הודעה');
                return;
            }

            const subscribers = adminPanel?.whatsappAlerts?.getSubscribers() || [];
            const subscriber = subscribers[subscriberIndex];
            
            if (!subscriber) {
                alert('מנוי לא נמצא');
                return;
            }

            const modal = document.createElement('div');
            modal.className = 'preview-modal';
            modal.innerHTML = `
                <div class="preview-content">
                    <h3><i class="fas fa-eye"></i> תצוגה מקדימה - הודעה ישירה</h3>
                    
                    <div style="margin: 15px 0;">
                        <strong>נמען:</strong> ${subscriber.phone} - ${subscriber.name || 'ללא שם'}
                    </div>
                    
                    <div class="whatsapp-message">
                        ${message.replace(/\n/g, '<br>')}
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <button class="btn" onclick="confirmDirectSend(${subscriberIndex}, '${message.replace(/'/g, "\\'")}')">
                            <i class="fas fa-paper-plane"></i> שלח הודעה
                        </button>
                        <button class="close-btn" onclick="this.parentElement.parentElement.parentElement.remove()">
                            <i class="fas fa-times"></i> סגור
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function confirmDirectSend(subscriberIndex, message) {
            const subscribers = adminPanel?.whatsappAlerts?.getSubscribers() || [];
            const subscriber = subscribers[subscriberIndex];
            
            if (!subscriber) {
                alert('שגיאה: מנוי לא נמצא');
                return;
            }

            // סימולציה של שליחה
            console.log(`📱 שולח הודעה ישירה ל-${subscriber.phone}:`, message);
            
            // סגירת המודל
            document.querySelector('.preview-modal')?.remove();
            
            // הודעת הצלחה
            const resultsDiv = document.getElementById('jobSearchResults');
            resultsDiv.innerHTML = `
                <div class="success">
                    <i class="fas fa-check-circle"></i>
                    הודעה נשלחה בהצלחה ל-${subscriber.phone}
                </div>
            `;
            
            // ניקוי הטופס
            document.getElementById('subscriberSelect').value = '';
            document.getElementById('directMessage').value = '';

            // עדכון סטטיסטיקות
            const currentAlerts = parseInt(localStorage.getItem('whatsapp_total_alerts') || '0');
            localStorage.setItem('whatsapp_total_alerts', (currentAlerts + 1).toString());
            adminPanel.updateStats();
        }

        function sendDirectMessage() {
            const subscriberIndex = document.getElementById('subscriberSelect').value;
            const message = document.getElementById('directMessage').value;
            
            if (!subscriberIndex || !message) {
                alert('אנא בחר מנוי והכנס הודעה');
                return;
            }

            confirmDirectSend(subscriberIndex, message);
        }

        // פונקציות כלליות
        function exportSubscribers() {
            const subscribers = adminPanel?.whatsappAlerts?.getSubscribers() || [];
            
            if (subscribers.length === 0) {
                alert('אין מנויים לייצוא');
                return;
        }

        // יצירת נתוני JSON
        const dataStr = JSON.stringify(subscribers, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        
        const link = document.createElement('a');
        link.href = URL.createObjectURL(dataBlob);
        link.download = `whatsapp_subscribers_${new Date().toISOString().split('T')[0]}.json`;
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        adminPanel?.showAlert(`ייצוא ${subscribers.length} מנויים הושלם!`, 'success');
    }

    function importSubscribers(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const importedData = JSON.parse(e.target.result);
                
                if (!Array.isArray(importedData)) {
                    throw new Error('קובץ JSON חייב להכיל מערך של מנויים');
                }

                let imported = 0;
                let skipped = 0;
                
                const existingSubscribers = adminPanel?.whatsappAlerts?.getSubscribers() || [];
                
                importedData.forEach(subscriber => {
                    // בדיקה שהמנוי תקין
                    if (subscriber.phone && subscriber.name) {
                        // בדיקה שהמספר לא קיים
                        if (!existingSubscribers.find(sub => sub.phone === subscriber.phone)) {
                            // הוספת שדות חסרים
                            subscriber.id = subscriber.id || Date.now() + Math.random();
                            subscriber.registrationDate = subscriber.registrationDate || new Date().toISOString();
                            subscriber.categories = subscriber.categories || ['אחר'];
                            subscriber.areas = subscriber.areas || ['כל הארץ'];
                            subscriber.active = subscriber.active !== false;
                            
                            adminPanel.whatsappAlerts.addSubscriber(subscriber);
                            imported++;
                        } else {
                            skipped++;
                        }
                    }
                });

                adminPanel.renderSubscribers();
                adminPanel.updateStats();
                adminPanel.loadSubscriberSelect();

                adminPanel?.showAlert(`יובאו ${imported} מנויים חדשים. ${skipped} מנויים קיימים דולגו.`, 'success');
            } catch (error) {
                adminPanel?.showAlert('שגיאה בקריאת הקובץ: ' + error.message, 'error');
            }
        };
        
        reader.readAsText(file);
        event.target.value = ''; // ניקוי השדה
    }

    function clearAllData() {
        const message = 'האם אתה בטוח שברצונך למחוק את כל הנתונים?\n\n• כל המנויים יימחקו\n• כל הסטטיסטיקות יאופסו\n\nפעולה זו לא ניתנת לביטול!';
        
        if (confirm(message)) {
            if (confirm('זוהי אזהרה אחרונה! האם אתה בטוח לגמרי?')) {
                // מחיקת נתונים
                localStorage.removeItem('whatsapp_alerts_subscribers');
                localStorage.removeItem('whatsapp_total_alerts');
                localStorage.removeItem('subscribers_backup');
                
                // איפוס המערכת
                if (adminPanel?.whatsappAlerts) {
                    adminPanel.whatsappAlerts.subscribers = [];
                }
                
                // עדכון תצוגה
                adminPanel?.renderSubscribers();
                adminPanel?.updateStats();
                adminPanel?.loadSubscriberSelect();
                
                adminPanel?.showAlert('כל הנתונים נמחקו בהצלחה', 'success');
            }
        }
    }

    function generateReport() {
        const subscribers = adminPanel?.whatsappAlerts?.getSubscribers() || [];
        
        if (subscribers.length === 0) {
            alert('אין נתונים ליצירת דוח');
            return;
        }

        // חישוב סטטיסטיקות
        const categoryStats = {};
        const areaStats = {};
        const monthlyStats = {};

        subscribers.forEach(subscriber => {
            // סטטיסטיקות קטגוריות
            if (subscriber.categories) {
                subscriber.categories.forEach(cat => {
                    categoryStats[cat] = (categoryStats[cat] || 0) + 1;
                });
            }
            
            // סטטיסטיקות אזורים
            if (subscriber.areas) {
                subscriber.areas.forEach(area => {
                    areaStats[area] = (areaStats[area] || 0) + 1;
                });
            }
            
            // סטטיסטיקות חודשיות
            if (subscriber.registrationDate) {
                const month = new Date(subscriber.registrationDate).toISOString().slice(0, 7);
                monthlyStats[month] = (monthlyStats[month] || 0) + 1;
            }
        });

        // יצירת הדוח
        const now = new Date();
        const totalAlerts = localStorage.getItem('whatsapp_total_alerts') || '0';
        
        let report = `דוח מפורט - מערכת התראות WhatsApp "מה יש פה?"\n`;
        report += `תאריך יצירת הדוח: ${now.toLocaleDateString('he-IL')} ${now.toLocaleTimeString('he-IL')}\n`;
        report += `${'='.repeat(60)}\n\n`;
        
        // סטטיסטיקות כלליות
        report += `📊 סטטיסטיקות כלליות:\n`;
        report += `• סה"כ מנויים פעילים: ${subscribers.length}\n`;
        report += `• סה"כ התראות נשלחו: ${totalAlerts}\n`;
        report += `• ממוצע התראות למנוי: ${(parseInt(totalAlerts) / Math.max(subscribers.length, 1)).toFixed(1)}\n\n`;
        
        // התפלגות לפי קטגוריות
        report += `📈 התפלגות לפי קטגוריות:\n`;
        Object.entries(categoryStats)
            .sort((a, b) => b[1] - a[1])
            .forEach(([cat, count]) => {
                const percentage = ((count / subscribers.length) * 100).toFixed(1);
                report += `• ${cat}: ${count} מנויים (${percentage}%)\n`;
            });
        
        // התפלגות לפי אזורים
        report += `\n🗺️ התפלגות לפי אזורים:\n`;
        Object.entries(areaStats)
            .sort((a, b) => b[1] - a[1])
            .forEach(([area, count]) => {
                const percentage = ((count / subscribers.length) * 100).toFixed(1);
                report += `• ${area}: ${count} מנויים (${percentage}%)\n`;
            });
        
        // התפלגות חודשית
        report += `\n📅 התפלגות הרשמות לפי חודשים:\n`;
        Object.entries(monthlyStats)
            .sort((a, b) => b[0].localeCompare(a[0]))
            .slice(0, 6) // 6 חודשים אחרונים
            .forEach(([month, count]) => {
                const monthName = new Date(month + '-01').toLocaleDateString('he-IL', { year: 'numeric', month: 'long' });
                report += `• ${monthName}: ${count} הרשמות\n`;
            });

        // הצגת הדוח
        const modal = document.createElement('div');
        modal.className = 'preview-modal';
        modal.innerHTML = `
            <div class="preview-content" style="max-width: 700px;">
                <h3><i class="fas fa-chart-bar"></i> דוח סטטיסטיקות מפורט</h3>
                
                <div style="margin: 20px 0;">
                    <pre style="color: white; white-space: pre-wrap; line-height: 1.6; background: rgba(246, 152, 152, 0.1); padding: 20px; border-radius: 8px; max-height: 400px; overflow-y: auto; border: 1px solid rgba(246, 152, 152, 0.3);">${report}</pre>
                </div>
                
                <div style="display: flex; gap: 15px; justify-content: center; margin-top: 20px;">
                    <button onclick="navigator.clipboard.writeText(\`${report.replace(/`/g, '\\`')}\`).then(() => alert('דוח הועתק ללוח!'))" class="btn">
                        <i class="fas fa-copy"></i> העתק דוח
                    </button>
                    <button onclick="downloadReport(\`${report.replace(/`/g, '\\`').replace(/\n/g, '\\n')}\`)" class="btn btn-secondary">
                        <i class="fas fa-download"></i> הורד דוח
                    </button>
                    <button onclick="this.closest('.preview-modal').remove()" class="close-btn">
                        <i class="fas fa-times"></i> סגור
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
    }

    function downloadReport(reportText) {
        const blob = new Blob(['\uFEFF' + reportText], { type: 'text/plain;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        
        link.setAttribute('href', url);
        link.setAttribute('download', `whatsapp_report_${new Date().toISOString().split('T')[0]}.txt`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        URL.revokeObjectURL(url);
    }

    function refreshSubscribersList() {
        console.log('🔄 מרענן רשימת מנויים...');
        
        // עדכון הטבלה
        if (adminPanel) {
            adminPanel.renderSubscribers();
            adminPanel.updateStats();
            adminPanel.loadSubscriberSelect();
        }
        
        adminPanel?.showAlert('✅ רשימת המנויים רועננה!', 'success');
    }

    // פונקציות לכלי פיתוח
    function analyzeCorrectJobsStructure() {
        const jobs = correctJobsManager.getAllJobs();
        
        if (!jobs || jobs.length === 0) {
            console.log('❌ אין משרות לניתוח');
            return;
        }

        console.log(`🔍 ניתוח מבנה של ${jobs.length} משרות:`);
        
        // ניתוח השדות הקיימים
        const fieldAnalysis = {};
        const sampleJob = jobs[0];
        
        Object.keys(sampleJob).forEach(field => {
            const valuesSet = new Set();
            jobs.slice(0, 10).forEach(job => {
                if (job[field]) valuesSet.add(job[field]);
            });
            
            fieldAnalysis[field] = {
                type: typeof sampleJob[field],
                sampleValues: Array.from(valuesSet).slice(0, 3),
                totalFound: jobs.filter(job => job[field]).length
            };
        });

        console.table(fieldAnalysis);
        
        // דוגמת משרה מלאה
        console.log('📝 דוגמת משרה מלאה:');
        console.log(JSON.stringify(sampleJob, null, 2));
        
        // בדיקת איכות נתונים
        const qualityReport = {
            totalJobs: jobs.length,
            withJobNumber: jobs.filter(j => j.jobNumber).length,
            withTitle: jobs.filter(j => j.title).length,
            withCategory: jobs.filter(j => j.category).length,
            withRegion: jobs.filter(j => j.region || j.area).length,
            activeJobs: jobs.filter(j => j.status === 'פעיל').length
        };
        
        console.log('📊 דוח איכות נתונים:');
        console.table(qualityReport);
        
        return qualityReport;
    }

    function testJobSearchDemo() {
        console.log('🧪 התחלת בדיקת מערכת החיפוש...');
        
        const testCases = ['A-25821', '12345', 'משאית', 'Full Stack'];
        
        testCases.forEach(testCase => {
            console.log(`\n--- בדיקה: ${testCase} ---`);
            const job = correctJobsManager.findJobById(testCase);
            
            if (job) {
                console.log('✅ משרה נמצאה:');
                console.log(`   מספר: ${job.jobNumber}`);
                console.log(`   כותרת: ${job.title}`);
                console.log(`   קטגוריה: ${job.category}`);
                console.log(`   אזור: ${job.region || job.area}`);
                console.log(`   סטטוס: ${job.status}`);
            } else {
                console.log('❌ משרה לא נמצאה');
            }
        });
        
        console.log('\n✅ בדיקת החיפוש הושלמה - ראה תוצאות בקונסול');
    }

    function showJobFormats() {
        const modal = document.createElement('div');
        modal.className = 'preview-modal';
        modal.innerHTML = `
            <div class="preview-content">
                <h3><i class="fas fa-list"></i> פורמטים נתמכים למשרות</h3>
                
                <h4>📋 שדות חובה:</h4>
                <pre style="background: rgba(246, 152, 152, 0.1); padding: 10px; border-radius: 5px; border: 1px solid rgba(246, 152, 152, 0.3);">
{
  "jobNumber": "A-25821",
  "title": "נהג/ת משאית מנוף מעל 15 טון",
  "category": "לוגיסטיקה, מחסנים, שילוח ורכש",
  "region": "דרום",
  "city": "אשדוד",
  "status": "פעיל"
}</pre>

                <h4>📋 שדות אופציונליים:</h4>
                <pre style="background: rgba(246, 152, 152, 0.1); padding: 10px; border-radius: 5px; border: 1px solid rgba(246, 152, 152, 0.3);">
{
  "company": "שם החברה",
  "description": "תיאור המשרה",
  "requirements": "דרישות",
  "salary": "שכר",
  "featured": false
}</pre>

                <h4>🔍 שדות חיפוש:</h4>
                <ul style="color: white;">
                    <li><strong>jobNumber</strong> - מספר המשרה הרשמי</li>
                    <li><strong>title</strong> - כותרת המשרה</li>
                    <li><strong>company</strong> - שם החברה</li>
                    <li><strong>region</strong> - אזור גיאוגרפי</li>
                    <li><strong>category</strong> - קטגורית המשרה</li>
                </ul>

                <button class="close-btn" onclick="this.parentElement.parentElement.remove()">
                    <i class="fas fa-times"></i> סגור
                </button>
            </div>
        `;
        
        document.body.appendChild(modal);
    }

    function testMatchingDemo() {
        const jobs = correctJobsManager.getAllJobs();
        const subscribers = adminPanel?.whatsappAlerts?.getSubscribers() || [];
        
        if (jobs.length === 0 || subscribers.length === 0) {
            alert('צריך משרות ומנויים כדי לבדוק התאמה');
            return;
        }

        const testJob = jobs[0];
        const normalizedJob = correctJobsManager.normalizeJob(testJob);
        const matches = correctJobsManager.findMatchingSubscribers(normalizedJob, subscribers);

        const modal = document.createElement('div');
        modal.className = 'preview-modal';
        modal.innerHTML = `
            <div class="preview-content">
                <h3><i class="fas fa-users"></i> בדיקת התאמת מנויים</h3>
                
                <h4>📋 משרה לבדיקה:</h4>
                <div style="background: rgba(246, 152, 152, 0.1); padding: 15px; border-radius: 8px; margin: 10px 0; border: 1px solid rgba(246, 152, 152, 0.3);">
                    <strong>${normalizedJob.title}</strong><br>
                    <small>קטגוריה: ${normalizedJob.category}</small><br>
                    <small>אזור: ${normalizedJob.region}</small>
                </div>

                <h4>👥 מנויים מתאימים (${matches.length}):</h4>
                <div style="max-height: 200px; overflow-y: auto;">
                    ${matches.length > 0 ? 
                        matches.map(sub => `
                            <div style="background: rgba(246, 152, 152, 0.1); padding: 10px; margin: 5px 0; border-radius: 5px;">
                                📱 ${sub.phone} - ${sub.name || 'ללא שם'}<br>
                                <small>קטגוריות: ${sub.categories.join(', ')}</small><br>
                                <small>אזורים: ${sub.areas.join(', ')}</small>
                            </div>
                        `).join('') : 
                        '<p>אין מנויים מתאימים</p>'
                    }
                </div>

                <h4>📊 סיכום:</h4>
                <p>מתוך ${subscribers.length} מנויים, ${matches.length} מתאימים למשרה זו</p>

                <button class="close-btn" onclick="this.parentElement.parentElement.remove()">
                    <i class="fas fa-times"></i> סגור
                </button>
            </div>
        `;
        
        document.body.appendChild(modal);
    }

    function testCategoryMatching() {
        const testCases = [
            {
                jobCategory: 'לוגיסטיקה, מחסנים, שילוח ורכש',
                subscriberCategories: ['לוגיסטיקה'],
                expected: true
            },
            {
                jobCategory: 'לוגיסטיקה, מחסנים, שילוח ורכש',
                subscriberCategories: ['נהיגה'],
                expected: true
            },
            {
                jobCategory: 'פיתוח ותוכנה',
                subscriberCategories: ['מפתח'],
                expected: true
            }
        ];
        
        console.log('🧪 בדיקת מערכת התאמת קטגוריות:');
        
        testCases.forEach((test, index) => {
            const result = correctJobsManager.matchCategory(test.jobCategory, test.subscriberCategories);
            const status = result === test.expected ? '✅' : '❌';
            
            console.log(`${status} בדיקה ${index + 1}:`);
            console.log(`  משרה: ${test.jobCategory}`);
            console.log(`  מנוי: ${test.subscriberCategories.join(', ')}`);
            console.log(`  תוצאה: ${result} (צפוי: ${test.expected})`);
        });
    }

    function checkGitConnection() {
        adminPanel?.checkGitConnection();
    }

    function refreshJobsFromGit() {
        correctJobsManager?.loadJobs();
        adminPanel?.showAlert('משרות רועננו מגיט', 'success');
    }

    function showJobsStats() {
        const stats = correctJobsManager.getJobsStats();
        const statusDiv = document.getElementById('jobs-stats');
        const contentDiv = document.getElementById('jobs-stats-content');
        
        if (!statusDiv || !contentDiv) return;
        
        if (stats.total === 0) {
            contentDiv.innerHTML = `
                <div style="color: #dc3545; text-align: center; padding: 20px;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 10px;"></i>
                    <h4>אין משרות טעונות</h4>
                    <p>בדוק שהקובץ data/jobs.json קיים ונגיש</p>
                    <button onclick="refreshJobsFromGit()" class="btn btn-secondary" style="margin-top: 10px;">
                        <i class="fas fa-sync-alt"></i> נסה שוב
                    </button>
                </div>
            `;
        } else {
            const topCategories = Object.entries(stats.categories)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
                
            const topAreas = Object.entries(stats.regions)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            contentDiv.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                    <div>
                        <h5 style="color: var(--primary-color); margin-bottom: 10px;">
                            <i class="fas fa-briefcase"></i> סה"כ משרות: ${stats.total}
                        </h5>
                        <div style="color: #25D366;">
                            <i class="fas fa-star"></i> פעילות: ${stats.status['פעיל'] || 0}
                        </div>
                        <div style="margin-top: 10px; font-size: 0.9em; color: #999;">
                            עדכון: ${stats.lastUpdate ? stats.lastUpdate.toLocaleString('he-IL') : 'לא ידוע'}
                        </div>
                    </div>
                    
                    <div>
                        <h6 style="color: var(--primary-color); margin-bottom: 8px;">קטגוריות מובילות:</h6>
                        ${topCategories.map(([cat, count]) => 
                            `<div style="font-size: 0.9em;">• ${cat}: ${count}</div>`
                        ).join('')}
                    </div>
                    
                    <div>
                        <h6 style="color: var(--primary-color); margin-bottom: 8px;">אזורים מובילים:</h6>
                        ${topAreas.map(([area, count]) => 
                            `<div style="font-size: 0.9em;">• ${area}: ${count}</div>`
                        ).join('')}
                    </div>
                </div>
                
                <div style="margin-top: 15px; text-align: center;">
                    <button onclick="refreshJobsFromGit()" class="btn btn-secondary">
                        <i class="fas fa-sync-alt"></i> רענן מהגיט
                    </button>
                </div>
            `;
        }
        
        statusDiv.style.display = 'block';
    }

    function showRecentJobs() {
        const jobs = correctJobsManager.getAllJobs();
        const recentSection = document.getElementById('recent-jobs-section');
        const contentDiv = document.getElementById('recent-jobs-content');
        
        if (!recentSection || !contentDiv) return;
        
        // משרות מהשבוע האחרון
        const oneWeekAgo = new Date();
        oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
        
        const recentJobs = jobs.filter(job => {
            if (!job.createdAt) return false;
            const jobDate = new Date(job.createdAt);
            return jobDate >= oneWeekAgo;
        }).slice(0, 10);

        if (recentJobs.length === 0) {
            contentDiv.innerHTML = '<p>אין משרות חדשות השבוע</p>';
        } else {
            let html = `
                <div style="margin-bottom: 15px;">
                    <strong>${recentJobs.length} משרות חדשות השבוע</strong>
                </div>
                <div style="display: grid; gap: 15px;">
            `;

            recentJobs.forEach(job => {
                const normalized = correctJobsManager.normalizeJob(job);
                html += `
                    <div style="background: rgba(37, 211, 102, 0.1); border: 1px solid rgba(37, 211, 102, 0.3); border-radius: 8px; padding: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <div>
                                <strong style="color: #25D366;">${normalized.title}</strong><br>
                                <small style="color: #666;">${normalized.company}</small>
                            </div>
                            <span style="background: #25D366; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8em;">
                                ${normalized.jobNumber}
                            </span>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.9em;">
                            <div><i class="fas fa-map-marker-alt"></i> ${normalized.region}</div>
                            <div><i class="fas fa-tag"></i> ${normalized.category}</div>
                        </div>
                        <div style="margin-top: 10px;">
                            <button class="btn" onclick="quickSendJob('${normalized.jobNumber}')" style="padding: 5px 10px; font-size: 0.8em;">
                                <i class="fas fa-paper-plane"></i> שלח למנויים
                            </button>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            contentDiv.innerHTML = html;
        }
        
        recentSection.style.display = 'block';
    }

    function quickSendJob(jobNumber) {
        document.getElementById('jobSearchInput').value = jobNumber;
        searchJobAndSend();
    }

    function testGitConnection() {
        correctJobsManager.loadJobs()
            .then(() => {
                adminPanel?.showAlert('חיבור לגיט עובד!', 'success');
            })
            .catch(() => {
                adminPanel?.showAlert('בעיה בחיבור לגיט', 'error');
            });
    }

    // אתחול הפאנל
    let adminPanel;
    document.addEventListener('DOMContentLoaded', function() {
        // המתן קצת לטעינה מלאה
        setTimeout(() => {
            adminPanel = new AdminPanel();
            
            console.log('🚀 פאנל ניהול מנויים הופעל בהצלחה!');
            console.log('🎨 עוצב בגוונים ורודים של האתר "מה יש פה?"');
        }, 1000);
        
        // עדכון אוטומטי כל 30 שניות
        setInterval(() => {
            if (adminPanel) {
                adminPanel.updateStats();
            }
        }, 30000);
    });

    // סגירת מודלים בלחיצה על הרקע
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('preview-modal')) {
            e.target.remove();
        }
    });
    </script>
    // יצירת טופס הוספת מנוי חדש
function createNewSubscriberForm() {
    // טעינת קטגוריות
    const categoriesContainer = document.getElementById('newSubscriberCategories');
    if (categoriesContainer) {
        const categories = adminPanel?.whatsappAlerts?.options?.categories || updatedJobCategories;
        categoriesContainer.innerHTML = '';
        
        categories.forEach(category => {
            const label = document.createElement('label');
            label.style.display = 'block';
            label.style.margin = '5px';
            label.style.cursor = 'pointer';
            label.style.padding = '5px';
            label.style.borderRadius = '5px';
            label.style.transition = 'background-color 0.2s';
            label.style.color = 'white';
            
            label.onmouseover = function() { this.style.backgroundColor = 'rgba(246, 152, 152, 0.1)'; };
            label.onmouseout = function() { this.style.backgroundColor = 'transparent'; };
            
            label.innerHTML = `
                <input type="checkbox" name="newCategories" value="${category}" style="margin-left: 8px;">
                ${category}
            `;
            
            categoriesContainer.appendChild(label);
        });
    }
    
    // טעינת אזורים
    const areasContainer = document.getElementById('newSubscriberAreas');
    if (areasContainer) {
        const areas = adminPanel?.whatsappAlerts?.options?.areas || updatedJobAreas;
        areasContainer.innerHTML = '';
        
        areas.forEach(area => {
            const label = document.createElement('label');
            label.style.display = 'block';
            label.style.margin = '5px';
            label.style.cursor = 'pointer';
            label.style.padding = '5px';
            label.style.borderRadius = '5px';
            label.style.transition = 'background-color 0.2s';
            label.style.color = 'white';
            
            label.onmouseover = function() { this.style.backgroundColor = 'rgba(246, 152, 152, 0.1)'; };
            label.onmouseout = function() { this.style.backgroundColor = 'transparent'; };
            
            label.innerHTML = `
                <input type="checkbox" name="newAreas" value="${area}" style="margin-left: 8px;">
                ${area}
            `;
            
            areasContainer.appendChild(label);
        });
    }
    
    // הגבלת בחירת קטגוריות ואזורים
    limitCheckboxesSelection('newCategories', 3);
    limitCheckboxesSelection('newAreas', 3);
}

// הגבלת בחירת צ'קבוקסים
function limitCheckboxesSelection(name, max) {
    const checkboxes = document.querySelectorAll(`input[name="${name}"]`);
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', () => {
            const checked = document.querySelectorAll(`input[name="${name}"]:checked`);
            if (checked.length >= max) {
                checkboxes.forEach(cb => {
                    if (!cb.checked) cb.disabled = true;
                });
            } else {
                checkboxes.forEach(cb => cb.disabled = false);
            }
        });
    });
}

// הוספת מנוי חדש
function addNewSubscriber() {
    const name = document.getElementById('newSubscriberName').value.trim();
    const phone = document.getElementById('newSubscriberPhone').value.trim();
    const categories = Array.from(document.querySelectorAll('input[name="newCategories"]:checked')).map(cb => cb.value);
    const areas = Array.from(document.querySelectorAll('input[name="newAreas"]:checked')).map(cb => cb.value);
    
    // ולידציה
    if (!name) {
        adminPanel?.showAlert('אנא הכנס שם מלא', 'error');
        return;
    }
    
    if (!phone) {
        adminPanel?.showAlert('אנא הכנס מספר טלפון', 'error');
        return;
    }
    
    if (categories.length === 0) {
        adminPanel?.showAlert('אנא בחר לפחות תחום עניין אחד', 'error');
        return;
    }
    
    if (areas.length === 0) {
        adminPanel?.showAlert('אנא בחר לפחות אזור אחד', 'error');
        return;
    }
    
    // ניקוי מספר טלפון
    let cleanPhone = phone.replace(/[^\d+]/g, '');
    if (cleanPhone.startsWith('0')) {
        cleanPhone = '+972' + cleanPhone.substring(1);
    }
    if (!cleanPhone.startsWith('+')) {
        cleanPhone = '+972' + cleanPhone;
    }
    
    // יצירת אובייקט מנוי חדש
    const newSubscriber = {
        id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
        name: name,
        phone: cleanPhone,
        categories: categories,
        areas: areas,
        registrationDate: new Date().toISOString(),
        active: true,
        source: 'admin_panel'
    };
    
    // בדיקה אם המנוי כבר קיים
    const subscribers = adminPanel?.whatsappAlerts?.getSubscribers() || [];
    const exists = subscribers.some(sub => sub.phone === cleanPhone);
    
    if (exists) {
        if (!confirm(`מנוי עם מספר ${cleanPhone} כבר קיים במערכת. האם לעדכן את הפרטים?`)) {
            return;
        }
        
        // עדכון מנוי קיים
        const index = subscribers.findIndex(sub => sub.phone === cleanPhone);
        if (index !== -1) {
            subscribers[index] = {
                ...subscribers[index],
                name: name,
                categories: categories,
                areas: areas,
                updatedAt: new Date().toISOString()
            };
            
            // שמירת העדכון
            adminPanel.whatsappAlerts.subscribers = subscribers;
            adminPanel.saveSubscribers();
            
            adminPanel?.showAlert(`המנוי ${name} עודכן בהצלחה!`, 'success');
        }
    } else {
        // הוספת מנוי חדש
        adminPanel.whatsappAlerts.addSubscriber(newSubscriber);
        adminPanel?.showAlert(`המנוי ${name} נוסף בהצלחה!`, 'success');
    }
    
    // רענון התצוגה
    adminPanel.renderSubscribers();
    adminPanel.updateStats();
    adminPanel.loadSubscriberSelect();
    
    // ניקוי הטופס
    resetNewSubscriberForm();
}

// ניקוי טופס הוספת מנוי
function resetNewSubscriberForm() {
    document.getElementById('newSubscriberName').value = '';
    document.getElementById('newSubscriberPhone').value = '';
    
    // איפוס תיבות הסימון
    document.querySelectorAll('input[name="newCategories"]').forEach(cb => {
        cb.checked = false;
        cb.disabled = false;
    });
    
    document.querySelectorAll('input[name="newAreas"]').forEach(cb => {
        cb.checked = false;
        cb.disabled = false;
    });
}

// הוספת האירוע ליצירת הטופס בטעינת העמוד
document.addEventListener('DOMContentLoaded', function() {
    // המתן לטעינת המערכת
    setTimeout(() => {
        createNewSubscriberForm();
    }, 1500);
});
</script>
</body>
</html>
